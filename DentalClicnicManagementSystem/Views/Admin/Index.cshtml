@* This is the full, corrected dashboard view that matches your index.html UI *@
@model CMS.ViewModels.DashboardStatsViewModel
@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "_Layout";
}

<body>
   
<div>
    <div class="content pb-0">

        @* <!-- Page Header --> *@
        <div class="d-flex align-items-sm-center justify-content-between flex-wrap gap-2 mb-4">
            <div>
                <h4 class="fw-bold mb-0">Admin Dashboard</h4>
            </div>
            <div class="d-flex align-items-center flex-wrap gap-2">
                <a href="#" class="btn btn-primary d-inline-flex align-items-center"><i class="ti ti-plus me-1"></i>New Appointment</a>
                <a href="#" class="btn btn-outline-white bg-white d-inline-flex align-items-center"><i class="ti ti-calendar-time me-1"></i>Schedule Availability</a>
            </div>
        </div>

        <!-- Top Stat Cards -->
        @* In: Views/AdminDashboard/Index.cshtml *@

        @* <!-- DYNAMIC: Top Stat Cards - This block replaces the old one --> *@
        <div class="row">
            <div class="col-xl-3 col-md-6">
                <div class="position-relative border card rounded-2 shadow-sm">
                    <img src="~/assets/img/bg/bg-01.svg" alt="img" class="position-absolute start-0 top-0">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2 justify-content-between">
                            <span class="avatar bg-primary rounded-circle"><i class="ti ti-user-plus fs-24"></i></span>
                            <div class="text-end">
                                <span class="badge px-2 py-1 fs-12 fw-medium d-inline-flex mb-1 bg-success">+95%</span>
                                <p class="fs-13 mb-0">in last 7 Days</p>
                            </div>
                        </div>
                        <div class="d-flex align-items-center justify-content-between overflow-hidden">
                            <div>
                                <p class="mb-1">Doctors</p>
                                <h3 class="fw-bold mb-0">@Model.DoctorCount</h3>
                            </div>
                            <div>
                                <!-- Correct Chart placeholder from index.html -->
                                <div id="s-col" class="chart-set"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="position-relative border card rounded-2 shadow-sm">
                    <img src="~/assets/img/bg/bg-02.svg" alt="img" class="position-absolute start-0 top-0">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2 justify-content-between">
                            <span class="avatar bg-danger rounded-circle"><i class="ti ti-user-heart fs-24"></i></span>
                            <div class="text-end">
                                <span class="badge px-2 py-1 fs-12 fw-medium d-inline-flex mb-1 bg-success">+25%</span>
                                <p class="fs-13 mb-0">in last 7 Days</p>
                            </div>
                        </div>
                        <div class="d-flex align-items-center justify-content-between overflow-hidden">
                            <div>
                                <p class="mb-1">Patients</p>
                                <h3 class="fw-bold mb-0">@Model.PatientCount</h3>
                            </div>
                            <div>
                                <div id="s-col-2" class="chart-set"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="position-relative border card rounded-2 shadow-sm">
                    <img src="~/assets/img/bg/bg-03.svg" alt="img" class="position-absolute start-0 top-0">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2 justify-content-between">
                            <span class="avatar bg-info rounded-circle"><i class="ti ti-calendar-check fs-24"></i></span>
                            <div class="text-end">
                                <span class="badge px-2 py-1 fs-12 fw-medium d-inline-flex mb-1 bg-danger">-15%</span>
                                <p class="fs-13 mb-0">in last 7 Days</p>
                            </div>
                        </div>
                        <div class="d-flex align-items-center justify-content-between overflow-hidden">
                            <div>
                                <p class="mb-1">Appointment</p>
                                <h3 class="fw-bold mb-0">@Model.AppointmentCount</h3>
                            </div>
                            <div>
                                <div id="s-col-3" class="chart-set"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="position-relative border card rounded-2 shadow-sm">
                    <img src="~/assets/img/bg/bg-04.svg" alt="img" class="position-absolute start-0 top-0">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2 justify-content-between">
                            <span class="avatar bg-success rounded-circle"><i class="ti ti-coin fs-24"></i></span>
                            <div class="text-end">
                                <span class="badge px-2 py-1 fs-12 fw-medium d-inline-flex mb-1 bg-success">+25%</span>
                                <p class="fs-13 mb-0">in last 7 Days</p>
                            </div>
                        </div>
                        <div class="d-flex align-items-center justify-content-between overflow-hidden">
                            <div>
                                <p class="mb-1">Revenue</p>
                                <h3 class="fw-bold mb-0 text-truncate">@Model.Revenue.ToString("C")</h3>
                            </div>
                            <div>
                                <div id="s-col-4" class="chart-set"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="row">
            @* In: Views/AdminDashboard/Index.cshtml *@

           <div class="col-xl-8"> 
                <div class="card shadow-sm flex-fill w-100">
                    <div class="card-header d-flex align-items-center justify-content-between">
                        <h5 class="fw-bold mb-0">Appointment Statistics</h5>
                        @* In: Views/AdminDashboard/Index.cshtml *@

                        @* <!-- Find this dropdown block --> *@
                        <div class="dropdown">
                            <a href="javascript:void(0);" id="statsDropdownButton" class="btn btn-sm px-2 border shadow-sm btn-outline-white d-inline-flex align-items-center" data-bs-toggle="dropdown">
                                Monthly <i class="ti ti-chevron-down ms-1"></i>
                            </a>
                            <ul class="dropdown-menu" id="statsDropdownMenu">
                                <li>
                                    <a class="dropdown-item" href="#" data-range="Monthly">Monthly</a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" data-range="Weekly">Weekly</a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" data-range="Yearly">Yearly</a>
                                </li>
                            </ul>
                        </div>

                    </div>
                        @* In: Views/AdminDashboard/Index.cshtml *@

                        

                    <div class="card-body pb-0">
                        <div class="row row-gap-3 mb-2">
                            <div class="col-md-3 col-sm-6">
                                <div class="bg-light border p-2 text-center rounded-2">
                                    <p class="mb-1 text-body text-truncate"><i class="ti ti-point-filled me-1 text-primary"></i>All Appointments</p>
                                    <h5 class="fw-bold mb-0" id="statsTotalAll">0</h5>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <div class="bg-light border p-2 text-center rounded-2">
                                    <p class="mb-1 text-body"><i class="ti ti-point-filled me-1 text-danger"></i>Cancelled</p>
                                    <h5 class="fw-bold mb-0" id="statsTotalCancelled">0</h5>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <div class="bg-light border p-2 text-center rounded-2">
                                    <p class="mb-1 text-body"><i class="ti ti-point-filled me-1 text-warning"></i>Reschedule</p>
                                    <h5 class="fw-bold mb-0" id="statsTotalRescheduled">0</h5>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <div class="bg-light border p-2 text-center rounded-2">
                                    <p class="mb-1 text-body"><i class="ti ti-point-filled me-1 text-success"></i>Completed</p>
                                    <h5 class="fw-bold mb-0" id="statsTotalCompleted">0</h5>
                                </div>
                            </div>
                        </div>
                        @* <!-- The chart's ID is "s-col-19" from your index.html --> *@
                        <div class="chart-set" id="s-col-19"></div>
                    </div>
                </div>
                    <!-- Find the card with the h5 "Popular Doctors" and replace it with this -->
                    @await Component.InvokeAsync("PopularDoctors")
            </div>

            @* In: Views/AdminDashboard/Index.cshtml *@

            <div class="col-xl-4">
                @await Component.InvokeAsync("AppointmentsCard")
            </div>

        </div>

        @* <!-- All Appointments Table --> *@
        <div class="row">
            <div class="col-12 d-flex">
                <div class="card shadow-sm flex-fill w-100">
                    <div class="card-header d-flex align-items-center justify-content-between">
                        <h5 class="fw-bold mb-0">All Appointments</h5>
                        <a href="#" class="btn fw-normal btn-outline-white">View All</a>
                    </div>
                    <div class="card-body">
                        @await Component.InvokeAsync("AllAppointmentsTable")
                    </div>
                </div>
            </div>
        </div>

        @* <!-- Other sections from your index.html can be added here in the same way --> *@

    </div>
    @* <!-- Footer --> *@
    <div class="footer text-center bg-white p-2 border-top">
        <p class="text-dark mb-0">2025 &copy; <a href="javascript:void(0);" class="link-primary">Preclinic</a>, All Rights Reserved</p>
    </div>
</div>
</body>
@* In: Views/AdminDashboard/Index.cshtml *@

@section Scripts {
    @* <!-- Add Font Awesome for icons --> *@
    
    <script>

   $.ajax({
            url: '@Url.Action("GetDashboardCardChartsData", "Admin")',
            method: 'GET',
            success: function (data) {
                // --- Base options for all sparkline charts ---
                var sparklineOptions = {
                    chart: {
                        type: 'line',
                        height: 50,
                        sparkline: { enabled: true }
                    },
                    stroke: { width: 2 },
                    tooltip: { enabled: false }
                };

                // --- Doctors Chart (Bar) ---
                var doctorsChartOptions = {
                    ...sparklineOptions,
                    chart: { ...sparklineOptions.chart, type: 'bar' },
                    colors: ['#0d6efd'], // Blue color for the doctor chart
                    plotOptions: {
                        bar: {
                            columnWidth: '30%',  // Tight columns with 30% width
                            groupPadding: 0 , // Reduce any padding between bars
                            borderRadiusTopLeft: 6,  // Rounded top left corner
                            borderRadiusTopRight: 6, // Rounded top right corner
                            borderRadiusBottomLeft: 0, // No rounding on bottom left
                            borderRadiusBottomRight: 0 // No rounding on bottom right
                        }
                    }
                };
                doctorsChartOptions.series = [{ name: 'Doctors', data: data.doctorsData }];
                new ApexCharts(document.querySelector("#s-col"), doctorsChartOptions).render();

                // --- Patients Chart (Line) ---
                var patientsChartOptions = {
                    ...sparklineOptions,
                    colors: ['#dc3545'], // Red color for the patients chart
                    dropShadow: {
                        enabled: true,
                        top: 3,
                        left: 0,
                        blur: 3,
                        opacity: 0.5
                    }
                };
                patientsChartOptions.series = [{ name: 'Patients', data: data.patientsData }];
                new ApexCharts(document.querySelector("#s-col-2"), patientsChartOptions).render();

                // --- Appointments Chart (Bar) ---
                var appointmentsChartOptions = {
                    ...sparklineOptions,
                    chart: { ...sparklineOptions.chart, type: 'bar' },
                    colors: ['#0dcaf0'], // Light blue color for the appointments chart
                    plotOptions: {
                        bar: {
                            columnWidth: '30%', // Tight columns with 30% width
                            barPadding: 0,  // Reduce padding between bars
                            borderRadiusTopLeft: 6,  // Rounded top left corner
                            borderRadiusTopRight: 6, // Rounded top right corner
                            borderRadiusBottomLeft: 0, // No rounding on bottom left
                            borderRadiusBottomRight: 0 // No rounding on bottom right
                        }
                    },
                    dataLabels: { enabled: false }
                };
                appointmentsChartOptions.series = [{ name: 'Appointments', data: data.appointmentsData }];
                new ApexCharts(document.querySelector("#s-col-3"), appointmentsChartOptions).render();

                // --- Revenue Chart (Line) ---
                var revenueChartOptions = {
                    ...sparklineOptions,
                    colors: ['#198754'], // Green color for revenue chart
                    dropShadow: {
                        enabled: true,
                        top: 3,
                        left: 0,
                        blur: 3,
                        opacity: 0.5
                    }
                };
                revenueChartOptions.series = [{ name: 'Revenue', data: data.revenueData }];
                new ApexCharts(document.querySelector("#s-col-4"), revenueChartOptions).render();
            }
        });


                           @* In: Views/AdminDashboard/Index.cshtml, inside @section Scripts *@

        // This AJAX call should replace the existing one for the card charts.
        // $.ajax({
        //     url: '@Url.Action("GetDashboardCardChartsData", "Admin")',
        //     method: 'GET',
        //     success: function (data) {
        //         --- Base options for all sparkline charts ---
        //         var sparklineOptions = {
        //             chart: {
        //                 type: 'line',
        //                 height: 50,
        //                 sparkline: { enabled: true }
        //             },
        //             stroke: { width: 2 },
        //             tooltip: { enabled: false }
        //         };

        //         --- Doctors Chart (Bar) ---
        //         var doctorsChartOptions = {
        //             ...sparklineOptions,
        //             chart: { ...sparklineOptions.chart, type: 'bar' },
        //             colors: ['#0d6efd'],
        //             plotOptions: {
        //                 bar: {
        //                     FIX 1: Use a more reasonable width to reduce gaps.
        //                     columnWidth: '60%',
        //                     FIX 2: Add rounded corners for a modern, sleek look.
        //                     borderRadius: 4
        //                 }
        //             }
        //         };
        //         doctorsChartOptions.series = [{ name: 'Doctors', data: data.doctorsData }];
        //         new ApexCharts(document.querySelector("#s-col"), doctorsChartOptions).render();

        //         --- Patients Chart (Line) ---
        //         var patientsChartOptions = {
        //             ...sparklineOptions,
        //             colors: ['#dc3545'],
        //             dropShadow: {
        //                 enabled: true,
        //                 top: 3,
        //                 left: 0,
        //                 blur: 3,
        //                 opacity: 0.5
        //             }
        //         };
        //         patientsChartOptions.series = [{ name: 'Patients', data: data.patientsData }];
        //         new ApexCharts(document.querySelector("#s-col-2"), patientsChartOptions).render();

        //         --- Appointments Chart (Bar) ---
        //         var appointmentsChartOptions = {
        //             ...sparklineOptions,
        //             chart: { ...sparklineOptions.chart, type: 'bar' },
        //             colors: ['#0dcaf0'],
        //             plotOptions: {
        //                 bar: {
        //                     FIX 1: Use a more reasonable width to reduce gaps.
        //                     columnWidth: '60%',
        //                     FIX 2: Add rounded corners for a modern, sleek look.
        //                     borderRadius: 4
        //                 }
        //             }
        //         };
        //         appointmentsChartOptions.series = [{ name: 'Appointments', data: data.appointmentsData }];
        //         new ApexCharts(document.querySelector("#s-col-3"), appointmentsChartOptions).render();

        //         --- Revenue Chart (Line) ---
        //         var revenueChartOptions = {
        //             ...sparklineOptions,
        //             colors: ['#198754'],
        //             dropShadow: {
        //                 enabled: true,
        //                 top: 3,
        //                 left: 0,
        //                 blur: 3,
        //                 opacity: 0.5
        //             }
        //         };
        //         revenueChartOptions.series = [{ name: 'Revenue', data: data.revenueData }];
        //         new ApexCharts(document.querySelector("#s-col-4"), revenueChartOptions).render();
        //     }
        // });




        $(function () {
            // Declare the chart variable in a broader scope
            var appointmentChart = null;

            // Function to load or update chart data
            function loadChartData(range) {
                $.ajax({
                    url: '@Url.Action("GetAppointmentStatistics", "Admin")',
                    method: 'GET',
                    data: { range: range }, // Send the selected range to the server
                    success: function (data) {
                        // Update the 4 stat boxes
                        $('#statsTotalAll').text(data.totalAll);
                        $('#statsTotalCancelled').text(data.totalCancelled);
                        $('#statsTotalRescheduled').text(data.totalRescheduled);
                        $('#statsTotalCompleted').text(data.totalCompleted);

                        var options = {
                            series: [{
                                name: 'Completed',
                                data: data.completedData
                            }, {
                                name: 'Ongoing',
                                data: data.ongoingData
                            }, {
                                name: 'Rescheduled',
                                data: data.rescheduledData
                            }],
                            chart: { type: 'bar', height: 350, stacked: true, toolbar: { show: false } },
                            plotOptions: { bar: { horizontal: false, columnWidth: '55%' } },
                            xaxis: { categories: data.labels },
                            fill: { opacity: 1 },
                            colors: ['#28a745', '#007bff', '#6f42c1']
                        };

                        // If chart doesn't exist, create it. Otherwise, update it.
                        if (appointmentChart === null) {
                            appointmentChart = new ApexCharts(document.querySelector("#s-col-19"), options);
                            appointmentChart.render();
                        } else {
                            appointmentChart.updateOptions(options);
                        }
                    },
                    error: function(err) {
                        console.error("Failed to load chart data:", err);
                        $("#s-col-19").html("<div class='text-center text-danger p-5'>Could not load chart data. Please check the console for errors.</div>");
                    }
                });
            }

            // --- Event Listener for the Dropdown ---
            $('#statsDropdownMenu a').on('click', function (e) {
                e.preventDefault(); // Prevent the link from navigating

                var selectedRange = $(this).data('range');
                var buttonText = $(this).text();

                // Update the button text
                $('#statsDropdownButton').html(buttonText + ' <i class="ti ti-chevron-down ms-1"></i>');

                // Load new data for the chart
                loadChartData(selectedRange);
            });

            // --- Initial Load ---
            // Load the chart with the default range ('Monthly') when the page loads
            loadChartData('Monthly');

        });





        // --- Appointments Card Calendar and AJAX ---
                // --- Appointments Card Calendar and AJAX ---
                      // --- Appointments Card Calendar and AJAX ---
                    // --- Appointments Card Calendar and AJAX ---
               // --- Appointments Card Calendar and AJAX ---
        if ($('.datepic').length > 0) {
            $('.datepic').datetimepicker({
                format: 'DD-MM-YYYY',
                inline: true,
                toolbarPlacement: 'top' // This is the only option needed now
            });

            // Listen for a date change event
            $('.datepic').on('dp.change', function (e) {
                // Get the selected date from the event
                var selectedDate = e.date.format('YYYY-MM-DD');

                // Make an AJAX call to get the updated appointment list
                $.ajax({
                    url: '@Url.Action("GetAppointmentsForDate", "Admin")',
                    method: 'GET',
                    data: { date: selectedDate },
                    success: function (response) {
                        // Replace the content of the list with the new partial view
                        $('#appointment-list-for-day').html(response);
                    },
                    error: function () {
                        $('#appointment-list-for-day').html('<p class="text-danger">Could not load appointments.</p>');
                    }
                });
            });
        }







                @* In: Views/AdminDashboard/Index.cshtml, inside @section Scripts *@

        // --- Popular Doctors Dropdown AJAX ---
        $('#popular-doctors-dropdown-menu').on('click', 'a', function (e) {
            e.preventDefault();
            var range = $(this).data('range');
            var text = $(this).text();

            // Update button text
            $('#popular-doctors-dropdown-btn').html(text + ' <i class="ti ti-chevron-down ms-1"></i>');

            // Fetch new data
            $.ajax({
                url: '@Url.Action("GetPopularDoctors", "Admin")',
                type: 'GET',
                data: { range: range },
                success: function (response) {
                    $('#popular-doctors-list').html(response);
                },
                error: function () {
                    $('#popular-doctors-list').html('<p class="text-danger">Could not load doctors.</p>');
                }
            });
        });

    </script>
}
