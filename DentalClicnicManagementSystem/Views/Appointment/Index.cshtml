@{
    ViewData["Title"] = "Appointments";
}
<form id="__af" method="post" style="display:none">
    @Html.AntiForgeryToken()
</form>

<div class="main-wrapper">
    <div class="page-wrapper m-0">
        <div class="content">

            <!-- Header -->
            <div class="d-flex align-items-sm-center flex-sm-row flex-column gap-2 mb-3">
                <div class="flex-grow-1">
                    <h4 class="fw-bold mb-0">Appointment Grid</h4>
                </div>
                <div class="text-end">
                    <a asp-controller="Appointment" asp-action="Upsert" class="btn btn-primary ms-2 fs-13 btn-md">
                        <i class="ti ti-plus me-1"></i>New Appointment
                    </a>
                </div>
            </div>

            <!-- Card -->
            <div class="card">
                <div class="card-body">

                    <!-- External controls -->
                    <div class="row g-2 mb-3 align-items-center">
                        <!-- page-length: hidden on mobile -->
                        <div class="col-auto d-none d-sm-flex align-items-center">
                            <label class="me-2 mb-0">Show</label>
                            <select id="pageLength" class="form-select form-select-sm" style="min-width:90px">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span class="ms-2">entries</span>
                        </div>

                        <!-- search: full width on mobile -->
                        <div class="col-12 col-sm ms-sm-auto" style="max-width:260px">
                            <input id="globalSearch" type="search" class="form-control form-control-sm" placeholder="Search" />
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table id="Appointment" class="table table-hover align-middle ">
                            <thead class="table-light">
                                <tr>
                                    <th>Patient</th>            <!-- index 0 -->
                                    <th>Doctor</th>             <!-- index 1 -->
                                    <th>Appointment Date</th>   <!-- index 2 -->
                                    <th>Created On</th>         <!-- index 3 -->
                                    <th>Mode</th>               <!-- index 4 -->
                                    <th>Status</th>             <!-- index 5 -->
                                    <th class="text-center">Actions</th> <!-- index 6 -->
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <!-- Footer: info + pager -->
                    <div class="row align-items-center g-2 mt-2">
                        <div class="col-12 col-sm-6">
                            <div class="small text-muted" id="dt-info"></div>
                        </div>
                        <div class="col-12 col-sm-6 d-flex justify-content-sm-end">
                            <div id="dt-pager"></div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>


<!-- Appointment Modal -->
<div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>
</div>

<style>
    /* ===== Truncation helpers ===== */
    .truncate {
        display: inline-block;
        vertical-align: middle;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .truncate-180 {
        max-width: 180px;
    }

    .truncate-220 {
        max-width: 220px;
    }

    .truncate-260 {
        max-width: 260px;
    }

    /* Compact, stable headers */
    #Appointment thead th {
        white-space: nowrap;
    }

    .table tbody td {
        vertical-align: middle;
    }

    /* Mobile tweaks */
    @@media (max-width:576px) {
        #Appointment td, #Appointment th {
            font-size: .92rem;
        }

        .avatar img {
            width: 36px !important;
            height: 36px !important;
        }
    }

    /* Hide built-in DT controls (we use our own) */
    .dataTables_length, .dataTables_filter {
        display: none !important;
    }

    /* Pager cosmetics (Bootstrap 5 renderer) */
    #dt-pager .pagination {
        margin: 0;
        gap: .25rem;
        flex-wrap: wrap;
    }

    #dt-pager .page-item .page-link {
        border-radius: .6rem;
        padding: .4rem .65rem;
        line-height: 1;
        border-color: var(--bs-gray-300);
    }

        #dt-pager .page-item .page-link:focus {
            box-shadow: none;
        }

    #dt-pager .page-item.active .page-link {
        background: var(--primary);
        border-color: var(--primary);
        color: #fff;
        box-shadow: 0 0 0 .15rem rgba(var(--bs-primary-rgb,13,110,253), .15);
    }

    #dt-pager .page-item.disabled .page-link {
        opacity: .6;
    }
    #Appointment th,
    #Appointment td {
        white-space: nowrap; /* Prevent wrapping */
    }
    /* Ensure table always scrolls horizontally if needed */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* Smooth scroll for iOS */
    }

    /* Prevent cells from shrinking */
    #Appointment td,
    #Appointment th {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 100px; /* Adjust minimum width per column if needed */
    }

        /* Keep flex elements inside cells from shrinking */
        #Appointment td > div.d-flex,
        #Appointment td > div.d-flex > div {
            flex-shrink: 0;
            min-width: 0;
        }

    .table-responsive {
        overflow-x: auto; /* Allow horizontal scroll if table exceeds viewport */
    }
    /* Ensure all table cells never wrap */
    #Appointment td, #Appointment th {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

        /* For flex containers inside cells (patient/doctor info) */
        #Appointment td > div.d-flex,
        #Appointment td > div.d-flex > div {
            flex-shrink: 0; /* Prevent shrinking */
            min-width: 0; /* Ensure text-overflow works */
        }

    /* Horizontal scroll on small screens */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* smooth scroll on iOS */
    }


</style>

@section Scripts {
  

    <script>
        $(function () {
            const token = $('#__af input[name="__RequestVerificationToken"]').val();

            // Tear down if already bound
            if ($.fn.DataTable.isDataTable('#Appointment')) {
                $('#Appointment').DataTable().destroy();
            }

            const esc = (s) => (s == null ? '' : String(s));

                const table = $('#Appointment').DataTable({
        processing: true,
        serverSide: true,
        ajax: { url: '@Url.Action("GetAll", "Appointment")', type: 'GET' },
        dom: 'rtip',
        paging: true,
        pagingType: 'simple_numbers',
        info: true,
        order: [[3, 'desc']],
        scrollX: true,       // horizontal scroll
        scrollCollapse: true, // collapse scroll if table smaller than container
        autoWidth: false,
        responsive: false,   // disable responsive hiding, we handle scroll manually
        columnDefs: [
            { targets: '_all', className: 'text-nowrap' },
            { targets: 0, responsivePriority: 1 },
            { targets: 5, responsivePriority: 2, className: 'text-center' },
            { targets: [2,3], responsivePriority: 3 },
            { targets: [1,4], responsivePriority: 4 }
        ],

                columnDefs: [
                    { targets: '_all', className: 'text-nowrap' },
                    { targets: 0, responsivePriority: 1 },
                    { targets: 5, responsivePriority: 2, className: 'text-center' },
                    { targets: [2,3], responsivePriority: 3 },
                    { targets: [1,4], responsivePriority: 4 }
                        ],columns: [
            /* 0 Patient */
            {
                data: null,
                orderable: true,
                render: (data, type, row) => `
                  <div class="d-flex align-items-center">
                    <img src="${row.patientImg || '/uploads/doctors/patient_default.jpg'}"
                         class="rounded-circle me-2" width="36" height="36">
                    <div>
                      <div class="fw-semibold">${row.patientName}</div>
                      <small class="text-muted">${row.patientGender || ''}</small>
                    </div>
                  </div>`
            },
            /* 1 Doctor */
            {
                data: null,
                orderable: true,
                render: (data, type, row) => `
                  <div class="d-flex align-items-center">
                    <img src="${row.doctorImg || '/uploads/doctors/default.jpg'}"
                         class="rounded-circle me-2" width="36" height="36">
                    <div>
                      <div class="fw-semibold">${row.doctorName}</div>
                      <small class="text-muted">${row.doctorSpecialty || ''}</small>
                    </div>
                  </div>`
            },
            /* 2 Appointment Date */
            {
                data: 'appointmentDate',
                orderable: true,
                render: d => new Date(d).toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' })
            },
            /* 3 Created On */
            {
                data: 'appCreatedOn',
                orderable: true,
                render: d => new Date(d).toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' })
            },
            /* 4 Mode (AppointmentType) */
            { data: 'type',  orderable: false },
            /* 5 Status */
            { data: 'status', orderable: false },
            /* 6 Actions */
            {
                data: null,
                orderable: false,
                className: 'text-center',
                            render: (_d, _t, row) => `
        <div class="dropdown d-inline-block position-static">
          <button class="btn btn-sm btn-icon" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="ti ti-dots-vertical"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow" style="z-index: 1050;">
            <li>
              <a href="/Appointment/Upsert/${row.id}" class="dropdown-item">
                <i class="ti ti-edit me-1"></i>Edit
              </a>
            </li>
            <li>
              <a href="javascript:void(0)" class="dropdown-item js-delete delete-btn-appointment"
                 data-id="${row.id}"
                 data-name="${row.patientName}"
                 data-url="/Appointment/Delete"
                 data-table="Appointment">
                <i class="ti ti-trash me-1"></i>Delete
              </a>
            </li>
          </ul>
        </div>`


            }
        ],

            
                // Move pager; write our own info string so it always shows
                drawCallback: function () {
                    const api = this.api();

                    // move DT pager to our container
                    const pagerEl = $(api.table().container()).find('.dataTables_paginate');
                    if (pagerEl.length) $('#dt-pager').empty().append(pagerEl);

                    // replace Prev/Next labels with chevrons (safer here after render)
                    $('#dt-pager .paginate_button.previous .page-link').html('&lsaquo;');
                    $('#dt-pager .paginate_button.next .page-link').html('&rsaquo;');

                    // robust info text
                    const info = api.page.info(); // {start,end,recordsTotal,recordsDisplay,...}
                    const msg = info.recordsDisplay
                      ? `Showing ${info.start + 1} to ${info.end} of ${info.recordsDisplay.toLocaleString()} entries`
                      : (info.recordsTotal
                          ? `Showing 0 to 0 of ${info.recordsTotal.toLocaleString()} entries`
                          : 'No entries to show');
                    $('#dt-info').text(msg);
                },

                language: {
                    emptyTable: "No doctors found",
                    processing: "Loading..."
                }
            });

            // External controls
            $('#globalSearch').on('input', function () {
                table.search(this.value).draw();
            });
            $('#pageLength').on('change', function () {
                table.page.len(parseInt(this.value, 10)).draw();
            });

            // Delete with Swal -> reload current page
            // $(document).on('click', '.js-delete', function () {
            //     const id = $(this).data('id');
            //     const name = $(this).data('name');

            //     Swal.fire({
            //         title: `Delete ${name}?`,
            //         text: 'You will not be able to revert this!',
            //         icon: 'warning',
            //         showCancelButton: true,
            //         confirmButtonColor: '#d33',
            //         cancelButtonColor: '#aaa',
            //         confirmButtonText: 'Yes, delete!'
            //     }).then(res => {
            //         if (res.isConfirmed) {
            //             $.ajax({
            //                 url: `/Doctor/Delete/${id}`,
            //                 type: 'POST',
            //                 headers: { 'RequestVerificationToken': token },
            //                 success: r => {
            //                     if (r.status) {
            //                         Swal.fire('Deleted', r.message, 'success');
            //                         table.ajax.reload(null, false);
            //                     } else {
            //                         Swal.fire('Error', r.message || 'Delete failed', 'error');
            //                     }
            //                 },
            //                 error: () => Swal.fire('Error', 'Something went wrong', 'error')
            //             });
            //         }
            //     });
            // });      
        });





        // Handle form submit inside modal
        $(document).on("submit", "#appointmentForm", function (e) {
            e.preventDefault();

            $.ajax({
                url: $(this).attr("action"),
                type: "POST",
                data: $(this).serialize(),
                success: function (response) {
                    if (response.success) {
                        $("#appointmentModal").modal("hide");
                        $("#appointmentsTable").DataTable().ajax.reload(null, false); // reload without resetting paging
                    } else {
                        // Reload form with validation errors
                        $("#appointmentModal .modal-content").html(response);
                    }
                }
            });
        });



       

    </script>
}
