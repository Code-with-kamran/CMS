@* @{
    ViewData["Title"] = "Appointment Vitals Management";
}
<form id="__af" method="post" style="display:none">@Html.AntiForgeryToken()</form>

<div class="content">
    <!-- Header -->
    <div class="d-flex align-items-sm-center flex-sm-row flex-column gap-2 mb-3">
        <div class="flex-grow-1">
            <h4 class="fw-bold mb-0"><i class="ti ti-heart-rate-monitor text-primary me-2"></i>Patient Vitals Management</h4>
            <p class="text-muted mb-0">Add and manage vital signs for today's appointments</p>
        </div>
        <div class="text-end">
            <span class="badge bg-info-light text-info px-3 py-2">
                <i class="ti ti-calendar me-1"></i>Today's Appointments
            </span>
        </div>
    </div>

    <!-- Appointments Card -->
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <!-- Controls -->
            <div class="row g-2 mb-3 align-items-center">
                <div class="col-auto d-none d-sm-flex align-items-center">
                    <label class="me-2 mb-0">Show</label>
                    <select id="pageLength" class="form-select form-select-sm" style="min-width:90px">
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                    </select>
                    <span class="ms-2">entries</span>
                </div>
                <div class="col-12 col-sm ms-sm-auto" style="max-width:260px">
                    <input id="globalSearch" type="search" class="form-control form-control-sm" placeholder="Search patient or appointment..." />
                </div>
            </div>

            <!-- Table -->
            <div class="table-responsive">
                <table id="appointmentList" class="table table-hover align-middle w-100">
                    <thead class="table-light">
                        <tr>
                            <th>Appointment #</th>
                            <th>Patient Name</th>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Vitals Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Footer -->
            <div class="row align-items-center g-2 mt-2">
                <div class="col-12 col-sm-6">
                    <div class="small text-muted" id="dt-info"></div>
                </div>
                <div class="col-12 col-sm-6 d-flex justify-content-sm-end">
                    <div id="dt-pager"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vitals Modal -->
<div class="modal fade" id="vitalsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="ti ti-heart-rate-monitor me-2"></i>Patient Vital Signs
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modal-content-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Loading patient information...</p>
                </div>

                <div id="modal-content-form" style="display: none;">
                    <!-- Patient Info Header -->
                    <div class="bg-light rounded p-3 mb-4">
                        <div class="row align-items-center">
                            <div class="col">
                                <h6 class="mb-1" id="modal-patient-name">Patient Name</h6>
                                <small class="text-muted" id="modal-appointment-info">Appointment Info</small>
                            </div>
                            <div class="col-auto">
                                <span class="badge bg-primary-light text-primary px-3 py-2">
                                    <i class="ti ti-calendar me-1"></i>
                                    <span id="modal-appointment-time">Time</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Vitals Form -->
                    <form id="vitalsForm">
                        <input type="hidden" id="appointmentId" name="appointmentId" />

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="bloodPressure" class="form-label">
                                    <i class="ti ti-activity text-danger me-1"></i>Blood Pressure
                                </label>
                                <input type="text" class="form-control" id="bloodPressure" name="bloodPressure"
                                       placeholder="120/80" pattern="[0-9]+/[0-9]+" title="Format: 120/80">
                                <div class="form-text">Format: Systolic/Diastolic (e.g., 120/80)</div>
                            </div>

                            <div class="col-md-6">
                                <label for="heartRate" class="form-label">
                                    <i class="ti ti-heart text-danger me-1"></i>Heart Rate (bpm)
                                </label>
                                <input type="number" class="form-control" id="heartRate" name="heartRate"
                                       placeholder="72" min="40" max="200">
                            </div>

                            <div class="col-md-6">
                                <label for="spo2" class="form-label">
                                    <i class="ti ti-lungs text-info me-1"></i>SpO2 (%)
                                </label>
                                <input type="number" class="form-control" id="spo2" name="spo2"
                                       placeholder="98" min="70" max="100">
                            </div>

                            <div class="col-md-6">
                                <label for="temperature" class="form-label">
                                    <i class="ti ti-temperature text-warning me-1"></i>Temperature (°F)
                                </label>
                                <input type="number" class="form-control" id="temperature" name="temperature"
                                       placeholder="98.6" step="0.1" min="95" max="110">
                            </div>

                            <div class="col-md-6">
                                <label for="respiratoryRate" class="form-label">
                                    <i class="ti ti-wind text-primary me-1"></i>Respiratory Rate (/min)
                                </label>
                                <input type="number" class="form-control" id="respiratoryRate" name="respiratoryRate"
                                       placeholder="16" min="8" max="40">
                            </div>

                            <div class="col-md-6">
                                <label for="weight" class="form-label">
                                    <i class="ti ti-scale text-success me-1"></i>Weight (kg)
                                </label>
                                <input type="number" class="form-control" id="weight" name="weight"
                                       placeholder="70" step="0.1" min="1" max="500">
                            </div>
                        </div>

                        <div class="mt-4 p-3 bg-light rounded">
                            <h6 class="text-muted mb-2">
                                <i class="ti ti-info-circle me-1"></i>Normal Ranges Reference
                            </h6>
                            <div class="row small text-muted">
                                <div class="col-md-4">• Blood Pressure: 90/60 - 120/80</div>
                                <div class="col-md-4">• Heart Rate: 60-100 bpm</div>
                                <div class="col-md-4">• SpO2: 95-100%</div>
                                <div class="col-md-4">• Temperature: 97-99°F</div>
                                <div class="col-md-4">• Resp Rate: 12-20/min</div>
                                <div class="col-md-4">• Weight: Individual</div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ti ti-x me-1"></i>Cancel
                </button>
                <button type="button" id="saveVitalsBtn" class="btn btn-primary" style="display: none;">
                    <span class="spinner-border spinner-border-sm me-2" id="save-spinner" style="display: none;"></span>
                    <i class="ti ti-device-floppy me-1"></i>Save Vitals
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-primary-light {
        background-color: rgba(13, 110, 253, 0.1) !important;
    }

    .bg-info-light {
        background-color: rgba(13, 202, 240, 0.1) !important;
    }

    .bg-success-light {
        background-color: rgba(25, 135, 84, 0.1) !important;
    }

    .bg-warning-light {
        background-color: rgba(255, 193, 7, 0.1) !important;
    }

    .bg-danger-light {
        background-color: rgba(220, 53, 69, 0.1) !important;
    }

    .vitals-status-added {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
    }

    .vitals-status-pending {
        background: linear-gradient(45deg, #ffc107, #fd7e14);
        color: white;
    }
</style>

@section Scripts {
    <script>
        $(function () {
            const token = $('#__af input[name="__RequestVerificationToken"]').val();
            const vitalsModal = new bootstrap.Modal(document.getElementById('vitalsModal'));

            const table = $('#appointmentList').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: '@Url.Action("GetNurseAppointmentList")',
                    type: 'GET'
                },
                dom: 'rtip',
                paging: true,
                pagingType: 'simple_numbers',
                info: true,
                order: [[2, 'asc']], // Sort by time
                columns: [
                    { data: 'appointmentNo', name: 'AppointmentNo' },
                    { data: 'patientName', name: 'PatientName' },
                    {
                        data: 'appointmentTime',
                        name: 'AppointmentTime',
                        render: d => new Date(d).toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        })
                    },
                    { data: 'appointmentType', name: 'AppointmentType' },
                    {
                        data: 'status',
                        name: 'Status',
                        orderable: false,
                        render: data => {
                            const colorClass = data === 'Scheduled' ? 'warning' :
                                             data === 'InProgress' ? 'info' : 'success';
                            return `<span class="badge bg-${colorClass}-light text-${colorClass}">${data}</span>`;
                        }
                    },
                    {
                        data: 'hasVitals',
                        name: 'HasVitals',
                        orderable: false,
                        render: (hasVitals, type, row) => {
                            if (hasVitals) {
                                return `<span class="badge vitals-status-added">
                                          <i class="ti ti-check me-1"></i>Vitals Added
                                        </span>`;
                            } else {
                                return `<span class="badge vitals-status-pending">
                                          <i class="ti ti-clock me-1"></i>Pending
                                        </span>`;
                            }
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        className: 'text-center',
                        render: (data, type, row) => {
                            const buttonText = row.hasVitals ? 'Edit Vitals' : 'Add Vitals';
                            const buttonClass = row.hasVitals ? 'btn-outline-primary' : 'btn-primary';
                            const icon = row.hasVitals ? 'ti-edit' : 'ti-plus';

                            return `<button class="btn ${buttonClass} btn-sm add-vitals-btn"
                                            data-appointment-id="${row.appointmentId}">
                                      <i class="ti ${icon} me-1"></i>${buttonText}
                                    </button>`;
                        }
                    }
                ],
                drawCallback: function() {
                    const api = this.api();
                    const pagerEl = $(api.table().container()).find('.dataTables_paginate');
                    if (pagerEl.length) $('#dt-pager').empty().append(pagerEl);

                    $('#dt-pager .paginate_button.previous .page-link').html('&lsaquo;');
                    $('#dt-pager .paginate_button.next .page-link').html('&rsaquo;');

                    const info = api.page.info();
                    const msg = info.recordsDisplay
                        ? `Showing ${info.start + 1} to ${info.end} of ${info.recordsDisplay.toLocaleString()} appointments`
                        : 'No appointments found';
                    $('#dt-info').text(msg);
                },
                language: { emptyTable: "No appointments for today", processing: "Loading appointments..." }
            });

            // Event handlers
            $('#globalSearch').on('input', () => table.search($('#globalSearch').val()).draw());
            $('#pageLength').on('change', function () {
                table.page.len(parseInt(this.value, 10)).draw();
            });

            // Open vitals modal
            $('#appointmentList').on('click', '.add-vitals-btn', function() {
                const appointmentId = $(this).data('appointment-id');
                loadVitalsModal(appointmentId);
            });

            function loadVitalsModal(appointmentId) {
                $('#modal-content-loading').show();
                $('#modal-content-form').hide();
                $('#saveVitalsBtn').hide();
                vitalsModal.show();

                $.ajax({
                    url: `/Appointment/GetAppointmentVitals?appointmentId=${appointmentId}`,
                    type: 'GET',
                    success: function(data) {
                        // Populate modal with data
                        $('#modal-patient-name').text(data.patientName);
                        $('#modal-appointment-time').text(data.appointmentTime);
                        $('#appointmentId').val(data.appointmentId);

                        // Populate vitals form
                        const vitals = data.vitals;
                        $('#bloodPressure').val(vitals.bloodPressure || '');
                        $('#heartRate').val(vitals.heartRate || '');
                        $('#spo2').val(vitals.spo2 || '');
                        $('#temperature').val(vitals.temperature || '');
                        $('#respiratoryRate').val(vitals.respiratoryRate || '');
                        $('#weight').val(vitals.weight || '');

                        $('#modal-content-loading').hide();
                        $('#modal-content-form').show();
                        $('#saveVitalsBtn').show();
                    },
                    error: function() {
                        $('#modal-content-loading').html('<div class="alert alert-danger">Failed to load appointment data</div>');
                    }
                });
            }

            // Save vitals
            $('#saveVitalsBtn').on('click', function() {
                const btn = $(this);
                const spinner = $('#save-spinner');

                // Validation
                const appointmentId = $('#appointmentId').val();
                if (!appointmentId) {
                    alert('Invalid appointment ID');
                    return;
                }

                // Get form data
                const vitalsData = {
                    AppointmentId: parseInt(appointmentId),
                    BloodPressure: $('#bloodPressure').val() || null,
                    HeartRate: $('#heartRate').val() || null,
                    Spo2: $('#spo2').val() || null,
                    Temperature: $('#temperature').val() || null,
                    RespiratoryRate: $('#respiratoryRate').val() || null,
                    Weight: $('#weight').val() || null
                };

                // Check if at least one vital is filled
                const hasData = Object.values(vitalsData).some(value => value !== null && value !== '');
                if (!hasData) {
                    alert('Please enter at least one vital sign measurement');
                    return;
                }

                btn.prop('disabled', true);
                spinner.show();

                $.ajax({
                    url: '/Appointment/UpdateVitals',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: { 'RequestVerificationToken': token },
                    data: JSON.stringify(vitalsData),
                    success: function(response) {
                        if (response.success) {
                            vitalsModal.hide();
                            table.ajax.reload(null, false); // Refresh table

                            // Success notification
                            const toast = $(`<div class="toast position-fixed top-0 end-0 m-3" style="z-index: 9999;">
                                <div class="toast-header bg-success text-white">
                                    <i class="ti ti-check me-2"></i>
                                    <strong class="me-auto">Success</strong>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                                </div>
                                <div class="toast-body">${response.message}</div>
                            </div>`);

                            $('body').append(toast);
                            const bsToast = new bootstrap.Toast(toast[0]);
                            bsToast.show();

                            toast.on('hidden.bs.toast', () => toast.remove());
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(e) {
                        alert('An error occurred while saving vitals',e);
                    },
                    complete: function() {
                        btn.prop('disabled', false);
                        spinner.hide();
                    }
                });
            });
        });
    </script>
} *@


@{
    ViewData["Title"] = "Gestion des Signes Vitaux des Rendez-vous";
}
<form id="__af" method="post" style="display:none">@Html.AntiForgeryToken()</form>

<div class="content">
    <!-- En-tête -->
    <div class="d-flex align-items-sm-center flex-sm-row flex-column gap-2 mb-3">
        <div class="flex-grow-1">
            <h4 class="fw-bold mb-0"><i class="ti ti-heart-rate-monitor text-primary me-2"></i>Gestion des Signes Vitaux des Patients</h4>
            <p class="text-muted mb-0">Ajouter et gérer les signes vitaux pour les rendez-vous d'aujourd'hui</p>
        </div>
        <div class="text-end">
            <span class="badge bg-info-light text-info px-3 py-2">
                <i class="ti ti-calendar me-1"></i>Rendez-vous du Jour
            </span>
        </div>
    </div>

    <!-- Carte des Rendez-vous -->
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <!-- Contrôles -->
            <div class="row g-2 mb-3 align-items-center">
                <div class="col-auto d-none d-sm-flex align-items-center">
                    <label class="me-2 mb-0">Afficher</label>
                    <select id="pageLength" class="form-select form-select-sm" style="min-width:90px">
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                    </select>
                    <span class="ms-2">entrées</span>
                </div>
                <div class="col-12 col-sm ms-sm-auto" style="max-width:260px">
                    <input id="globalSearch" type="search" class="form-control form-control-sm" placeholder="Rechercher patient ou rendez-vous..." />
                </div>
            </div>

            <!-- Tableau -->
            <div class="table-responsive">
                <table id="appointmentList" class="table table-hover align-middle w-100">
                    <thead class="table-light">
                        <tr>
                            <th>Rendez-vous #</th>
                            <th>Nom du Patient</th>
                            <th>Heure</th>
                            <th>Type</th>
                            <th>Statut</th>
                            <th>Statut Signes Vitaux</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Pied de page -->
            <div class="row align-items-center g-2 mt-2">
                <div class="col-12 col-sm-6">
                    <div class="small text-muted" id="dt-info"></div>
                </div>
                <div class="col-12 col-sm-6 d-flex justify-content-sm-end">
                    <div id="dt-pager"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal des Signes Vitaux -->
<div class="modal fade" id="vitalsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="ti ti-heart-rate-monitor me-2"></i>Signes Vitaux du Patient
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modal-content-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Chargement des informations du patient...</p>
                </div>

                <div id="modal-content-form" style="display: none;">
                    <!-- En-tête Informations Patient -->
                    <div class="bg-light rounded p-3 mb-4">
                        <div class="row align-items-center">
                            <div class="col">
                                <h6 class="mb-1" id="modal-patient-name">Nom du Patient</h6>
                                <small class="text-muted" id="modal-appointment-info">Informations du Rendez-vous</small>
                            </div>
                            <div class="col-auto">
                                <span class="badge bg-primary-light text-primary px-3 py-2">
                                    <i class="ti ti-calendar me-1"></i>
                                    <span id="modal-appointment-time">Heure</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Formulaire des Signes Vitaux -->
                    <form id="vitalsForm">
                        <input type="hidden" id="appointmentId" name="appointmentId" />

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="bloodPressure" class="form-label">
                                    <i class="ti ti-activity text-danger me-1"></i>Pression Artérielle
                                </label>
                                <input type="text" class="form-control" id="bloodPressure" name="bloodPressure"
                                       placeholder="120/80" pattern="[0-9]+/[0-9]+" title="Format: 120/80">
                                <div class="form-text">Format: Systolique/Diastolique (ex: 120/80)</div>
                            </div>

                            <div class="col-md-6">
                                <label for="heartRate" class="form-label">
                                    <i class="ti ti-heart text-danger me-1"></i>Rythme Cardiaque (bpm)
                                </label>
                                <input type="number" class="form-control" id="heartRate" name="heartRate"
                                       placeholder="72" min="40" max="200">
                            </div>

                            <div class="col-md-6">
                                <label for="spo2" class="form-label">
                                    <i class="ti ti-lungs text-info me-1"></i>SpO2 (%)
                                </label>
                                <input type="number" class="form-control" id="spo2" name="spo2"
                                       placeholder="98" min="70" max="100">
                            </div>

                            <div class="col-md-6">
                                <label for="temperature" class="form-label">
                                    <i class="ti ti-temperature text-warning me-1"></i>Température (°F)
                                </label>
                                <input type="number" class="form-control" id="temperature" name="temperature"
                                       placeholder="98.6" step="0.1" min="95" max="110">
                            </div>

                            <div class="col-md-6">
                                <label for="respiratoryRate" class="form-label">
                                    <i class="ti ti-wind text-primary me-1"></i>Fréquence Respiratoire (/min)
                                </label>
                                <input type="number" class="form-control" id="respiratoryRate" name="respiratoryRate"
                                       placeholder="16" min="8" max="40">
                            </div>

                            <div class="col-md-6">
                                <label for="weight" class="form-label">
                                    <i class="ti ti-scale text-success me-1"></i>Poids (kg)
                                </label>
                                <input type="number" class="form-control" id="weight" name="weight"
                                       placeholder="70" step="0.1" min="1" max="500">
                            </div>
                        </div>

                        <div class="mt-4 p-3 bg-light rounded">
                            <h6 class="text-muted mb-2">
                                <i class="ti ti-info-circle me-1"></i>Référence des Plages Normales
                            </h6>
                            <div class="row small text-muted">
                                <div class="col-md-4">• Pression Artérielle: 90/60 - 120/80</div>
                                <div class="col-md-4">• Rythme Cardiaque: 60-100 bpm</div>
                                <div class="col-md-4">• SpO2: 95-100%</div>
                                <div class="col-md-4">• Température: 97-99°F</div>
                                <div class="col-md-4">• Fréq. Respiratoire: 12-20/min</div>
                                <div class="col-md-4">• Poids: Individuel</div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ti ti-x me-1"></i>Annuler
                </button>
                <button type="button" id="saveVitalsBtn" class="btn btn-primary" style="display: none;">
                    <span class="spinner-border spinner-border-sm me-2" id="save-spinner" style="display: none;"></span>
                    <i class="ti ti-device-floppy me-1"></i>Enregistrer les Signes Vitaux
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-primary-light {
        background-color: rgba(13, 110, 253, 0.1) !important;
    }

    .bg-info-light {
        background-color: rgba(13, 202, 240, 0.1) !important;
    }

    .bg-success-light {
        background-color: rgba(25, 135, 84, 0.1) !important;
    }

    .bg-warning-light {
        background-color: rgba(255, 193, 7, 0.1) !important;
    }

    .bg-danger-light {
        background-color: rgba(220, 53, 69, 0.1) !important;
    }

    .vitals-status-added {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
    }

    .vitals-status-pending {
        background: linear-gradient(45deg, #ffc107, #fd7e14);
        color: white;
    }
</style>

@section Scripts {
    <script>
        $(function () {
            const token = $('#__af input[name="__RequestVerificationToken"]').val();
            const vitalsModal = new bootstrap.Modal(document.getElementById('vitalsModal'));

            const table = $('#appointmentList').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: '@Url.Action("GetNurseAppointmentList")',
                    type: 'GET'
                },
                dom: 'rtip',
                paging: true,
                pagingType: 'simple_numbers',
                info: true,
                order: [[2, 'asc']], // Tri par heure
                columns: [
                    { data: 'appointmentNo', name: 'AppointmentNo' },
                    { data: 'patientName', name: 'PatientName' },
                    {
                        data: 'appointmentTime',
                        name: 'AppointmentTime',
                        render: d => new Date(d).toLocaleTimeString('fr-FR', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        })
                    },
                    { data: 'appointmentType', name: 'AppointmentType' },
                    {
                        data: 'status',
                        name: 'Status',
                        orderable: false,
                        render: data => {
                            const colorClass = data === 'Scheduled' ? 'warning' :
                                             data === 'InProgress' ? 'info' : 'success';
                            return `<span class="badge bg-${colorClass}-light text-${colorClass}">${data}</span>`;
                        }
                    },
                    {
                        data: 'hasVitals',
                        name: 'HasVitals',
                        orderable: false,
                        render: (hasVitals, type, row) => {
                            if (hasVitals) {
                                return `<span class="badge vitals-status-added">
                                          <i class="ti ti-check me-1"></i>Signes Vitaux Ajoutés
                                        </span>`;
                            } else {
                                return `<span class="badge vitals-status-pending">
                                          <i class="ti ti-clock me-1"></i>En Attente
                                        </span>`;
                            }
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        className: 'text-center',
                        render: (data, type, row) => {
                            const buttonText = row.hasVitals ? 'Modifier Signes Vitaux' : 'Ajouter Signes Vitaux';
                            const buttonClass = row.hasVitals ? 'btn-outline-primary' : 'btn-primary';
                            const icon = row.hasVitals ? 'ti-edit' : 'ti-plus';

                            return `<button class="btn ${buttonClass} btn-sm add-vitals-btn"
                                            data-appointment-id="${row.appointmentId}">
                                      <i class="ti ${icon} me-1"></i>${buttonText}
                                    </button>`;
                        }
                    }
                ],
                drawCallback: function() {
                    const api = this.api();
                    const pagerEl = $(api.table().container()).find('.dataTables_paginate');
                    if (pagerEl.length) $('#dt-pager').empty().append(pagerEl);

                    $('#dt-pager .paginate_button.previous .page-link').html('&lsaquo;');
                    $('#dt-pager .paginate_button.next .page-link').html('&rsaquo;');

                    const info = api.page.info();
                    const msg = info.recordsDisplay
                        ? `Affichage de ${info.start + 1} à ${info.end} sur ${info.recordsDisplay.toLocaleString()} rendez-vous`
                        : 'Aucun rendez-vous trouvé';
                    $('#dt-info').text(msg);
                },
                language: {
                    emptyTable: "Aucun rendez-vous pour aujourd'hui",
                    processing: "Chargement des rendez-vous...",
                    search: "Rechercher:",
                    lengthMenu: "Afficher _MENU_ entrées",
                    info: "Affichage de _START_ à _END_ sur _TOTAL_ entrées",
                    infoEmpty: "Affichage de 0 à 0 sur 0 entrées",
                    infoFiltered: "(filtré de _MAX_ entrées totales)",
                    zeroRecords: "Aucun enregistrement correspondant trouvé"
                }
            });

            // Gestionnaires d'événements
            $('#globalSearch').on('input', () => table.search($('#globalSearch').val()).draw());
            $('#pageLength').on('change', function () {
                table.page.len(parseInt(this.value, 10)).draw();
            });

            // Ouvrir le modal des signes vitaux
            $('#appointmentList').on('click', '.add-vitals-btn', function() {
                const appointmentId = $(this).data('appointment-id');
                loadVitalsModal(appointmentId);
            });

            function loadVitalsModal(appointmentId) {
                $('#modal-content-loading').show();
                $('#modal-content-form').hide();
                $('#saveVitalsBtn').hide();
                vitalsModal.show();

                $.ajax({
                    url: `/Appointment/GetAppointmentVitals?appointmentId=${appointmentId}`,
                    type: 'GET',
                    success: function(data) {
                        // Remplir le modal avec les données
                        $('#modal-patient-name').text(data.patientName);
                        $('#modal-appointment-time').text(data.appointmentTime);
                        $('#appointmentId').val(data.appointmentId);

                        // Remplir le formulaire des signes vitaux
                        const vitals = data.vitals;
                        $('#bloodPressure').val(vitals.bloodPressure || '');
                        $('#heartRate').val(vitals.heartRate || '');
                        $('#spo2').val(vitals.spo2 || '');
                        $('#temperature').val(vitals.temperature || '');
                        $('#respiratoryRate').val(vitals.respiratoryRate || '');
                        $('#weight').val(vitals.weight || '');

                        $('#modal-content-loading').hide();
                        $('#modal-content-form').show();
                        $('#saveVitalsBtn').show();
                    },
                    error: function() {
                        $('#modal-content-loading').html('<div class="alert alert-danger">Échec du chargement des données du rendez-vous</div>');
                    }
                });
            }

            // Sauvegarder les signes vitaux
            $('#saveVitalsBtn').on('click', function() {
                const btn = $(this);
                const spinner = $('#save-spinner');

                // Validation
                const appointmentId = $('#appointmentId').val();
                if (!appointmentId) {
                    alert('ID de rendez-vous invalide');
                    return;
                }

                // Obtenir les données du formulaire
                const vitalsData = {
                    AppointmentId: parseInt(appointmentId),
                    BloodPressure: $('#bloodPressure').val() || null,
                    HeartRate: $('#heartRate').val() || null,
                    Spo2: $('#spo2').val() || null,
                    Temperature: $('#temperature').val() || null,
                    RespiratoryRate: $('#respiratoryRate').val() || null,
                    Weight: $('#weight').val() || null
                };

                // Vérifier qu'au moins un signe vital est rempli
                const hasData = Object.values(vitalsData).some(value => value !== null && value !== '');
                if (!hasData) {
                    alert('Veuillez saisir au moins une mesure de signe vital');
                    return;
                }

                btn.prop('disabled', true);
                spinner.show();

                $.ajax({
                    url: '/Appointment/UpdateVitals',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: { 'RequestVerificationToken': token },
                    data: JSON.stringify(vitalsData),
                    success: function(response) {
                        if (response.success) {
                            vitalsModal.hide();
                            table.ajax.reload(null, false); // Actualiser le tableau

                            // Notification de succès
                            const toast = $(`<div class="toast position-fixed top-0 end-0 m-3" style="z-index: 9999;">
                                <div class="toast-header bg-success text-white">
                                    <i class="ti ti-check me-2"></i>
                                    <strong class="me-auto">Succès</strong>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                                </div>
                                <div class="toast-body">${response.message}</div>
                            </div>`);

                            $('body').append(toast);
                            const bsToast = new bootstrap.Toast(toast[0]);
                            bsToast.show();

                            toast.on('hidden.bs.toast', () => toast.remove());
                        } else {
                            alert('Erreur: ' + response.message);
                        }
                    },
                    error: function(e) {
                        alert('Une erreur est survenue lors de la sauvegarde des signes vitaux', e);
                    },
                    complete: function() {
                        btn.prop('disabled', false);
                        spinner.hide();
                    }
                });
            });
        });
    </script>
}
