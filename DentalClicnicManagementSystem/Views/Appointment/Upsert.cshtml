@* @model CMS.ViewModels.AppointmentUpsertVM

@{
    ViewData["Title"] = (Model?.Appointment?.AppointmentId ?? 0) == 0 ? "Create Appointment" : "Edit Appointment";
    var existing = Model?.Appointment?.AppointmentDate ?? DateTime.Now;
}

<form id="appointmentForm" asp-action="Upsert" asp-controller="Appointment" method="post" class="needs-validation">
    @Html.AntiForgeryToken()
    <input asp-for="Appointment.AppointmentId" type="hidden" />
    <div class="content py-3">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
            <h4 class="mb-0">@ViewData["Title"]</h4>
            <div class="d-flex gap-2">
                <a asp-action="Index" class="btn btn-outline-secondary btn-sm">Back</a>
            </div>
        </div>

        <validation-summary model-only="true" class="text-danger small"></validation-summary>

        <div class="row g-3">
            <div class="col-12">
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <h6 class="text-muted mb-3">Appointment Details</h6>

                        @if ((Model?.Appointment?.AppointmentId ?? 0) == 0)
                        {
                            <!-- CREATE mode : show preview -->
                            <div class="col-12">
                                <label class="form-label">Appointment Number</label>
                                <input class="form-control mb-2" value="@Model.AppointmentNo" readonly disabled />
                                <!-- post it back -->
                                <input type="hidden" name="Appointment.AppointmentNo" value="@Model.AppointmentNo" />
                            </div>
                        }
                        else
                        {
                            <!-- EDIT mode : show existing -->
                            <div class="col-12">
                                <label class="form-label">Appointment Number</label>
                                <input class="form-control" value="@Model.Appointment.AppointmentNo" readonly disabled />
                            </div>
                        }


                        <div class="row g-3">

                            <!-- Doctor -->

                            <div class="col-md-6">
                                <label asp-for="Appointment.DoctorId" class="form-label mb-1 fw-medium">Doctor<span class="text-danger ms-1">*</span></label>
                                <select asp-for="Appointment.DoctorId"
                                        asp-items="Model.Doctors"
                                        class="form-select select2"
                                        required>
                                    <option value="">--Select Doctor--</option>
                                </select>
                                <span asp-validation-for="Appointment.DoctorId" class="text-danger"></span>
                            </div>


                            <!-- Patient -->
                            <div class="col-md-6">
                                <label asp-for="Appointment.PatientId" class="form-label mb-1 fw-medium">
                                    Patient<span class="text-danger ms-1">*</span>
                                </label>
                                <div class="d-flex">
                                    <select asp-for="Appointment.PatientId" asp-items="Model.Patients" class="form-select select2 flex-fill rounded-bottom-0 rounded-end-0" required>
                                        <option value="">--Select Patient--</option>
                                    </select>
                                    <button type="button" id="btnAddPatient" class="btn btn-primary flex-shrink-0 border-0 rounded-0 rounded-end" data-bs-toggle="modal" data-bs-target="#addPatientModal">
                                        <i class="ti ti-plus"></i> Add
                                    </button>
                                </div>
                                <span asp-validation-for="Appointment.PatientId" class="text-danger"></span>
                            </div>

                            <!-- Appointment Type -->
                            <div class="col-md-6">
                                <label asp-for="Appointment.AppointmentType" class="form-label">Status</label>
                                <select asp-for="Appointment.AppointmentType" asp-items="Model.AppointmentTypes" class="form-select select2" required>
                                    <option value="">--Select Appointment Type--</option>
                                </select>
                                <span asp-validation-for="Appointment.AppointmentType" class="text-danger"></span>
                            </div>

                            <!-- Status -->
                            @if (Model?.Appointment?.AppointmentId > 0)
                            {
                                <div class="col-md-6">
                                    <label asp-for="Appointment.Status" class="form-label mb-1 fw-medium">Status</label>
                                    <select asp-for="Appointment.Status"
                                            asp-items="Model.Statuses"
                                            class="form-select select2"
                                            required>
                                        <option value="">--Select Status--</option>
                                    </select>
                                    <span asp-validation-for="Appointment.Status" class="text-danger"></span>
                                </div>
                            }


                            <!-- Hidden Appointment Date (set by slot selection) -->
                            <input asp-for="Appointment.AppointmentDate"
                                   type="hidden"
                                   id="appointmentDateHidden"
                                   value="@DateTime.UtcNow.ToString("o")" />

                            @if (Model?.Appointment?.AppointmentId > 0)
                            {
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="changeSlotChk">
                                    <label class="form-check-label" for="changeSlotChk">
                                        Change appointment time
                                    </label>
                                </div>
                            }

                            <div class="col-md-6">
                                <label class="form-label"> Appointment Date </label>
                                <div class="input-icon-end position-relative">
                                    <input type="text"
                                           id="dateInput"
                                           class="form-control"
                                           data-provider="flatpickr"
                                           data-date-format="d/m/Y"
                                           data-default-date="today"
                                           placeholder="dd/mm/yyyy">
                                    <span class="input-icon-addon">
                                        <i class="ti ti-calendar"></i>
                                    </span>
                                </div>


                            </div>
                            <div class="col-md-12">
                                <div id="dayAvailabilityCard">
                                    <!-- Single day availability will be rendered here -->
                                    <div class="text-muted text-center">Please select a doctor and date to see availability.</div>
                                </div>

                                <div id="gridHelp" class="form-text mt-2">
                                    Red text = no availability. Click a time to select it.
                                </div>


                                <div class="d-flex justify-content-end mt-4">
                                    <button type="submit" id="createBtn" class="btn btn-primary btn-lg px-4">
                                        <span id="btnSpinner" class="spinner-border spinner-border-sm d-none align-middle me-2"></span>
                                        <span id="btnText">@((Model?.Appointment?.AppointmentId == 0) ? "Create" : "Update")</span>
                                    </button>
                                </div>


                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</form>

<!-- Patient Add Modal -->
<div class="modal fade" id="addPatientModal" tabindex="-1" aria-labelledby="addPatientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-full-width">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addPatientModalLabel">Add Patient</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light" data-simplebar style="max-height: 80vh; overflow-y: auto;">
                <div id="patientFormContainer"></div>
            </div>
        </div>
    </div>
</div>

<style>
    
    input[data-provider="flatpickr"]::-webkit-calendar-picker-indicator {
        display: none !important;
    }

    .day-title {
        font-weight: 600;
        margin-bottom: 8px;
    }

    .time-button {
        width: auto;
        margin: 4px;
        white-space: nowrap;
    }

        .time-button.selected {
            background-color: #2E37A4;
            color: white;
        }

    .no-slots {
        color: #dc3545; /* bootstrap danger */
    }
</style>

@section Scripts
{
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Helper functions - declare in global scope
        function toUtcIso(dt) {
            return new Date(dt.getTime() - dt.getTimezoneOffset() * 60000).toISOString();
        }

        function toYyyyMmDd(dt) {
            const y = dt.getFullYear();
            const m = String(dt.getMonth() + 1).padStart(2, '0');
            const d = String(dt.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // Declare loadDay function in global scope
        async function loadDay(date) {
            const doctorId = $('select[name="Appointment.DoctorId"]').val();

            if (!doctorId) {
                $('#dayAvailabilityCard').html('<div class="text-muted text-center">Please select a doctor to see availability.</div>');
                $('#appointmentForm button[type="submit"]').prop('disabled', true);
                return;
            }
            $('#dayAvailabilityCard').html('<div class="text-muted text-center">Loading availability…</div>');

            try {
                const days = await $.get('@Url.Action("GetWeekSlots", "Appointment")',
                                         { doctorId, start: toYyyyMmDd(date) });
                if (!Array.isArray(days)) throw new Error('Bad response');

                const target = toYyyyMmDd(date);
                const found = days.find(d => d.date === target);
                if (!found) {
                    $('#dayAvailabilityCard').html('<div class="p-3 border rounded text-center no-slots">Not Available</div>');
                    $('#appointmentForm button[type="submit"]').prop('disabled', true);
                } else {
                    renderDaySlots(found);
                }
            } catch {
                $('#dayAvailabilityCard').html('<div class="text-danger text-center">Failed to load availability.</div>');
                $('#appointmentForm button[type="submit"]').prop('disabled', true);
            }
        }

        // Declare renderDaySlots in global scope
        function renderDaySlots(dayObj) {
            const $dayCard = $('#dayAvailabilityCard');
            const $submitBtn = $('#appointmentForm button[type="submit"]');
            const $hiddenDate = $('#appointmentDateHidden');

            $dayCard.empty();
            const head = $(`<div class="day-title text-center">${dayObj.day}</div>`);
            const box = $('<div class="d-flex flex-wrap justify-content-center p-2"></div>');

            if (!Array.isArray(dayObj.slots) || !dayObj.slots.length) {
                box.append('<div class="p-3 border rounded no-slots">No Slots</div>');
                $submitBtn.prop('disabled', true);
            } else {
                dayObj.slots.forEach(s => {
                    let $btn;
                    if (s.isBooked) {
                        $btn = $(`<button type="button" class="btn btn-danger time-button" disabled>${s.label} (Booked)</button>`);
                    } else {
                        $btn = $(`<button type="button" class="btn btn-success time-button">${s.label}</button>`);
                        $btn.attr('data-iso', s.iso);

                        $btn.on('click', function () {
                            $('.time-button').removeClass('btn-primary selected');
                            $(this).removeClass('btn-light').addClass('btn-primary selected');
                            $hiddenDate.val(s.iso);
                            $submitBtn.prop('disabled', false);
                        });
                    }
                    box.append($btn);
                });
                if (!dayObj.slots.some(s => !s.isBooked)) $submitBtn.prop('disabled', true);
            }
            $dayCard.append(head, box);

            // Auto-select slot that matches server value (edit mode)
            const serverUtc = $hiddenDate.val();
            if (serverUtc) {
                $(`.time-button[data-iso="${serverUtc}"]`)
                    .removeClass('btn-light')
                    .addClass('btn-primary selected');
            }
        }

        $(document).ready(function() {
            let fp; // Declare fp variable

            const appointmentDateUtc = new Date("@Model.Appointment.AppointmentDate.ToUniversalTime().ToString("o")");
            const localDate = new Date(appointmentDateUtc.toLocaleString("en-US", { timeZone: "Pakistan Standard Time" }));

            /* -------- flatpickr -------- */
            const $dateInput = $('#dateInput');
            fp = flatpickr($dateInput[0], {
                dateFormat: 'd/m/Y',
                minDate: 'today',
                defaultDate:  localDate,
                onChange: (selDates) => selDates.length && loadDay(selDates[0])
            });

            // when checkbox is ticked while editing - SPA VERSION
            $('#changeSlotChk').on('change', async function () {
                if (!this.checked) {
                    // If unchecking, just reload without freeing slot
                    const currentDate = fp.selectedDates[0] || new Date();
                    loadDay(currentDate);
                    return;
                }

                const doctorId = $('select[name="Appointment.DoctorId"]').val();
                const appointmentId = $('#Appointment_AppointmentId').val();

                if (!doctorId || !appointmentId) {
                    Swal.fire('Error', 'Please select a doctor and ensure appointment ID is present.', 'error');
                    $(this).prop('checked', false);
                    return;
                }

                // Show loading
                $('#dayAvailabilityCard').html('<div class="text-muted text-center">Freeing current slot...</div>');

                try {
                    // Get anti-forgery token
                    const token = $('input[name="__RequestVerificationToken"]').val();

                    // 1. FREE the old slot via AJAX
                    const result = await $.ajax({
                        url: '@Url.Action("UnbookSlot", "Appointment")',
                        type: 'POST',
                        data: {
                            appointmentId: appointmentId
                        },
                        headers: {
                            'RequestVerificationToken': token
                        }
                    });

                   ;

                    if (result.success) {
                        // Clear the currently selected slot
                        $('#appointmentDateHidden').val('');
                        $('.time-button').removeClass('btn-primary selected').addClass('btn-success');

                        // 2. Re-render the slot picker with updated availability
                        const currentDate = fp.selectedDates[0] || new Date();
                        await loadDay(currentDate);

                        Swal.fire('Success', 'Previous slot has been freed. Please select a new time slot.', 'success');
                    } else {
                        Swal.fire('Error', result.message || 'Could not free the previous slot.', 'error');
                        $(this).prop('checked', false);
                    }
                } catch (error) {
                    console.error('Error freeing slot:', error);
                    Swal.fire('Error', 'An error occurred while freeing the slot. Please try again.', 'error');
                    $(this).prop('checked', false);
                }
            });

            // SPA Form submission handler - NO PAGE RELOAD
            $('#appointmentForm').on('submit', async function (e) {
                e.preventDefault(); // Prevent default form submission

                const form = $(this);
                const formData = new FormData(this);
                const isCreate = $('#Appointment_AppointmentId').val() == '0';
                const spinner = $('#btnSpinner');
                const btnText = $('#btnText');

                // Show loading state
                const submitBtn = form.find('button[type="submit"]');
                const originalText = submitBtn.html();
                submitBtn.prop('disabled', true).html('<i class="ti ti-loader me-2"></i>Processing...');


                 submitBtn.prop('disabled', true);
                 spinner.removeClass('d-none');
                  btnText.text('Processing...');
                try {
                    const response = await $.ajax({
                        url: form.attr('action'),
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        }
                    });

                    if (response.success) {
                        window.location.href = '@Url.Action("Index", "Appointment")';
                    } else {
                        // Handle validation errors
                        if (response.errors) {
                            let errorHtml = '<ul class="mb-0">';
                            Object.values(response.errors).forEach(error => {
                                errorHtml += `<li>${error}</li>`;
                            });
                            errorHtml += '</ul>';
                            Swal.fire('Validation Error', errorHtml, 'error');
                        } else {
                            Swal.fire('Error', response.message || 'Something went wrong', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Form submission error:', error);
                    Swal.fire('Error', 'An error occurred while saving the appointment.', 'error');
                } finally {
                    // Restore button state
                    submitBtn.prop('disabled', false).html(originalText);
                    submitBtn.prop('disabled', false);
                    spinner.addClass('d-none');
                    btnText.text('Create');
                }
            });

            // SPA Patient Add Modal - Enhanced
            $(document).on('click', '#btnAddPatient', function() {
                $('#patientFormContainer').html('<div class="text-muted text-center">Loading form...</div>');
                $.ajax({
                    url: '/Appointment/PatientModel',
                    type: 'GET',
                    success: function(response) {
                        $('#patientFormContainer').html(response);
                        $('#addPatientModal').modal('show');

                        // Initialize validation for the modal form
                        $('#patientForm').removeClass('was-validated');
                    },
                    error: function() {
                        toastr.error('Error loading the patient form.');
                    }
                });
            });

            // SPA Patient form submission - Enhanced
            $(document).on('submit', '#patientForm', async function(e) {
                e.preventDefault();
                const form = $(this);
                const formData = new FormData(this);

                // Show loading
                const submitBtn = form.find('button[type="submit"]');
                const originalText = submitBtn.html();
                submitBtn.prop('disabled', true).html('<i class="ti ti-loader me-2"></i>Saving...');

                try {
                    const response = await $.ajax({
                        url: form.attr('action'),
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        }
                    });

                    if (response.success) {
                        toastr.success(response.message);

                        // Add the new patient to the dropdown
                        let patientDropdown = $('select[name="Appointment.PatientId"]');
                        patientDropdown.append(new Option(response.patientName, response.patientId, true, true));
                        patientDropdown.val(response.patientId).trigger('change');

                        // Close the modal
                        $('#addPatientModal').modal('hide');

                        // Reset the patient form for next use
                        $('#patientForm')[0].reset();
                    } else {
                        // Reload the modal with validation errors
                        $('#patientFormContainer').html(response);
                        // Re-initialize any scripts if needed
                        $('.select2').select2({ theme: 'bootstrap-5', width: '100%' });
                    }
                } catch (error) {
                    console.error('Patient save error:', error);
                    toastr.error("Something went wrong while saving the patient.");
                } finally {
                    submitBtn.prop('disabled', false).html(originalText);
                }
            });

            /* -------- Select2 -------- */
            $('.select2').select2({ width: '100%' });

            /* -------- doctor change -------- */
            $('select[name="Appointment.DoctorId"]').on('change', function() {
                const currentDate = fp.selectedDates[0] || new Date();
                loadDay(currentDate);
            });

            /* -------- initial load -------- */
            const serverDate = new Date($('#appointmentDateHidden').val() || '@existing.ToUniversalTime().ToString("o")');
            fp.setDate(serverDate, true);
            loadDay(serverDate);

            // Remove the default form validation since we're handling via AJAX
            $('.needs-validation').removeClass('needs-validation');
        });

        // Global error handler for AJAX
        $(document).ajaxError(function(event, jqxhr, settings, thrownError) {
            if (jqxhr.status === 401) {
                Swal.fire('Session Expired', 'Please refresh the page and try again.', 'error');
            } else if (jqxhr.status === 500) {
                Swal.fire('Server Error', 'Something went wrong on our end. Please try again.', 'error');
            }
        });
    </script>
}
 *@

@model CMS.ViewModels.AppointmentUpsertVM

@{
    ViewData["Title"] = (Model?.Appointment?.AppointmentId ?? 0) == 0 ? "Créer un Rendez-vous" : "Modifier le Rendez-vous";
    var existing = Model?.Appointment?.AppointmentDate ?? DateTime.Now;
}

<form id="appointmentForm" asp-action="Upsert" asp-controller="Appointment" method="post" class="needs-validation">
    @Html.AntiForgeryToken()
    <input asp-for="Appointment.AppointmentId" type="hidden" />
    <div class="content py-3">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
            <h4 class="mb-0">@ViewData["Title"]</h4>
            <div class="d-flex gap-2">
                <a asp-action="Index" class="btn btn-outline-secondary btn-sm">Retour</a>
            </div>
        </div>

        <validation-summary model-only="true" class="text-danger small"></validation-summary>

        <div class="row g-3">
            <div class="col-12">
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <h6 class="text-muted mb-3">Détails du Rendez-vous</h6>

                        @if ((Model?.Appointment?.AppointmentId ?? 0) == 0)
                        {
                            <!-- MODE CRÉATION : afficher l'aperçu -->
                            <div class="col-12">
                                <label class="form-label">Numéro de Rendez-vous</label>
                                <input class="form-control mb-2" value="@Model.AppointmentNo" readonly disabled />
                                <!-- le renvoyer -->
                                <input type="hidden" name="Appointment.AppointmentNo" value="@Model.AppointmentNo" />
                            </div>
                        }
                        else
                        {
                            <!-- MODE ÉDITION : afficher l'existant -->
                            <div class="col-12">
                                <label class="form-label">Numéro de Rendez-vous</label>
                                <input class="form-control" value="@Model.Appointment.AppointmentNo" readonly disabled />
                            </div>
                        }

                        <div class="row g-3">
                            <!-- Médecin -->
                            <div class="col-md-6">
                                <label asp-for="Appointment.DoctorId" class="form-label mb-1 fw-medium">Médecin<span class="text-danger ms-1">*</span></label>
                                <select asp-for="Appointment.DoctorId"
                                        asp-items="Model.Doctors"
                                        class="form-select select2"
                                        required>
                                    <option value="">--Sélectionner un Médecin--</option>
                                </select>
                                <span asp-validation-for="Appointment.DoctorId" class="text-danger"></span>
                            </div>

                            <!-- Patient -->
                            <div class="col-md-6">
                                <label asp-for="Appointment.PatientId" class="form-label mb-1 fw-medium">
                                    Patient<span class="text-danger ms-1">*</span>
                                </label>
                                <div class="d-flex">
                                    <select asp-for="Appointment.PatientId" asp-items="Model.Patients" class="form-select select2 flex-fill rounded-bottom-0 rounded-end-0" required>
                                        <option value="">--Sélectionner un Patient--</option>
                                    </select>
                                    <button type="button" id="btnAddPatient" class="btn btn-primary flex-shrink-0 border-0 rounded-0 rounded-end" data-bs-toggle="modal" data-bs-target="#addPatientModal">
                                        <i class="ti ti-plus"></i> Ajouter
                                    </button>
                                </div>
                                <span asp-validation-for="Appointment.PatientId" class="text-danger"></span>
                            </div>

                            <!-- Type de Rendez-vous -->
                            <div class="col-md-6">
                                <label asp-for="Appointment.AppointmentType" class="form-label">Type</label>
                                <select asp-for="Appointment.AppointmentType" asp-items="Model.AppointmentTypes" class="form-select select2" required>
                                    <option value="">--Sélectionner le Type--</option>
                                </select>
                                <span asp-validation-for="Appointment.AppointmentType" class="text-danger"></span>
                            </div>

                            <!-- Statut -->
                            @if (Model?.Appointment?.AppointmentId > 0)
                            {
                                <div class="col-md-6">
                                    <label asp-for="Appointment.Status" class="form-label mb-1 fw-medium">Statut</label>
                                    <select asp-for="Appointment.Status"
                                            asp-items="Model.Statuses"
                                            class="form-select select2"
                                            required>
                                        <option value="">--Sélectionner le Statut--</option>
                                    </select>
                                    <span asp-validation-for="Appointment.Status" class="text-danger"></span>
                                </div>
                            }

                            <!-- Date de Rendez-vous Cachée (définie par sélection de créneau) -->
                            <input asp-for="Appointment.AppointmentDate"
                                   type="hidden"
                                   id="appointmentDateHidden"
                                   value="@DateTime.UtcNow.ToString("o")" />

                            @if (Model?.Appointment?.AppointmentId > 0)
                            {
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="changeSlotChk">
                                    <label class="form-check-label" for="changeSlotChk">
                                        Changer l'horaire du rendez-vous
                                    </label>
                                </div>
                            }

                            <div class="col-md-6">
                                <label class="form-label">Date du Rendez-vous</label>
                                <div class="input-icon-end position-relative">
                                    <input type="text"
                                           id="dateInput"
                                           class="form-control"
                                           data-provider="flatpickr"
                                           data-date-format="d/m/Y"
                                           data-default-date="today"
                                           placeholder="jj/mm/aaaa">
                                    <span class="input-icon-addon">
                                        <i class="ti ti-calendar"></i>
                                    </span>
                                </div>
                            </div>

                            <div class="col-md-12">
                                <div id="dayAvailabilityCard">
                                    <!-- La disponibilité d'une journée sera affichée ici -->
                                    <div class="text-muted text-center">Veuillez sélectionner un médecin et une date pour voir les disponibilités.</div>
                                </div>

                                <div id="gridHelp" class="form-text mt-2">
                                    Texte rouge = pas de disponibilité. Cliquez sur un horaire pour le sélectionner.
                                </div>

                                <div class="d-flex justify-content-end mt-4">
                                    <button type="submit" id="createBtn" class="btn btn-primary btn-lg px-4">
                                        <span id="btnSpinner" class="spinner-border spinner-border-sm d-none align-middle me-2"></span>
                                        <span id="btnText">@((Model?.Appointment?.AppointmentId == 0) ? "Créer" : "Modifier")</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Modal d'Ajout de Patient -->
<div class="modal fade" id="addPatientModal" tabindex="-1" aria-labelledby="addPatientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-full-width">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addPatientModalLabel">Ajouter un Patient</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light" data-simplebar style="max-height: 80vh; overflow-y: auto;">
                <div id="patientFormContainer"></div>
            </div>
        </div>
    </div>
</div>

<style>
    input[data-provider="flatpickr"]::-webkit-calendar-picker-indicator {
        display: none !important;
    }

    .day-title {
        font-weight: 600;
        margin-bottom: 8px;
    }

    .time-button {
        width: auto;
        margin: 4px;
        white-space: nowrap;
    }

        .time-button.selected {
            background-color: #2E37A4;
            color: white;
        }

    .no-slots {
        color: #dc3545; /* bootstrap danger */
    }
</style>

@section Scripts
{
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Fonctions utilitaires - déclarer dans la portée globale
        function toUtcIso(dt) {
            return new Date(dt.getTime() - dt.getTimezoneOffset() * 60000).toISOString();
        }

        function toYyyyMmDd(dt) {
            const y = dt.getFullYear();
            const m = String(dt.getMonth() + 1).padStart(2, '0');
            const d = String(dt.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // Déclarer la fonction loadDay dans la portée globale
        async function loadDay(date) {
            const doctorId = $('select[name="Appointment.DoctorId"]').val();

            if (!doctorId) {
                $('#dayAvailabilityCard').html('<div class="text-muted text-center">Veuillez sélectionner un médecin pour voir les disponibilités.</div>');
                $('#appointmentForm button[type="submit"]').prop('disabled', true);
                return;
            }
            $('#dayAvailabilityCard').html('<div class="text-muted text-center">Chargement des disponibilités…</div>');

            try {
                const days = await $.get('@Url.Action("GetWeekSlots", "Appointment")',
                                         { doctorId, start: toYyyyMmDd(date) });
                if (!Array.isArray(days)) throw new Error('Mauvaise réponse');

                const target = toYyyyMmDd(date);
                const found = days.find(d => d.date === target);
                if (!found) {
                    $('#dayAvailabilityCard').html('<div class="p-3 border rounded text-center no-slots">Non Disponible</div>');
                    $('#appointmentForm button[type="submit"]').prop('disabled', true);
                } else {
                    renderDaySlots(found);
                }
            } catch {
                $('#dayAvailabilityCard').html('<div class="text-danger text-center">Échec du chargement des disponibilités.</div>');
                $('#appointmentForm button[type="submit"]').prop('disabled', true);
            }
        }

        // Déclarer renderDaySlots dans la portée globale
        function renderDaySlots(dayObj) {
            const $dayCard = $('#dayAvailabilityCard');
            const $submitBtn = $('#appointmentForm button[type="submit"]');
            const $hiddenDate = $('#appointmentDateHidden');

            $dayCard.empty();
            const head = $(`<div class="day-title text-center">${dayObj.day}</div>`);
            const box = $('<div class="d-flex flex-wrap justify-content-center p-2"></div>');

            if (!Array.isArray(dayObj.slots) || !dayObj.slots.length) {
                box.append('<div class="p-3 border rounded no-slots">Aucun Créneau</div>');
                $submitBtn.prop('disabled', true);
            } else {
                dayObj.slots.forEach(s => {
                    let $btn;
                    if (s.isBooked) {
                        $btn = $(`<button type="button" class="btn btn-danger time-button" disabled>${s.label} (Réservé)</button>`);
                    } else {
                        $btn = $(`<button type="button" class="btn btn-success time-button">${s.label}</button>`);
                        $btn.attr('data-iso', s.iso);

                        $btn.on('click', function () {
                            $('.time-button').removeClass('btn-primary selected');
                            $(this).removeClass('btn-light').addClass('btn-primary selected');
                            $hiddenDate.val(s.iso);
                            $submitBtn.prop('disabled', false);
                        });
                    }
                    box.append($btn);
                });
                if (!dayObj.slots.some(s => !s.isBooked)) $submitBtn.prop('disabled', true);
            }
            $dayCard.append(head, box);

            // Sélection automatique du créneau correspondant à la valeur serveur (mode édition)
            const serverUtc = $hiddenDate.val();
            if (serverUtc) {
                $(`.time-button[data-iso="${serverUtc}"]`)
                    .removeClass('btn-light')
                    .addClass('btn-primary selected');
            }
        }

        $(document).ready(function() {
            let fp; // Déclarer la variable fp

            const appointmentDateUtc = new Date("@Model.Appointment.AppointmentDate.ToUniversalTime().ToString("o")");
            const localDate = new Date(appointmentDateUtc.toLocaleString("fr-FR", { timeZone: "Europe/Paris" }));

            /* -------- flatpickr -------- */
            const $dateInput = $('#dateInput');
            fp = flatpickr($dateInput[0], {
                dateFormat: 'd/m/Y',
                minDate: 'today',
                defaultDate: localDate,
                locale: 'fr',
                onChange: (selDates) => selDates.length && loadDay(selDates[0])
            });

            // quand la case est cochée pendant l'édition - VERSION SPA
            $('#changeSlotChk').on('change', async function () {
                if (!this.checked) {
                    // Si décoché, recharger sans libérer le créneau
                    const currentDate = fp.selectedDates[0] || new Date();
                    loadDay(currentDate);
                    return;
                }

                const doctorId = $('select[name="Appointment.DoctorId"]').val();
                const appointmentId = $('#Appointment_AppointmentId').val();

                if (!doctorId || !appointmentId) {
                    Swal.fire('Erreur', 'Veuillez sélectionner un médecin et vous assurer que l\'ID du rendez-vous est présent.', 'error');
                    $(this).prop('checked', false);
                    return;
                }

                // Afficher le chargement
                $('#dayAvailabilityCard').html('<div class="text-muted text-center">Libération du créneau actuel...</div>');

                try {
                    // Obtenir le jeton anti-contrefaçon
                    const token = $('input[name="__RequestVerificationToken"]').val();

                    // 1. LIBÉRER l'ancien créneau via AJAX
                    const result = await $.ajax({
                        url: '@Url.Action("UnbookSlot", "Appointment")',
                        type: 'POST',
                        data: {
                            appointmentId: appointmentId
                        },
                        headers: {
                            'RequestVerificationToken': token
                        }
                    });

                    if (result.success) {
                        // Effacer le créneau actuellement sélectionné
                        $('#appointmentDateHidden').val('');
                        $('.time-button').removeClass('btn-primary selected').addClass('btn-success');

                        // 2. Re-rendre le sélecteur de créneaux avec les disponibilités mises à jour
                        const currentDate = fp.selectedDates[0] || new Date();
                        await loadDay(currentDate);

                        Swal.fire('Succès', 'L\'ancien créneau a été libéré. Veuillez sélectionner un nouvel horaire.', 'success');
                    } else {
                        Swal.fire('Erreur', result.message || 'Impossible de libérer l\'ancien créneau.', 'error');
                        $(this).prop('checked', false);
                    }
                } catch (error) {
                    console.error('Erreur de libération du créneau:', error);
                    Swal.fire('Erreur', 'Une erreur est survenue lors de la libération du créneau. Veuillez réessayer.', 'error');
                    $(this).prop('checked', false);
                }
            });

            // Gestionnaire de soumission de formulaire SPA - PAS DE RECHARGEMENT DE PAGE
            $('#appointmentForm').on('submit', async function (e) {
                e.preventDefault(); // Empêcher la soumission par défaut du formulaire

                const form = $(this);
                const formData = new FormData(this);
                const isCreate = $('#Appointment_AppointmentId').val() == '0';
                const spinner = $('#btnSpinner');
                const btnText = $('#btnText');

                // Afficher l'état de chargement
                const submitBtn = form.find('button[type="submit"]');
                const originalText = submitBtn.html();
                submitBtn.prop('disabled', true).html('<i class="ti ti-loader me-2"></i>Traitement...');

                submitBtn.prop('disabled', true);
                spinner.removeClass('d-none');
                btnText.text('Traitement...');

                try {
                    const response = await $.ajax({
                        url: form.attr('action'),
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        }
                    });

                    if (response.success) {
                        window.location.href = '@Url.Action("Index", "Appointment")';
                    } else {
                        // Gérer les erreurs de validation
                        if (response.errors) {
                            let errorHtml = '<ul class="mb-0">';
                            Object.values(response.errors).forEach(error => {
                                errorHtml += `<li>${error}</li>`;
                            });
                            errorHtml += '</ul>';
                            Swal.fire('Erreur de Validation', errorHtml, 'error');
                        } else {
                            Swal.fire('Erreur', response.message || 'Quelque chose s\'est mal passé', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Erreur de soumission du formulaire:', error);
                    Swal.fire('Erreur', 'Une erreur est survenue lors de l\'enregistrement du rendez-vous.', 'error');
                } finally {
                    // Restaurer l'état du bouton
                    submitBtn.prop('disabled', false).html(originalText);
                    submitBtn.prop('disabled', false);
                    spinner.addClass('d-none');
                    btnText.text(isCreate ? 'Créer' : 'Modifier');
                }
            });

            // Modal d'Ajout de Patient SPA - Amélioré
            $(document).on('click', '#btnAddPatient', function() {
                $('#patientFormContainer').html('<div class="text-muted text-center">Chargement du formulaire...</div>');
                $.ajax({
                    url: '/Appointment/PatientModel',
                    type: 'GET',
                    success: function(response) {
                        $('#patientFormContainer').html(response);
                        $('#addPatientModal').modal('show');

                        // Initialiser la validation pour le formulaire modal
                        $('#patientForm').removeClass('was-validated');
                    },
                    error: function() {
                        toastr.error('Erreur lors du chargement du formulaire patient.');
                    }
                });
            });

            // Soumission du formulaire patient SPA - Amélioré
            $(document).on('submit', '#patientForm', async function(e) {
                e.preventDefault();
                const form = $(this);
                const formData = new FormData(this);

                // Afficher le chargement
                const submitBtn = form.find('button[type="submit"]');
                const originalText = submitBtn.html();
                submitBtn.prop('disabled', true).html('<i class="ti ti-loader me-2"></i>Enregistrement...');

                try {
                    const response = await $.ajax({
                        url: form.attr('action'),
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        }
                    });

                    if (response.success) {
                        toastr.success(response.message);

                        // Ajouter le nouveau patient à la liste déroulante
                        let patientDropdown = $('select[name="Appointment.PatientId"]');
                        patientDropdown.append(new Option(response.patientName, response.patientId, true, true));
                        patientDropdown.val(response.patientId).trigger('change');

                        // Fermer le modal
                        $('#addPatientModal').modal('hide');

                        // Réinitialiser le formulaire patient pour une utilisation ultérieure
                        $('#patientForm')[0].reset();
                    } else {
                        // Recharger le modal avec les erreurs de validation
                        $('#patientFormContainer').html(response);
                        // Réinitialiser les scripts si nécessaire
                        $('.select2').select2({ theme: 'bootstrap-5', width: '100%' });
                    }
                } catch (error) {
                    console.error('Erreur d\'enregistrement du patient:', error);
                    toastr.error("Quelque chose s'est mal passé lors de l'enregistrement du patient.");
                } finally {
                    submitBtn.prop('disabled', false).html(originalText);
                }
            });

            /* -------- Select2 -------- */
            $('.select2').select2({ width: '100%' });

            /* -------- changement de médecin -------- */
            $('select[name="Appointment.DoctorId"]').on('change', function() {
                const currentDate = fp.selectedDates[0] || new Date();
                loadDay(currentDate);
            });

            /* -------- chargement initial -------- */
            const serverDate = new Date($('#appointmentDateHidden').val() || '@existing.ToUniversalTime().ToString("o")');
            fp.setDate(serverDate, true);
            loadDay(serverDate);

            // Supprimer la validation de formulaire par défaut puisque nous gérons via AJAX
            $('.needs-validation').removeClass('needs-validation');
        });

        // Gestionnaire d'erreur global pour AJAX
        $(document).ajaxError(function(event, jqxhr, settings, thrownError) {
            if (jqxhr.status === 401) {
                Swal.fire('Session Expirée', 'Veuillez actualiser la page et réessayer.', 'error');
            } else if (jqxhr.status === 500) {
                Swal.fire('Erreur Serveur', 'Quelque chose s\'est mal passé de notre côté. Veuillez réessayer.', 'error');
            }
        });
    </script>
}
