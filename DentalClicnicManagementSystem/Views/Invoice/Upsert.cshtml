@* @inject CMS.Services.ICurrencyService CurrencyService
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor hca

@model CMS.ViewModels.InvoiceUpsertViewModel
@using System.Security.Claims

@{
    ViewData["Title"] = Model.Invoice.Id == 0 ? "Add Invoice" : "Edit Invoice";
    var currency = await CurrencyService.GetCurrentCurrencyAsync();
    var fullName = hca.HttpContext?.User?.FindFirstValue(ClaimTypes.Name) ?? "System";
    var isAutoGenerated = Model.Invoice.AppointmentId.HasValue && Model.Invoice.AppointmentId > 0;
    var invoiceType = Model.Invoice.InvoiceType;
}

<div class="main-wrapper">
    <div class="page-wrapper m-0">
        <div class="content">
            <!-- Start Page Header -->
            <div class="d-flex align-items-sm-center flex-sm-row flex-column gap-2 mb-3">
                <div class="flex-grow-1">
                    <h6 class="fw-bold mb-0 d-flex align-items-center">
                        <a asp-action="Index"><i class="ti ti-chevron-left me-1 fs-14"></i>Invoices</a>
                    </h6>
                </div>
                @if (isAutoGenerated)
                {
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-info auto-generated-badge">
                            <i class="ti ti-bolt me-1"></i>Auto-Generated
                        </span>
                        <span class="badge @GetInvoiceTypeBadgeClass(invoiceType) invoice-type-badge">
                            @invoiceType Invoice
                        </span>
                    </div>
                }
                else
                {
                    <span class="badge bg-secondary invoice-type-badge">
                        Manual @invoiceType Invoice
                    </span>
                }
            </div>
            <!-- End Page Header -->

            <div class="card">
                <div class="card-header">
                    <h5 class="fw-bold m-0">
                        @ViewData["Title"]
                        @if (isAutoGenerated)
                        {
                            <small class="text-muted fs-14">(From Appointment #@Model.Invoice.AppointmentId)</small>
                        }
                    </h5>
                </div>
                <div class="card-body">
                    <form asp-action="Upsert" method="post" id="invoiceForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="Invoice.Id" />
                        <input type="hidden" asp-for="Invoice.IsAppointmentInvoice" value="@Model.Invoice.IsAppointmentInvoice.ToString().ToLower()" />
                        <input type="hidden" asp-for="Invoice.AppointmentId" />

                        <input type="hidden" asp-for="Invoice.InvoiceType" />
                        <input type="hidden" asp-for="Invoice.InvoiceNumber" />

                        <!-- Hidden fields for system values -->
                        <!-- Preserve navigation property IDs -->
                        <input type="hidden" asp-for="Invoice.DoctorId" />
                        <input type="hidden" asp-for="Invoice.PatientId" />
                        <input type="hidden" asp-for="Invoice.AppointmentId" />

                        <!-- Preserve system fields that shouldn't change -->


                        <input type="hidden" asp-for="Invoice.CurrencyCode" value="@currency.Code" />

                        <!-- Auto-Generated Info Alert -->
                        @if (isAutoGenerated)
                        {
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="ti ti-info-circle me-2 fs-18"></i>
                                <div>
                                    <h6 class="alert-heading mb-1">Auto-Generated Invoice</h6>
                                    <p class="mb-0">This invoice was automatically generated from an appointment. Some fields may be pre-filled and restricted.</p>
                                    @if (Model.Invoice.AppointmentId.HasValue)
                                    {
                                        <a href="/Appointment/Details/@Model.Invoice.AppointmentId" class="btn btn-sm btn-outline-info mt-2">
                                            <i class="ti ti-external-link me-1"></i>View Appointment
                                        </a>
                                    }
                                </div>
                            </div>
                        }

                        <div class="row">
                            <!-- Invoice Type Selection (only for new manual invoices) -->
                            @if (Model.Invoice.Id == 0 && !isAutoGenerated)
                            {
                                <div class="col-lg-12 mb-3">
                                    <label class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Invoice Type <span class="text-danger">*</span>
                                    </label>
                                    <select asp-for="Invoice.InvoiceType" asp-items="Model.InvoiceTypes" class="form-select" id="invoiceTypeSelect">
                                        <option value="">-- Select Invoice Type --</option>
                                    </select>
                                    <span asp-validation-for="Invoice.InvoiceType" class="text-danger"></span>
                                </div>
                            }

                            <!-- Customer Info Fields -->
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.CustomerName" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Patient Name <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input asp-for="Invoice.CustomerName" type="text" class="form-control"
                                               readonly="@(isAutoGenerated ? "readonly" : null)" />
                                        @if (isAutoGenerated)
                                        {
                                            <span class="input-group-text bg-light">
                                                <i class="ti ti-lock text-muted"></i>
                                            </span>
                                        }
                                    </div>
                                    <span asp-validation-for="Invoice.CustomerName" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.CustomerEmail" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Email <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input asp-for="Invoice.CustomerEmail" type="email" class="form-control"
                                               readonly="@(isAutoGenerated ? "readonly" : null)" />
                                        @if (isAutoGenerated)
                                        {
                                            <span class="input-group-text bg-light">
                                                <i class="ti ti-lock text-muted"></i>
                                            </span>
                                        }
                                    </div>
                                    <span asp-validation-for="Invoice.CustomerEmail" class="text-danger"></span>
                                </div>
                            </div>

                            <!-- Appointment Information (for auto-generated invoices) -->
                            @if (isAutoGenerated && Model.Invoice.AppointmentId.HasValue)
                            {
                                <div class="col-lg-12 mb-3">
                                    <div class="card bg-light border">
                                        <div class="card-body py-3">
                                            <h6 class="fw-semibold mb-2"><i class="ti ti-calendar me-2"></i>Appointment Information</h6>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <small class="text-muted">Appointment ID</small>
                                                    <p class="mb-0 fw-semibold">#@Model.Invoice.AppointmentId</p>
                                                </div>
                                                <div class="col-md-4">
                                                    <small class="text-muted">Doctor</small>
                                                    <p class="mb-0 fw-semibold">@(Model.Invoice.Doctor?.FullName ?? "N/A")</p>

                                                </div>
                                                <div class="col-md-4">
                                                    <small class="text-muted">Patient ID</small>
                                                    <p class="mb-0 fw-semibold">#@Model.Invoice.PatientId</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Manual Appointment Selection (for manual combined/appointment invoices) -->
                            @if (!isAutoGenerated && (Model.IsAppointmentInvoice || Model.IsCombinedInvoice))
                            {
                                <div class="col-lg-6 col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label mb-1 text-dark fs-14 fw-medium">
                                            Link to Appointment
                                        </label>
                                        <select asp-for="Invoice.AppointmentId" asp-items="Model.Appointments" class="form-select">
                                            <option value="">-- Select Appointment (Optional) --</option>
                                        </select>
                                        <small class="text-muted">Linking to an appointment will auto-fill patient information</small>
                                    </div>
                                </div>
                            }

                            <!-- Date Fields -->
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.IssueDate" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Invoice Date <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-icon-end position-relative">
                                        <input asp-for="Invoice.IssueDate" type="date" class="form-control" />
                                    </div>
                                    <span asp-validation-for="Invoice.IssueDate" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.DueDate" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Due Date <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-icon-end position-relative">
                                        <input asp-for="Invoice.DueDate" type="date" class="form-control" />
                                    </div>
                                    <span asp-validation-for="Invoice.DueDate" class="text-danger"></span>
                                </div>
                            </div>

                            <!-- Address Fields -->
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.CustomerAddress" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Patient Address <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <textarea asp-for="Invoice.CustomerAddress" class="form-control" rows="3"
                                                  readonly="@(isAutoGenerated ? "readonly" : null)"></textarea>
                                        @if (isAutoGenerated)
                                        {
                                            <span class="input-group-text bg-light align-items-start">
                                                <i class="ti ti-lock text-muted mt-1"></i>
                                            </span>
                                        }
                                    </div>
                                    <span asp-validation-for="Invoice.CustomerAddress" class="text-danger"></span>
                                </div>
                            </div>

                            <!-- Payment Information -->
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Payment Method <span class="text-danger">*</span>
                                    </label>
                                    <select asp-for="Invoice.PaymentMethodId" asp-items="Model.PaymentMethods" class="form-select">
                                        <option value="">-- Select Payment Method --</option>
                                    </select>
                                    <span asp-validation-for="Invoice.PaymentMethodId" class="text-danger"></span>
                                </div>
                            </div>

                            <!-- Payment Status -->
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.PaymentStatus" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Payment Status <span class="text-danger">*</span>
                                    </label>
                                    <select asp-for="Invoice.PaymentStatus" asp-items="Html.GetEnumSelectList<PaymentStatus>()" class="form-select">
                                        <option value="">-- Select Status --</option>
                                    </select>
                                    <span asp-validation-for="Invoice.PaymentStatus" class="text-danger"></span>
                                </div>
                            </div>

                            <!-- Invoice Items Table -->
                            <div class="col-lg-12 col-md-12">
                                <div class=" table-responsive table-nowrap">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="fw-semibold mb-0">Invoice Items</h6>
                                        @if (isAutoGenerated)
                                        {
                                            <span class="badge bg-info">Items auto-populated from @invoiceType.ToString().ToLower()</span>
                                        }
                                    </div>
                                    <table class="table table-hover align-middle w-100 nowrap" style="min-width: 900px;">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="col-3">Item Type</th>
                                                <th class="col-2">Item</th>
                                                <th class="col-3">Description</th>
                                                <th class="col-2">Unit Price</th>
                                                <th class="col-2">Qty</th>
                                                <th class="col-2">Amount</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody class="invoices-list">
                                            @if (Model.Invoice.Items != null && Model.Invoice.Items.Any())
                                            {
                                                for (int i = 0; i < Model.Invoice.Items.Count; i++)
                                                {
                                                    <partial name="_InvoiceItemRow"
                                                             model="Model.Invoice.Items[i]"
                                                             view-data='new ViewDataDictionary(ViewData) {
                                                                { "Index", i },
                                                                { "InventoryItems", Model.InventoryItems ?? new List<CMS.Models.InventoryItem>() },
                                                                { "Treatments",  Model.Treatments ?? new() },   // ← add
                                                                { "InvoiceType", Model.Invoice.InvoiceType },
                                                                { "IsAutoGenerated", isAutoGenerated }
                                                            }' />
                                                                                        }
                                            }
                                            else
                                            {
                                                <tr>
                                                    <td colspan="7" class="text-center py-4 text-muted">
                                                        <i class="ti ti-package fs-32 mb-2 d-block"></i>
                                                        No items added yet
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="7">
                                                    @if (!isAutoGenerated)
                                                    {
                                                        <a href="javascript:void(0);"
                                                           class="btn add-invoices border-0 text-dark d-flex align-items-center fs-14">
                                                            <i class="ti ti-circle-plus text-primary me-1"></i> Add Invoice Item
                                                        </a>
                                                    }
                                                    else
                                                    {
                                                        <div class="text-muted fs-12">
                                                            <i class="ti ti-info-circle me-1"></i>
                                                            Items are managed through the associated appointment
                                                        </div>
                                                    }
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>

                            <!-- Totals and Currency -->
                            <div class="col-lg-8 col-md-8">
                                <!-- Notes Section -->
                                <div class="mb-3">
                                    <label asp-for="Invoice.Notes" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Additional Notes
                                    </label>
                                    <div class="input-group">
                                        <textarea asp-for="Invoice.Notes" rows="3" class="form-control"
                                                  placeholder="Add any additional information or instructions..."></textarea>
                                    </div>
                                    <span asp-validation-for="Invoice.Notes" class="text-danger"></span>
                                </div>
                            </div>

                            <!-- Payment Recording Section -->
                            @if (Model.Invoice.Id > 0 || Model.Invoice.Total > 0)
{
                            <div class="col-lg-12">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="fw-semibold mb-0"><i class="ti ti-cash me-2"></i>Record Payment</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label class="form-label">Payment Amount</label>
                                                <input type="number" step="0.01" class="form-control" id="paymentAmount"
                                                       placeholder="Enter amount" />
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Payment Method</label>
                                                <select class="form-select" id="paymentMethodSelect">
                                                    <option value="">-- Select Method --</option>
                                                    @foreach (var method in Model.PaymentMethods)
                                                    {
                                                        <option value="@method.Value">@method.Text</option>
                                                    }
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Notes (Optional)</label>
                                                <input type="text" class="form-control" id="paymentNotes"
                                                       placeholder="Payment reference or notes" />
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                <button type="button" class="btn btn-success w-100" id="recordPaymentBtn">
                                                    <i class="ti ti-check me-1"></i>Record Payment
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mt-3" id="paymentStatusAlert" style="display: none;">
                                            <!-- Payment status messages will appear here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            }
                            <div class="col-lg-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="fw-semibold mb-3 border-bottom pb-2">Invoice Summary</h6>
                                        <div class="d-flex align-items-center justify-content-between mb-2">
                                            <h6 class="fs-14 fw-normal text-dark">SubTotal</h6>
                                            <h6 class="fs-14 fw-semibold text-dark" id="subTotalDisplay">
                                                @currency.Symbol@Model.Invoice.SubTotal.ToString("N2")
                                            </h6>
                                            <input type="hidden" asp-for="Invoice.SubTotal" id="subTotalInput" />
                                        </div>
                                        <div class="d-flex align-items-center justify-content-between mb-2">
                                            <label asp-for="Invoice.Tax" class="fs-14 fw-normal text-dark">Tax</label>
                                            <input asp-for="Invoice.Tax" type="number" step="0.01"
                                                   class="form-control w-auto text-end"
                                                   style="max-width: 100px;"
                                                   id="taxInput"
                                                    />
                                        </div>
                                        <div class="d-flex align-items-center justify-content-between mb-2">
                                            <label asp-for="Invoice.Discount" class="fs-14 fw-normal text-dark">Discount</label>
                                            <input asp-for="Invoice.Discount" type="number" step="0.01"
                                                   class="form-control w-auto text-end"
                                                   style="max-width: 100px;"
                                                   id="discountInput"
                                                    />
                                        </div>

                                        <div class="d-flex align-items-center justify-content-between mb-2 pt-2 border-top">
                                            <h6 class="fs-16 fw-bold">Total</h6>
                                            <h6 class="fs-16 fw-bold" id="totalDisplay">
                                                @currency.Symbol@Model.Invoice.Total.ToString("N2")
                                            </h6>
                                            <input type="hidden" asp-for="Invoice.Total" id="totalInput" />
                                        </div>

                                        <!-- Amount Paid & Due -->
                                        <div class="d-flex align-items-center justify-content-between mb-1">
                                            <small class="text-muted">Amount Paid</small>
                                            <small class="text-muted" id="amountPaidDisplay">
                                                @currency.Symbol@Model.Invoice.AmountPaid.ToString("N2")
                                            </small>
                                            <input type="hidden" asp-for="Invoice.AmountPaid" id="amountPaidInput" />
                                        </div>
                                        <div class="d-flex align-items-center justify-content-between">
                                            <small class="text-muted">Amount Due</small>
                                            <small class="fw-semibold text-primary" id="amountDueDisplay">
                                                @currency.Symbol@Model.Invoice.AmountDue.ToString("N2")
                                            </small>
                                            <input type="hidden" asp-for="Invoice.AmountDue" id="amountDueInput" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="card-footer">
                    <div class="d-flex gap-2 align-items-center justify-content-end mb-0">
                        <a asp-action="Index"
                           class="btn btn-md bg-light text-dark fs-13 fw-medium rounded">Cancel</a>

                        @if (isAutoGenerated)
                        {
                            <div class="dropdown">
                                <button class="btn btn-md btn-primary fs-13 fw-medium rounded dropdown-toggle"
                                        type="button" data-bs-toggle="dropdown">
                                    <i class="ti ti-edit me-1"></i>Update Invoice
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <button type="submit" form="invoiceForm"
                                                class="dropdown-item d-flex align-items-center">
                                            <i class="ti ti-check me-2"></i>Save Changes
                                        </button>
                                    </li>
                                    <li>
                                        <a href="/Appointment/Details/@Model.Invoice.AppointmentId"
                                           class="dropdown-item d-flex align-items-center">
                                            <i class="ti ti-external-link me-2"></i>View Appointment
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        }
                        else
                        {
                            <button type="submit" form="invoiceForm"
                                    class="btn btn-md btn-primary fs-13 fw-medium rounded">
                                <i class="ti ti-check me-1"></i>Save Invoice
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .invoice-type-badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }

    .auto-generated-badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }

    .invoices-list .item-name {
        min-width: 200px;
    }

    .invoices-list .item-description,
    .invoices-list .item-unit-Cost,
    .invoices-list .item-quantity {
        min-width: 100px;
    }

    .select2-container .select2-selection--single {
        min-width: 200px;
    }

    .bg-light {
        background-color: #f8f9fa !important;
    }
</style>
@section Scripts {
    
    <script>
        $(function () {
            let idx = @((Model.Invoice.Items?.Count ?? 0));
            const isAuto = @(isAutoGenerated.ToString().ToLower());
            const currSym = '@currency.Symbol';

            /* ---------- SINGLE add row handler ---------- */
            $(document).off('click', '.add-invoices');
            $(document).on('click', '.add-invoices', function (e) {
            e.preventDefault();
            console.log('Add button clicked');
            addRow();
        });

            /* ---------- remove row ---------- */
            $(document).on('click', '.remove-invoices', function () {
                if (isAuto) {
                    alert('Cannot delete items from an auto-generated invoice');
                    return;
                }
                $(this).closest('tr').remove();
                recalc();
            });

            /* ---------- type changed ---------- */

                    $(document).on('change', '.item-type-select', function () {
            const $row = $(this).closest('tr');
            const type = $(this).val();
            const index = $(this).data('index');

            // Clear previous input fields
            $row.find('.item-name-controls').empty();
            $row.find('.item-unitprice, .item-description, .js-item-display').val('');
            recalc($row);  // Recalculate line total

            if (!type) return;

            if (type === 'Consultation' || type === 'Test') {
                // For free text types (Consultation, Test)
                const placeholder = type === 'Consultation' ? 'Consultation with' : 'Test name';
                $row.find('.item-name-controls').html(`<input type="text" class="form-control" placeholder="${placeholder}" />`);
                return;
            }

            // Handle for dropdown types like Treatment, Inventory, Medication
            const url = type === 'Inventory' ? '/Invoice/GetInventoryList'
                          : type === 'Medication' ? '/Invoice/GetInventoryList'
                          : '/Invoice/GetTreatmentList';

            $.getJSON(url, data => {
                let options = `<select class="form-control item-name-select"><option value="">-- Select ${type} --</option>`;
                $.each(data, (k, v) => {
                    options += `<option value="${v.id}" data-price="${v.unitPrice}" data-desc="${v.description || ''}">${v.name}</option>`;
                });
                options += '</select>';
                $row.find('.item-name-controls').html(options);
                $row.find('.item-name-select').select2({ width: '100%', dropdownParent: $row });
            });
        });

        $(document).on('change', '.item-name-select', function () {
            const $row = $(this).closest('tr');
            const $option = $(this).find('option:selected');
            const type = $row.find('.item-type-select').val();

            // Update display value
            $row.find('.js-item-display').val($option.text());

            // Set hidden field values based on item type
            $row.find('[name$="InventoryItemId"]').val(type === 'Inventory' ? $option.val() : '');
            $row.find('[name$="TreatmentId"]').val(type === 'Treatment' ? $option.val() : '');
            $row.find('[name$="LabTestId"]').val(type === 'Test' ? $option.val() : '');
            $row.find('[name$="MedicationsId"]').val(type === 'Medication' ? $option.val() : '');

            // Set price and description
            $row.find('.item-unitprice').val($option.data('price') || 0);
            $row.find('.item-description').val($option.data('desc') || '');

            recalc($row); // Recalculate totals
        });

            // $(document).on('change', '.item-type-select', function () {
            //     const $row = $(this).closest('tr');
            //     const type = $(this).val();
            //     const i = $(this).data('index');

            //     $row.find('.item-name-controls').empty();
            //     $row.find('.item-unitprice, .item-description, .js-item-display').val('');
            //     recalc($row);

            //     if (!type) return;

            //     /* ---- free text ---- */
            //     if (type === 'Consultation' || type === 'Test') {
            //         const ph = type === 'Consultation' ? 'Consultation with'
            //                  : type === 'Test' ? 'Test name'
            //                  : 'Treatment name';
            //         $row.find('.item-name-controls').html(
            //             `<input type="text" class="form-control" placeholder="${ph}" />`);
            //         return;
            //     }

            //     /* ---- dropdown ---- */
            //     const url = type === 'Inventory' ? '/Invoice/GetInventoryList'
            //               : type === 'Medication' ? '/Invoice/GetMedicationList'
            //               : '/Invoice/GetTreatmentList';

            //     $.getJSON(url, data => {
            //         let opts = `<select class="form-control item-name-select"><option value="">-- Select ${type} --</option>`;
            //         $.each(data, (k, v) => {
            //             opts += `<option value="${v.id}"
            //                             data-price="${v.unitPrice}"
            //                             data-desc="${v.description || ''}">${v.name}</option>`;
            //         });
            //         opts += '</select>';
            //         $row.find('.item-name-controls').html(opts);
            //         $row.find('.item-name-select').select2({ width: '100%', dropdownParent: $row });
            //     });
            // });

            /* ---------- name picked ---------- */
            $(document).on('change', '.item-name-select', function () {
                const $row = $(this).closest('tr');
                const $opt = $(this).find('option:selected');
                const type = $row.find('.item-type-select').val();

                // UI mirror
                $row.find('.js-item-display').val($opt.text());

                // Authoritative FK
                $row.find('[name$="InventoryItemId"]').val(type === 'Inventory' ? $opt.val() : '');
                $row.find('[name$="TreatmentId"]').val(type === 'Treatment' ? $opt.val() : '');
                $row.find('[name$="LabTestId"]').val(type === 'Test' ? $opt.val() : '');
                $row.find('[name$="MedicationsId"]').val(type === 'Medication' ? $opt.val() : '');

                // Price & description
                $row.find('.item-unitprice').val($opt.data('price') || 0);
                $row.find('.item-description').val($opt.data('desc') || '');
                recalc($row);
            });

            /* ---------- free text input handler ---------- */
            $(document).on('input', '.item-name-controls input[type="text"]', function () {
                const $row = $(this).closest('tr');
                $row.find('.js-item-display').val($(this).val());
            });

            /* ---------- qty / price ---------- */
            $(document).on('input', '.item-qty, .item-unitprice', function () {
                recalc($(this).closest('tr'));
            });

            $(document).on('input', '#taxInput, #discountInput, #amountPaidInput', recalc);

            /* ---------- math helpers ---------- */
            function recalc($row) {
                if ($row && $row.length) {
                    const q = parseFloat($row.find('.item-qty').val()) || 0;
                    const p = parseFloat($row.find('.item-unitprice').val()) || 0;
                    $row.find('.item-linetotal').val((q * p).toFixed(2));
                }

                let sub = 0;
                $('.item-linetotal').each(function () {
                    sub += parseFloat(this.value) || 0;
                });

                const tax = parseFloat($('#taxInput').val()) || 0;
                const dis = parseFloat($('#discountInput').val()) || 0;
                const paid = parseFloat($('#amountPaidInput').val()) || 0;
                const tot = sub + tax - dis;

                $('#subTotalDisplay').text(currSym + sub.toFixed(2));
                $('#totalDisplay').text(currSym + tot.toFixed(2));
                $('#amountDueDisplay').text(currSym + (tot - paid).toFixed(2));
                $('#subTotalInput').val(sub.toFixed(2));
                $('#totalInput').val(tot.toFixed(2));
                $('#amountDueInput').val((tot - paid).toFixed(2));
                updatePaymentMaxAmount();
            }

            /* ---------- new row html ---------- */
            function addRow() {
                
                const html = `
                    <tr class="invoices-list-item" data-index="${idx}">
                        <td>
                            <select name="Invoice.Items[${idx}].ItemType" class="form-control item-type-select" data-index="${idx}">


                                <option value="Inventory">Medication</option>
                                <option value="Treatment">Treatment</option>
                                <option value="Test">Laboratory Test</option>
                                
                            </select>
                        </td>
                        <td class="item-name-cell">
                            <div class="item-name-controls"></div>
                            

                            <!-- Hidden fields -->
                            <input type="hidden" name="Invoice.Items[${idx}].AppointmentWIth" />
                            <input type="hidden" name="Invoice.Items[${idx}].TreatmentName" />
                            <input type="hidden" name="Invoice.Items[${idx}].TestName" />
                            <input type="hidden" name="Invoice.Items[${idx}].MedicationsName" />
                            <input type="hidden" name="Invoice.Items[${idx}].InventoryItemId" />
                            <input type="hidden" name="Invoice.Items[${idx}].TreatmentId" />
                            

                            <input type="hidden" name="Invoice.Items[${idx}].MedicationsId" />
                        </td>
                        <td><input name="Invoice.Items[${idx}].Description" class="form-control item-description" /></td>
                        <td><input name="Invoice.Items[${idx}].UnitPrice" class="form-control item-unitprice" step="0.01" /></td>
                        <td><input name="Invoice.Items[${idx}].Quantity" class="form-control item-qty" value="1" /></td>
                        <td><input type="text" class="form-control item-linetotal" readonly value="0" /></td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-invoices">
                                <i class="ti ti-trash"></i>
                            </button>
                        </td>
                    </tr>`;
                $('.invoices-list').append(html);
                idx++;
            }

            /* ---------- AJAX Form Submission ---------- */
            $('#invoiceForm').on('submit', function (e) {
                e.preventDefault();

                const $form = $(this);
                const $submitBtn = $('button[type="submit"]');
                const originalText = $submitBtn.html();

                // Show loading state
                $submitBtn.prop('disabled', true).html('<i class="ti ti-loader me-1"></i>Processing...');

                // Update display names before submission
                updateDisplayNames();

                // Serialize form data
                const formData = new FormData($form[0]);

                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            window.location.href = response.redirectUrl;
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error!',
                                html: response.message + (response.errors ? '<br><small>' + response.errors.join('<br>') + '</small>' : '')
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Request Failed!',
                            text: 'An error occurred while saving the invoice: ' + error
                        });
                    },
                    complete: function() {
                        $submitBtn.prop('disabled', false).html(originalText);
                    }
                });
            });



                    function updateDisplayNames() {
            $('.invoices-list-item').each(function () {
                const $row = $(this);
                const type = $row.find('.item-type-select').val();

                // Get the display value from the appropriate source
                let displayValue = '';

                if (type === 'Consultation' || type === 'Test' || type === 'Treatment') {
                    // For free text types, get from the input field
                    displayValue = $row.find('.item-name-controls input[type="text"]').val() || '';
                } else {
                    // For dropdown types, get from selected option text
                    displayValue = $row.find('.item-name-controls select option:selected').text() || '';
                }

                console.log('Type:', type, 'Display Value:', displayValue); // Debug log

                // Map to appropriate field based on item type
                switch (type) {
                    case 'Consultation':
                        $row.find('[name$="AppointmentWIth"]').val(displayValue);
                        console.log('Setting AppointmentWIth:', displayValue);
                        break;
                    case 'Treatment':
                        $row.find('[name$="TreatmentName"]').val(displayValue);
                        console.log('Setting TreatmentName:', displayValue);
                        break;
                    case 'Test':
                        $row.find('[name$="TestName"]').val(displayValue);
                        console.log('Setting TestName:', displayValue);
                        break;
                    case 'Medication':
                    case 'Inventory':
                        $row.find('[name$="MedicationsName"]').val(displayValue);
                        console.log('Setting MedicationsName:', displayValue);
                        break;
                }
            });
        }


                /* ---------- Payment Recording ---------- */
                  /* ---------- Payment Recording ---------- */
        $('#recordPaymentBtn').on('click', function () {
            const amount = parseFloat($('#paymentAmount').val()) || 0;
            const methodId = $('#paymentMethodSelect').val();
            const notes = $('#paymentNotes').val();
            const invoiceId = @Model.Invoice.Id; // This is 0 for new invoices!

            // Get CURRENT amount due
            const amountDueText = $('#amountDueDisplay').text().replace(/[^0-9.-]+/g, "");
            const currentAmountDue = parseFloat(amountDueText) || 0;

            if (!amount || amount <= 0) {
                showPaymentAlert('Please enter a valid payment amount', 'danger');
                return;
            }

            if (!methodId) {
                showPaymentAlert('Please select a payment method', 'danger');
                return;
            }

            if (amount > currentAmountDue) {
                showPaymentAlert(`Payment amount (${amount}) cannot exceed amount due (${currentAmountDue})`, 'danger');
                return;
            }

            const $btn = $(this);
            const originalText = $btn.html();
            $btn.prop('disabled', true).html('<i class="ti ti-loader me-1"></i>Processing...');

            // **For NEW invoices (ID = 0), save invoice first, then record payment**
            if (invoiceId === 0) {
                saveInvoiceAndThenRecordPayment(amount, methodId, notes);
            } else {
                // **For EXISTING invoices, record payment directly**
                recordPaymentDirectly(invoiceId, amount, methodId, notes);
            }
        });

        function saveInvoiceAndThenRecordPayment(amount, methodId, notes) {
            // First save the invoice via form submission
            const $form = $('#invoiceForm');
            const formData = new FormData($form[0]);

            $.ajax({
                url: $form.attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        // Invoice saved successfully, now record payment
                        const newInvoiceId = response.invoiceId || extractInvoiceIdFromRedirect(response.redirectUrl);
                        recordPaymentDirectly(newInvoiceId, amount, methodId, notes);
                    } else {
                        showPaymentAlert('Failed to save invoice: ' + response.message, 'danger');
                        $('#recordPaymentBtn').prop('disabled', false).html('<i class="ti ti-check me-1"></i>Record Payment');
                    }
                },
                error: function(xhr) {
                    showPaymentAlert('Error saving invoice: ' + xhr.responseText, 'danger');
                    $('#recordPaymentBtn').prop('disabled', false).html('<i class="ti ti-check me-1"></i>Record Payment');
                }
            });
        }

        function recordPaymentDirectly(invoiceId, amount, methodId, notes) {
            $.ajax({
                url: '/Invoice/RecordPayment',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    invoiceId: invoiceId,
                    amount: amount,
                    paymentMethodId: parseInt(methodId),
                    notes: notes
                }),
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showPaymentAlert('Payment recorded successfully!', 'success');
                        // Clear payment form
                        $('#paymentAmount, #paymentNotes').val('');
                        $('#paymentMethodSelect').val('');

                        // Update the invoice amounts
                        updateInvoiceAmountsAfterPayment(amount);

                        // If this was a new invoice, redirect to the invoice page
                        if (@Model.Invoice.Id === 0) {
                            setTimeout(() => {
                                window.location.href = '/Invoice/Upsert/' + invoiceId;
                            }, 1500);
                        }
                    } else {
                        showPaymentAlert(response.message, 'danger');
                    }
                },
                error: function (xhr) {
                    showPaymentAlert('Error recording payment: ' + xhr.responseText, 'danger');
                },
                complete: function () {
                    $('#recordPaymentBtn').prop('disabled', false).html('<i class="ti ti-check me-1"></i>Record Payment');
                }
            });
        }

        function extractInvoiceIdFromRedirect(redirectUrl) {
            // Extract invoice ID from redirect URL like "/Invoice/Upsert/123"
            const match = redirectUrl.match(/\/Invoice\/Upsert\/(\d+)/);
            return match ? parseInt(match[1]) : 0;
        }

        // Function to update invoice amounts after payment
        function updateInvoiceAmountsAfterPayment(paymentAmount) {
            const currentPaid = parseFloat($('#amountPaidInput').val()) || 0;
            const currentDue = parseFloat($('#amountDueInput').val()) || 0;

            const newPaid = currentPaid + paymentAmount;
            const newDue = currentDue - paymentAmount;

            // Update hidden inputs
            $('#amountPaidInput').val(newPaid.toFixed(2));
            $('#amountDueInput').val(newDue.toFixed(2));

            // Update displays
            $('#amountPaidDisplay').text(currSym + newPaid.toFixed(2));
            $('#amountDueDisplay').text(currSym + newDue.toFixed(2));

            // Update payment max amount
            // updatePaymentMaxAmount();
        }
        function updatePaymentMaxAmount() {
            const amountDueText = $('#amountDueDisplay').text().replace(/[^0-9.-]+/g, "");
            const currentAmountDue = parseFloat(amountDueText) || 0;
            $('#paymentAmount').attr('max', currentAmountDue);
        }
        function showPaymentAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('#paymentStatusAlert').html(alertHtml).show();
        }

        // Update payment amount max when amounts change
         

        
        
            /* ---------- first calc ---------- */
            recalc();
        });
    </script>
}

@functions {
    /// <summary>
    /// Returns the appropriate CSS class for invoice type badges
    /// </summary>
    /// <param name="type">The invoice type</param>
    /// <returns>CSS class string for the badge</returns>
    public string GetInvoiceTypeBadgeClass(InvoiceType type)
    {
        return type switch
        {
            InvoiceType.Appointment => "bg-primary",
            InvoiceType.Medication => "bg-success",
            InvoiceType.Combined => "bg-info",
            InvoiceType.Laboratory => "bg-warning",
            _ => "bg-secondary"
        };
    }
}
 *@



@inject CMS.Services.ICurrencyService CurrencyService
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor hca

@model CMS.ViewModels.InvoiceUpsertViewModel
@using System.Security.Claims

@{
    ViewData["Title"] = Model.Invoice.Id == 0 ? "Ajouter une Facture" : "Modifier la Facture";
    var currency = await CurrencyService.GetCurrentCurrencyAsync();
    var fullName = hca.HttpContext?.User?.FindFirstValue(ClaimTypes.Name) ?? "Système";
    var isAutoGenerated = Model.Invoice.AppointmentId.HasValue && Model.Invoice.AppointmentId > 0;
    var invoiceType = Model.Invoice.InvoiceType;
}

<div class="main-wrapper">
    <div class="page-wrapper m-0">
        <div class="content">
            <!-- Début En-tête de Page -->
            <div class="d-flex align-items-sm-center flex-sm-row flex-column gap-2 mb-3">
                <div class="flex-grow-1">
                    <h6 class="fw-bold mb-0 d-flex align-items-center">
                        <a asp-action="Index"><i class="ti ti-chevron-left me-1 fs-14"></i>Factures</a>
                    </h6>
                </div>
                @if (isAutoGenerated)
                {
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-info auto-generated-badge">
                            <i class="ti ti-bolt me-1"></i>Auto-Générée
                        </span>
                        <span class="badge @GetInvoiceTypeBadgeClass(invoiceType) invoice-type-badge">
                            Facture @invoiceType
                        </span>
                    </div>
                }
                else
                {
                    <span class="badge bg-secondary invoice-type-badge">
                        Facture @invoiceType Manuelle
                    </span>
                }
            </div>
            <!-- Fin En-tête de Page -->

            <div class="card">
                <div class="card-header">
                    <h5 class="fw-bold m-0">
                        @ViewData["Title"]
                        @if (isAutoGenerated)
                        {
                            <small class="text-muted fs-14">(Du Rendez-vous #@Model.Invoice.AppointmentId)</small>
                        }
                    </h5>
                </div>
                <div class="card-body">
                    <form asp-action="Upsert" method="post" id="invoiceForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="Invoice.Id" />
                        <input type="hidden" asp-for="Invoice.IsAppointmentInvoice" value="@Model.Invoice.IsAppointmentInvoice.ToString().ToLower()" />
                        <input type="hidden" asp-for="Invoice.AppointmentId" />

                        <input type="hidden" asp-for="Invoice.InvoiceType" />
                        <input type="hidden" asp-for="Invoice.InvoiceNumber" />

                        <!-- Champs cachés pour les valeurs système -->
                        <!-- Préserver les IDs des propriétés de navigation -->
                        <input type="hidden" asp-for="Invoice.DoctorId" />
                        <input type="hidden" asp-for="Invoice.PatientId" />
                        <input type="hidden" asp-for="Invoice.AppointmentId" />

                        <!-- Préserver les champs système qui ne doivent pas changer -->
                        <input type="hidden" asp-for="Invoice.CurrencyCode" value="@currency.Code" />

                        <!-- Alerte Info Auto-Générée -->
                        @if (isAutoGenerated)
                        {
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="ti ti-info-circle me-2 fs-18"></i>
                                <div>
                                    <h6 class="alert-heading mb-1">Facture Auto-Générée</h6>
                                    <p class="mb-0">Cette facture a été générée automatiquement à partir d'un rendez-vous. Certains champs peuvent être pré-remplis et restreints.</p>
                                    @if (Model.Invoice.AppointmentId.HasValue)
                                    {
                                        <a href="/Appointment/Details/@Model.Invoice.AppointmentId" class="btn btn-sm btn-outline-info mt-2">
                                            <i class="ti ti-external-link me-1"></i>Voir le Rendez-vous
                                        </a>
                                    }
                                </div>
                            </div>
                        }

                        <div class="row">
                            <!-- Sélection du Type de Facture (uniquement pour les nouvelles factures manuelles) -->
                            @if (Model.Invoice.Id == 0 && !isAutoGenerated)
                            {
                                <div class="col-lg-12 mb-3">
                                    <label class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Type de Facture <span class="text-danger">*</span>
                                    </label>
                                    <select asp-for="Invoice.InvoiceType" asp-items="Model.InvoiceTypes" class="form-select" id="invoiceTypeSelect">
                                        <option value="">-- Sélectionner le Type de Facture --</option>
                                    </select>
                                    <span asp-validation-for="Invoice.InvoiceType" class="text-danger"></span>
                                </div>
                            }

                            <!-- Champs Informations Client -->
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.CustomerName" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Nom du Patient <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input asp-for="Invoice.CustomerName" type="text" class="form-control"
                                               readonly="@(isAutoGenerated ? "readonly" : null)" />
                                        @if (isAutoGenerated)
                                        {
                                            <span class="input-group-text bg-light">
                                                <i class="ti ti-lock text-muted"></i>
                                            </span>
                                        }
                                    </div>
                                    <span asp-validation-for="Invoice.CustomerName" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.CustomerEmail" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Email <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input asp-for="Invoice.CustomerEmail" type="email" class="form-control"
                                               readonly="@(isAutoGenerated ? "readonly" : null)" />
                                        @if (isAutoGenerated)
                                        {
                                            <span class="input-group-text bg-light">
                                                <i class="ti ti-lock text-muted"></i>
                                            </span>
                                        }
                                    </div>
                                    <span asp-validation-for="Invoice.CustomerEmail" class="text-danger"></span>
                                </div>
                            </div>

                            <!-- Informations du Rendez-vous (pour les factures auto-générées) -->
                            @if (isAutoGenerated && Model.Invoice.AppointmentId.HasValue)
                            {
                                <div class="col-lg-12 mb-3">
                                    <div class="card bg-light border">
                                        <div class="card-body py-3">
                                            <h6 class="fw-semibold mb-2"><i class="ti ti-calendar me-2"></i>Informations du Rendez-vous</h6>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <small class="text-muted">ID Rendez-vous</small>
                                                    <p class="mb-0 fw-semibold">#@Model.Invoice.AppointmentId</p>
                                                </div>
                                                <div class="col-md-4">
                                                    <small class="text-muted">Médecin</small>
                                                    <p class="mb-0 fw-semibold">@(Model.Invoice.Doctor?.FullName ?? "N/A")</p>
                                                </div>
                                                <div class="col-md-4">
                                                    <small class="text-muted">ID Patient</small>
                                                    <p class="mb-0 fw-semibold">#@Model.Invoice.PatientId</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Sélection Manuelle du Rendez-vous (pour les factures manuelles combinées/rendez-vous) -->
                            @if (!isAutoGenerated && (Model.IsAppointmentInvoice || Model.IsCombinedInvoice))
                            {
                                <div class="col-lg-6 col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label mb-1 text-dark fs-14 fw-medium">
                                            Lier à un Rendez-vous
                                        </label>
                                        <select asp-for="Invoice.AppointmentId" asp-items="Model.Appointments" class="form-select">
                                            <option value="">-- Sélectionner un Rendez-vous (Optionnel) --</option>
                                        </select>
                                        <small class="text-muted">Lier à un rendez-vous remplira automatiquement les informations du patient</small>
                                    </div>
                                </div>
                            }

                            <!-- Champs Date -->
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.IssueDate" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Date de Facture <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-icon-end position-relative">
                                        <input asp-for="Invoice.IssueDate" type="date" class="form-control" />
                                    </div>
                                    <span asp-validation-for="Invoice.IssueDate" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.DueDate" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Date d'Échéance <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-icon-end position-relative">
                                        <input asp-for="Invoice.DueDate" type="date" class="form-control" />
                                    </div>
                                    <span asp-validation-for="Invoice.DueDate" class="text-danger"></span>
                                </div>
                            </div>

                            <!-- Champs Adresse -->
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.CustomerAddress" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Adresse du Patient <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <textarea asp-for="Invoice.CustomerAddress" class="form-control" rows="3"
                                                  readonly="@(isAutoGenerated ? "readonly" : null)"></textarea>
                                        @if (isAutoGenerated)
                                        {
                                            <span class="input-group-text bg-light align-items-start">
                                                <i class="ti ti-lock text-muted mt-1"></i>
                                            </span>
                                        }
                                    </div>
                                    <span asp-validation-for="Invoice.CustomerAddress" class="text-danger"></span>
                                </div>
                            </div>

                            <!-- Informations de Paiement -->
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Méthode de Paiement <span class="text-danger">*</span>
                                    </label>
                                    <select asp-for="Invoice.PaymentMethodId" asp-items="Model.PaymentMethods" class="form-select">
                                        <option value="">-- Sélectionner la Méthode de Paiement --</option>
                                    </select>
                                    <span asp-validation-for="Invoice.PaymentMethodId" class="text-danger"></span>
                                </div>
                            </div>

                            <!-- Statut de Paiement -->
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.PaymentStatus" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Statut de Paiement <span class="text-danger">*</span>
                                    </label>
                                    <select asp-for="Invoice.PaymentStatus" asp-items="Html.GetEnumSelectList<PaymentStatus>()" class="form-select">
                                        <option value="">-- Sélectionner le Statut --</option>
                                    </select>
                                    <span asp-validation-for="Invoice.PaymentStatus" class="text-danger"></span>
                                </div>
                            </div>

                            <!-- Tableau des Articles de Facture -->
                            <div class="col-lg-12 col-md-12">
                                <div class="table-responsive table-nowrap">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="fw-semibold mb-0">Articles de Facture</h6>
                                        @if (isAutoGenerated)
                                        {
                                            <span class="badge bg-info">Articles auto-remplis depuis @invoiceType.ToString().ToLower()</span>
                                        }
                                    </div>
                                    <table class="table table-hover align-middle w-100 nowrap" style="min-width: 900px;">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="col-3">Type d'Article</th>
                                                <th class="col-2">Article</th>
                                                <th class="col-3">Description</th>
                                                <th class="col-2">Prix Unitaire</th>
                                                <th class="col-2">Qté</th>
                                                <th class="col-2">Montant</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody class="invoices-list">
                                            @if (Model.Invoice.Items != null && Model.Invoice.Items.Any())
                                            {
                                                for (int i = 0; i < Model.Invoice.Items.Count; i++)
                                                {
                                                    <partial name="_InvoiceItemRow"
                                                             model="Model.Invoice.Items[i]"
                                                             view-data='new ViewDataDictionary(ViewData) {
                                                                                                                     { "Index", i },
                                                                                                                     { "InventoryItems", Model.InventoryItems ?? new List<CMS.Models.InventoryItem>() },
                                                                                                                     { "Treatments",  Model.Treatments ?? new() },
                                                                                                                     { "InvoiceType", Model.Invoice.InvoiceType },
                                                                                                                     { "IsAutoGenerated", isAutoGenerated }
                                                                                                                 }' />
                                                                                        }
                                            }
                                            else
                                            {
                                                <tr>
                                                    <td colspan="7" class="text-center py-4 text-muted">
                                                        <i class="ti ti-package fs-32 mb-2 d-block"></i>
                                                        Aucun article ajouté pour le moment
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="7">
                                                    @if (!isAutoGenerated)
                                                    {
                                                        <a href="javascript:void(0);"
                                                           class="btn add-invoices border-0 text-dark d-flex align-items-center fs-14">
                                                            <i class="ti ti-circle-plus text-primary me-1"></i> Ajouter un Article
                                                        </a>
                                                    }
                                                    else
                                                    {
                                                        <div class="text-muted fs-12">
                                                            <i class="ti ti-info-circle me-1"></i>
                                                            Les articles sont gérés via le rendez-vous associé
                                                        </div>
                                                    }
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>

                            <!-- Totaux et Devise -->
                            <div class="col-lg-8 col-md-8">
                                <!-- Section Notes -->
                                <div class="mb-3">
                                    <label asp-for="Invoice.Notes" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Notes Additionnelles
                                    </label>
                                    <div class="input-group">
                                        <textarea asp-for="Invoice.Notes" rows="3" class="form-control"
                                                  placeholder="Ajouter des informations ou instructions supplémentaires..."></textarea>
                                    </div>
                                    <span asp-validation-for="Invoice.Notes" class="text-danger"></span>
                                </div>
                            </div>

                            <!-- Section Enregistrement de Paiement -->
                            @if (Model.Invoice.Id > 0 || Model.Invoice.Total > 0)
                            {
                                <div class="col-lg-12">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="fw-semibold mb-0"><i class="ti ti-cash me-2"></i>Enregistrer un Paiement</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <label class="form-label">Montant du Paiement</label>
                                                    <input type="number" step="0.01" class="form-control" id="paymentAmount"
                                                           placeholder="Entrer le montant" />
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Méthode de Paiement</label>
                                                    <select class="form-select" id="paymentMethodSelect">
                                                        <option value="">-- Sélectionner la Méthode --</option>
                                                        @foreach (var method in Model.PaymentMethods)
                                                        {
                                                            <option value="@method.Value">@method.Text</option>
                                                        }
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Notes (Optionnel)</label>
                                                    <input type="text" class="form-control" id="paymentNotes"
                                                           placeholder="Référence ou notes de paiement" />
                                                </div>
                                                <div class="col-md-2 d-flex align-items-end">
                                                    <button type="button" class="btn btn-success w-100" id="recordPaymentBtn">
                                                        <i class="ti ti-check me-1"></i>Enregistrer
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="mt-3" id="paymentStatusAlert" style="display: none;">
                                                <!-- Les messages de statut de paiement apparaîtront ici -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                            <div class="col-lg-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="fw-semibold mb-3 border-bottom pb-2">Résumé de la Facture</h6>
                                        <div class="d-flex align-items-center justify-content-between mb-2">
                                            <h6 class="fs-14 fw-normal text-dark">Sous-total</h6>
                                            <h6 class="fs-14 fw-semibold text-dark" id="subTotalDisplay">
                                                @currency.Symbol@Model.Invoice.SubTotal.ToString("N2")
                                            </h6>
                                            <input type="hidden" asp-for="Invoice.SubTotal" id="subTotalInput" />
                                        </div>
                                        <div class="d-flex align-items-center justify-content-between mb-2">
                                            <label asp-for="Invoice.Tax" class="fs-14 fw-normal text-dark">Taxe</label>
                                            <input asp-for="Invoice.Tax" type="number" step="0.01"
                                                   class="form-control w-auto text-end"
                                                   style="max-width: 100px;"
                                                   id="taxInput" />
                                        </div>
                                        <div class="d-flex align-items-center justify-content-between mb-2">
                                            <label asp-for="Invoice.Discount" class="fs-14 fw-normal text-dark">Remise</label>
                                            <input asp-for="Invoice.Discount" type="number" step="0.01"
                                                   class="form-control w-auto text-end"
                                                   style="max-width: 100px;"
                                                   id="discountInput" />
                                        </div>

                                        <div class="d-flex align-items-center justify-content-between mb-2 pt-2 border-top">
                                            <h6 class="fs-16 fw-bold">Total</h6>
                                            <h6 class="fs-16 fw-bold" id="totalDisplay">
                                                @currency.Symbol@Model.Invoice.Total.ToString("N2")
                                            </h6>
                                            <input type="hidden" asp-for="Invoice.Total" id="totalInput" />
                                        </div>

                                        <!-- Montant Payé & Dû -->
                                        <div class="d-flex align-items-center justify-content-between mb-1">
                                            <small class="text-muted">Montant Payé</small>
                                            <small class="text-muted" id="amountPaidDisplay">
                                                @currency.Symbol@Model.Invoice.AmountPaid.ToString("N2")
                                            </small>
                                            <input type="hidden" asp-for="Invoice.AmountPaid" id="amountPaidInput" />
                                        </div>
                                        <div class="d-flex align-items-center justify-content-between">
                                            <small class="text-muted">Montant Dû</small>
                                            <small class="fw-semibold text-primary" id="amountDueDisplay">
                                                @currency.Symbol@Model.Invoice.AmountDue.ToString("N2")
                                            </small>
                                            <input type="hidden" asp-for="Invoice.AmountDue" id="amountDueInput" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="card-footer">
                    <div class="d-flex gap-2 align-items-center justify-content-end mb-0">
                        <a asp-action="Index"
                           class="btn btn-md bg-light text-dark fs-13 fw-medium rounded">Annuler</a>

                        @if (isAutoGenerated)
                        {
                            <div class="dropdown">
                                <button class="btn btn-md btn-primary fs-13 fw-medium rounded dropdown-toggle"
                                        type="button" data-bs-toggle="dropdown">
                                    <i class="ti ti-edit me-1"></i>Mettre à Jour
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <button type="submit" form="invoiceForm"
                                                class="dropdown-item d-flex align-items-center">
                                            <i class="ti ti-check me-2"></i>Sauvegarder
                                        </button>
                                    </li>
                                    <li>
                                        <a href="/Appointment/Details/@Model.Invoice.AppointmentId"
                                           class="dropdown-item d-flex align-items-center">
                                            <i class="ti ti-external-link me-2"></i>Voir le Rendez-vous
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        }
                        else
                        {
                            <button type="submit" form="invoiceForm"
                                    class="btn btn-md btn-primary fs-13 fw-medium rounded">
                                <i class="ti ti-check me-1"></i>Sauvegarder la Facture
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .invoice-type-badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }

    .auto-generated-badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }

    .invoices-list .item-name {
        min-width: 200px;
    }

    .invoices-list .item-description,
    .invoices-list .item-unit-Cost,
    .invoices-list .item-quantity {
        min-width: 100px;
    }

    .select2-container .select2-selection--single {
        min-width: 200px;
    }

    .bg-light {
        background-color: #f8f9fa !important;
    }
</style>

@section Scripts {
    <script>
        $(function () {
            let idx = @((Model.Invoice.Items?.Count ?? 0));
            const isAuto = @(isAutoGenerated.ToString().ToLower());
            const currSym = '@currency.Symbol';

            /* ---------- Gestionnaire d'ajout de ligne unique ---------- */
            $(document).off('click', '.add-invoices');
            $(document).on('click', '.add-invoices', function (e) {
                e.preventDefault();
                console.log('Bouton Ajouter cliqué');
                addRow();
            });

            /* ---------- Supprimer une ligne ---------- */
            $(document).on('click', '.remove-invoices', function () {
                if (isAuto) {
                    alert('Impossible de supprimer des articles d\'une facture auto-générée');
                    return;
                }
                $(this).closest('tr').remove();
                recalc();
            });

            /* ---------- Type changé ---------- */
            $(document).on('change', '.item-type-select', function () {
                const $row = $(this).closest('tr');
                const type = $(this).val();
                const index = $(this).data('index');

                // Effacer les champs précédents
                $row.find('.item-name-controls').empty();
                $row.find('.item-unitprice, .item-description, .js-item-display').val('');
                recalc($row);  // Recalculer le total de ligne

                if (!type) return;

                if (type === 'Consultation' || type === 'Test') {
                    // Pour les types texte libre (Consultation, Test)
                    const placeholder = type === 'Consultation' ? 'Consultation avec' : 'Nom du test';
                    $row.find('.item-name-controls').html(`<input type="text" class="form-control" placeholder="${placeholder}" />`);
                    return;
                }

                // Gérer les types avec menu déroulant comme Traitement, Inventaire, Médicament
                const url = type === 'Inventory' ? '/Invoice/GetInventoryList'
                              : type === 'Medication' ? '/Invoice/GetInventoryList'
                              : '/Invoice/GetTreatmentList';

                $.getJSON(url, data => {
                    let options = `<select class="form-control item-name-select"><option value="">-- Sélectionner ${type} --</option>`;
                    $.each(data, (k, v) => {
                        options += `<option value="${v.id}" data-price="${v.unitPrice}" data-desc="${v.description || ''}">${v.name}</option>`;
                    });
                    options += '</select>';
                    $row.find('.item-name-controls').html(options);
                    $row.find('.item-name-select').select2({ width: '100%', dropdownParent: $row });
                });
            });

            $(document).on('change', '.item-name-select', function () {
                const $row = $(this).closest('tr');
                const $option = $(this).find('option:selected');
                const type = $row.find('.item-type-select').val();

                // Mettre à jour la valeur d'affichage
                $row.find('.js-item-display').val($option.text());

                // Définir les valeurs des champs cachés selon le type d'article
                $row.find('[name$="InventoryItemId"]').val(type === 'Inventory' ? $option.val() : '');
                $row.find('[name$="TreatmentId"]').val(type === 'Treatment' ? $option.val() : '');
                $row.find('[name$="LabTestId"]').val(type === 'Test' ? $option.val() : '');
                $row.find('[name$="MedicationsId"]').val(type === 'Medication' ? $option.val() : '');

                // Définir le prix et la description
                $row.find('.item-unitprice').val($option.data('price') || 0);
                $row.find('.item-description').val($option.data('desc') || '');

                recalc($row); // Recalculer les totaux
            });

            /* ---------- Gestionnaire de saisie texte libre ---------- */
            $(document).on('input', '.item-name-controls input[type="text"]', function () {
                const $row = $(this).closest('tr');
                $row.find('.js-item-display').val($(this).val());
            });

            /* ---------- Qté / Prix ---------- */
            $(document).on('input', '.item-qty, .item-unitprice', function () {
                recalc($(this).closest('tr'));
            });

            $(document).on('input', '#taxInput, #discountInput, #amountPaidInput', recalc);

            /* ---------- Helpers de calcul ---------- */
            function recalc($row) {
                if ($row && $row.length) {
                    const q = parseFloat($row.find('.item-qty').val()) || 0;
                    const p = parseFloat($row.find('.item-unitprice').val()) || 0;
                    $row.find('.item-linetotal').val((q * p).toFixed(2));
                }

                let sub = 0;
                $('.item-linetotal').each(function () {
                    sub += parseFloat(this.value) || 0;
                });

                const tax = parseFloat($('#taxInput').val()) || 0;
                const dis = parseFloat($('#discountInput').val()) || 0;
                const paid = parseFloat($('#amountPaidInput').val()) || 0;
                const tot = sub + tax - dis;

                $('#subTotalDisplay').text(currSym + sub.toFixed(2));
                $('#totalDisplay').text(currSym + tot.toFixed(2));
                $('#amountDueDisplay').text(currSym + (tot - paid).toFixed(2));
                $('#subTotalInput').val(sub.toFixed(2));
                $('#totalInput').val(tot.toFixed(2));
                $('#amountDueInput').val((tot - paid).toFixed(2));
                updatePaymentMaxAmount();
            }

            /* ---------- HTML nouvelle ligne ---------- */
            function addRow() {
                const html = `
                    <tr class="invoices-list-item" data-index="${idx}">
                        <td>
                            <select name="Invoice.Items[${idx}].ItemType" class="form-control item-type-select" data-index="${idx}">
                                <option value="Inventory">Médicament</option>
                                <option value="Treatment">Traitement</option>
                                <option value="Test">Test de Laboratoire</option>
                            </select>
                        </td>
                        <td class="item-name-cell">
                            <div class="item-name-controls"></div>

                            <!-- Champs cachés -->
                            <input type="hidden" name="Invoice.Items[${idx}].AppointmentWIth" />
                            <input type="hidden" name="Invoice.Items[${idx}].TreatmentName" />
                            <input type="hidden" name="Invoice.Items[${idx}].TestName" />
                            <input type="hidden" name="Invoice.Items[${idx}].MedicationsName" />
                            <input type="hidden" name="Invoice.Items[${idx}].InventoryItemId" />
                            <input type="hidden" name="Invoice.Items[${idx}].TreatmentId" />
                            <input type="hidden" name="Invoice.Items[${idx}].MedicationsId" />
                        </td>
                        <td><input name="Invoice.Items[${idx}].Description" class="form-control item-description" /></td>
                        <td><input name="Invoice.Items[${idx}].UnitPrice" class="form-control item-unitprice" step="0.01" /></td>
                        <td><input name="Invoice.Items[${idx}].Quantity" class="form-control item-qty" value="1" /></td>
                        <td><input type="text" class="form-control item-linetotal" readonly value="0" /></td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-invoices">
                                <i class="ti ti-trash"></i>
                            </button>
                        </td>
                    </tr>`;
                $('.invoices-list').append(html);
                idx++;
            }

            /* ---------- Soumission AJAX du Formulaire ---------- */
            $('#invoiceForm').on('submit', function (e) {
                e.preventDefault();

                const $form = $(this);
                const $submitBtn = $('button[type="submit"]');
                const originalText = $submitBtn.html();

                // Afficher l'état de chargement
                $submitBtn.prop('disabled', true).html('<i class="ti ti-loader me-1"></i>Traitement...');

                // Mettre à jour les noms d'affichage avant soumission
                updateDisplayNames();

                // Sérialiser les données du formulaire
                const formData = new FormData($form[0]);

                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            window.location.href = response.redirectUrl;
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Erreur !',
                                html: response.message + (response.errors ? '<br><small>' + response.errors.join('<br>') + '</small>' : '')
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Requête Échouée !',
                            text: 'Une erreur est survenue lors de la sauvegarde de la facture : ' + error
                        });
                    },
                    complete: function() {
                        $submitBtn.prop('disabled', false).html(originalText);
                    }
                });
            });

            function updateDisplayNames() {
                $('.invoices-list-item').each(function () {
                    const $row = $(this);
                    const type = $row.find('.item-type-select').val();

                    // Obtenir la valeur d'affichage depuis la source appropriée
                    let displayValue = '';

                    if (type === 'Consultation' || type === 'Test' || type === 'Treatment') {
                        // Pour les types texte libre, obtenir depuis le champ de saisie
                        displayValue = $row.find('.item-name-controls input[type="text"]').val() || '';
                    } else {
                        // Pour les types menu déroulant, obtenir depuis le texte de l'option sélectionnée
                        displayValue = $row.find('.item-name-controls select option:selected').text() || '';
                    }

                    console.log('Type:', type, 'Valeur d\'affichage:', displayValue); // Log de débogage

                    // Mapper vers le champ approprié selon le type d'article
                    switch (type) {
                        case 'Consultation':
                            $row.find('[name$="AppointmentWIth"]').val(displayValue);
                            console.log('Définition AppointmentWIth:', displayValue);
                            break;
                        case 'Treatment':
                            $row.find('[name$="TreatmentName"]').val(displayValue);
                            console.log('Définition TreatmentName:', displayValue);
                            break;
                        case 'Test':
                            $row.find('[name$="TestName"]').val(displayValue);
                            console.log('Définition TestName:', displayValue);
                            break;
                        case 'Medication':
                        case 'Inventory':
                            $row.find('[name$="MedicationsName"]').val(displayValue);
                            console.log('Définition MedicationsName:', displayValue);
                            break;
                    }
                });
            }

            /* ---------- Enregistrement de Paiement ---------- */
            $('#recordPaymentBtn').on('click', function () {
                const amount = parseFloat($('#paymentAmount').val()) || 0;
                const methodId = $('#paymentMethodSelect').val();
                const notes = $('#paymentNotes').val();
                const invoiceId = @Model.Invoice.Id; // C'est 0 pour les nouvelles factures !

                // Obtenir le montant dû ACTUEL
                const amountDueText = $('#amountDueDisplay').text().replace(/[^0-9.-]+/g, "");
                const currentAmountDue = parseFloat(amountDueText) || 0;

                if (!amount || amount <= 0) {
                    showPaymentAlert('Veuillez entrer un montant de paiement valide', 'danger');
                    return;
                }

                if (!methodId) {
                    showPaymentAlert('Veuillez sélectionner une méthode de paiement', 'danger');
                    return;
                }

                if (amount > currentAmountDue) {
                    showPaymentAlert(`Le montant du paiement (${amount}) ne peut pas dépasser le montant dû (${currentAmountDue})`, 'danger');
                    return;
                }

                const $btn = $(this);
                const originalText = $btn.html();
                $btn.prop('disabled', true).html('<i class="ti ti-loader me-1"></i>Traitement...');

                // **Pour les NOUVELLES factures (ID = 0), sauvegarder d'abord la facture, puis enregistrer le paiement**
                if (invoiceId === 0) {
                    saveInvoiceAndThenRecordPayment(amount, methodId, notes);
                } else {
                    // **Pour les factures EXISTANTES, enregistrer le paiement directement**
                    recordPaymentDirectly(invoiceId, amount, methodId, notes);
                }
            });

            function saveInvoiceAndThenRecordPayment(amount, methodId, notes) {
                // D'abord sauvegarder la facture via soumission du formulaire
                const $form = $('#invoiceForm');
                const formData = new FormData($form[0]);

                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            // Facture sauvegardée avec succès, maintenant enregistrer le paiement
                            const newInvoiceId = response.invoiceId || extractInvoiceIdFromRedirect(response.redirectUrl);
                            recordPaymentDirectly(newInvoiceId, amount, methodId, notes);
                        } else {
                            showPaymentAlert('Échec de la sauvegarde de la facture : ' + response.message, 'danger');
                            $('#recordPaymentBtn').prop('disabled', false).html('<i class="ti ti-check me-1"></i>Enregistrer');
                        }
                    },
                    error: function(xhr) {
                        showPaymentAlert('Erreur de sauvegarde de la facture : ' + xhr.responseText, 'danger');
                        $('#recordPaymentBtn').prop('disabled', false).html('<i class="ti ti-check me-1"></i>Enregistrer');
                    }
                });
            }

            function recordPaymentDirectly(invoiceId, amount, methodId, notes) {
                $.ajax({
                    url: '/Invoice/RecordPayment',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        invoiceId: invoiceId,
                        amount: amount,
                        paymentMethodId: parseInt(methodId),
                        notes: notes
                    }),
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        if (response.success) {
                            showPaymentAlert('Paiement enregistré avec succès !', 'success');
                            // Effacer le formulaire de paiement
                            $('#paymentAmount, #paymentNotes').val('');
                            $('#paymentMethodSelect').val('');

                            // Mettre à jour les montants de la facture
                            updateInvoiceAmountsAfterPayment(amount);

                            // Si c'était une nouvelle facture, rediriger vers la page de facture
                            if (@Model.Invoice.Id === 0) {
                                setTimeout(() => {
                                    window.location.href = '/Invoice/Upsert/' + invoiceId;
                                }, 1500);
                            }
                        } else {
                            showPaymentAlert(response.message, 'danger');
                        }
                    },
                    error: function (xhr) {
                        showPaymentAlert('Erreur d\'enregistrement du paiement : ' + xhr.responseText, 'danger');
                    },
                    complete: function () {
                        $('#recordPaymentBtn').prop('disabled', false).html('<i class="ti ti-check me-1"></i>Enregistrer');
                    }
                });
            }

            function extractInvoiceIdFromRedirect(redirectUrl) {
                // Extraire l'ID de facture depuis l'URL de redirection comme "/Invoice/Upsert/123"
                const match = redirectUrl.match(/\/Invoice\/Upsert\/(\d+)/);
                return match ? parseInt(match[1]) : 0;
            }

            // Fonction pour mettre à jour les montants de facture après paiement
            function updateInvoiceAmountsAfterPayment(paymentAmount) {
                const currentPaid = parseFloat($('#amountPaidInput').val()) || 0;
                const currentDue = parseFloat($('#amountDueInput').val()) || 0;

                const newPaid = currentPaid + paymentAmount;
                const newDue = currentDue - paymentAmount;

                // Mettre à jour les champs cachés
                $('#amountPaidInput').val(newPaid.toFixed(2));
                $('#amountDueInput').val(newDue.toFixed(2));

                // Mettre à jour les affichages
                $('#amountPaidDisplay').text(currSym + newPaid.toFixed(2));
                $('#amountDueDisplay').text(currSym + newDue.toFixed(2));

                // Mettre à jour le montant maximum de paiement
                updatePaymentMaxAmount();
            }

            function updatePaymentMaxAmount() {
                const amountDueText = $('#amountDueDisplay').text().replace(/[^0-9.-]+/g, "");
                const currentAmountDue = parseFloat(amountDueText) || 0;
                $('#paymentAmount').attr('max', currentAmountDue);
            }

            function showPaymentAlert(message, type) {
                const alertHtml = `
                    <div class="alert alert-${type} alert-dismissible fade show">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                $('#paymentStatusAlert').html(alertHtml).show();
            }

            // Mettre à jour le montant maximum de paiement quand les montants changent
            updatePaymentMaxAmount();

            /* ---------- Premier calcul ---------- */
            recalc();
        });
    </script>
}

@functions {
    /// <summary>
    /// Retourne la classe CSS appropriée pour les badges de type de facture
    /// </summary>
    /// <param name="type">Le type de facture</param>
    /// <returns>Chaîne de classe CSS pour le badge</returns>
    public string GetInvoiceTypeBadgeClass(InvoiceType type)
    {
        return type switch
        {
            InvoiceType.Appointment => "bg-primary",
            InvoiceType.Medication => "bg-success",
            InvoiceType.Combined => "bg-info",
            InvoiceType.Laboratory => "bg-warning",
            _ => "bg-secondary"
        };
    }
}