@* This file is based on the provided 'add-invoices.html' template
   and integrated with ASP.NET Core MVC for Invoice creation/editing. *@

@* This file is based on the provided 'add-invoices.html' template *@

@inject CMS.Services.ICurrencyService CurrencyService

@model CMS.ViewModels.InvoiceUpsertViewModel

@{
    ViewData["Title"] = Model.Invoice.Id == 0 ? "Add Invoice" : "Edit Invoice";
    var currencySymbol = await CurrencyService.GetCurrentCurrencySymbolAsync();
}

<div class="main-wrapper">
    <div class="page-wrapper m-0">
        <div class="content">

            <!-- Start Page Header -->
            <div class="d-flex align-items-sm-center flex-sm-row flex-column gap-2 mb-3">
                <div class="flex-grow-1">
                    <h6 class="fw-bold mb-0 d-flex align-items-center">
                        <a asp-action="Index"><i class="ti ti-chevron-left me-1 fs-14"></i>Invoices</a>
                    </h6>
                </div>
            </div>
            <!-- End Page Header -->

            <div class="card">
                <div class="card-header">
                    <h5 class="fw-bold m-0">@ViewData["Title"]</h5>
                </div>
                <div class="card-body">
                    <form asp-action="Upsert" method="post" id="invoiceForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="Invoice.Id" />
                        <input type="hidden" asp-for="Invoice.IsAppointmentInvoice" />
                        <input type="hidden" asp-for="Invoice.AppointmentId" />

                        <div class="row">
                            <!-- Customer Info Fields -->
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.CustomerName" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Patient Name <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input asp-for="Invoice.CustomerName" type="text" class="form-control" />
                                    </div>
                                    <span asp-validation-for="Invoice.CustomerName" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.CustomerEmail" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Email <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input asp-for="Invoice.CustomerEmail" type="email" class="form-control" />
                                    </div>
                                    <span asp-validation-for="Invoice.CustomerEmail" class="text-danger"></span>
                                </div>
                            </div>


                            @if (Model.IsAppointmentInvoice)
                            {
                                <!-- Doctor Selection Dropdown -->
                                <div class="col-lg-6 col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label mb-1 text-dark fs-14 fw-medium">
                                            Doctor <span class="text-danger">*</span>
                                        </label>
                                        <select asp-for="Invoice.DoctorId"
                                                asp-items="Model.Doctors"
                                                class="form-control"
                                                id="doctorDropdown">
                                            <option value="">Select Doctor</option>
                                        </select>
                                        <span asp-validation-for="Invoice.DoctorId" class="text-danger"></span>
                                    </div>
                                </div>

                                <!-- Service Type Selection -->
                                <div class="col-lg-6 col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label mb-1 text-dark fs-14 fw-medium">
                                            Service Type <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-control" id="serviceTypeDropdown">
                                            <option value="">Select Service Type</option>
                                            <option value="General">General Consultation</option>
                                            <option value="Specialist">Specialist Consultation</option>
                                            <option value="Emergency">Emergency Consultation</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Consultation Charges -->
                                <div class="col-lg-6 col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label mb-1 text-dark fs-14 fw-medium">
                                            Consultation Charges <span class="text-danger">*</span>
                                        </label>
                                        <input type="number"
                                               class="form-control"
                                               id="consultationFee"
                                               asp-for="Invoice.Items[0].UnitPrice"
                                               step="0.01"
                                               readonly />
                                    </div>
                                </div>

                                <!-- Hidden fields -->
                                <input type="hidden" asp-for="Invoice.Items[0].Id" />
                                <input type="hidden" asp-for="Invoice.Items[0].Description" id="serviceDescription" value="Consultation Fee" />
                                <input type="hidden" asp-for="Invoice.Items[0].Quantity" value="1" />
                            


                                <!-- Doctor Selection Dropdown for Appointment Invoices -->
                                @* <div class="col-lg-6 col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label mb-1 text-dark fs-14 fw-medium">
                                            Doctor <span class="text-danger">*</span>
                                        </label>
                                        <select asp-for="Invoice.DoctorId"
                                                asp-items="Model.Doctors"
                                                class="form-control"
                                                id="doctorDropdown">
                                            <option value="">Select Doctor</option>
                                        </select>
                                        <span asp-validation-for="Invoice.DoctorId" class="text-danger"></span>
                                    </div>
                                </div> *@
                            }
                            else
                            {
                                <!-- For Manual Invoice, display alert -->
                                @if (Model.Invoice != null && Model.Invoice.Id != 0)
                                {
                                <div class="col-lg-12">
                                    <div class="alert alert-info">
                                        This is a manually created invoice. You can add/edit item rows below.
                                    </div>
                                </div>
                                }
                            }

                            <!-- Date Fields -->
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.IssueDate" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Invoice Date <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-icon-end position-relative">
                                        <input asp-for="Invoice.IssueDate" class="form-control " />
                                    </div>
                                    <span asp-validation-for="Invoice.IssueDate" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.DueDate" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Due Date <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-icon-end position-relative">
                                        <input asp-for="Invoice.DueDate" class="form-control" />
                                    </div>
                                    <span asp-validation-for="Invoice.DueDate" class="text-danger"></span>
                                </div>
                            </div>

                            <!-- Address Fields -->
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.CustomerAddress" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Patient Address <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <textarea asp-for="Invoice.CustomerAddress" class="form-control" rows="4"></textarea>
                                    </div>
                                    <span asp-validation-for="Invoice.CustomerAddress" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Billing Address <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <textarea class="form-control" rows="4">@Model.Invoice.CustomerAddress</textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Method -->
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Payment Method <span class="text-danger">*</span>
                                    </label>
                                    <div class="dropdown">
                                        <a href="javascript:void(0);" class="dropdown-toggle form-control w-100 d-flex align-items-center justify-content-between"
                                           data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="true">
                                            Select
                                        </a>
                                        <ul class="dropdown-menu dropdown-menu-lg p-2 dropdown-employee w-100">
                                            <li>
                                                <label class="dropdown-item px-2 d-flex align-items-center rounded-1">
                                                    <input class="form-check-input m-0 me-2" type="checkbox">PayPal
                                                </label>
                                            </li>
                                            <li>
                                                <label class="dropdown-item px-2 d-flex align-items-center rounded-1">
                                                    <input class="form-check-input m-0 me-2" type="checkbox">Options Enhanced
                                                </label>
                                            </li>
                                            <li>
                                                <label class="dropdown-item px-2 d-flex align-items-center rounded-1">
                                                    <input class="form-check-input m-0 me-2" type="checkbox">Cheque
                                                </label>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Status -->
                            <div class="col-lg-6 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Invoice.Status" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Payment Status <span class="text-danger">*</span>
                                    </label>
                                    <div class="dropdown">
                                        <a href="javascript:void(0);" class="dropdown-toggle form-control w-100 d-flex align-items-center justify-content-between"
                                           data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="true" id="statusDropdown">
                                            @Model.Invoice.Status
                                        </a>
                                        <ul class="dropdown-menu dropdown-menu-lg p-2 dropdown-employee w-100">
                                            @foreach (var s in new[] { "Draft", "Pending", "Paid", "Overdue" })
                                            {
                                                <li>
                                                    <label class="dropdown-item px-2 d-flex align-items-center rounded-1">
                                                        <input class="form-check-input m-0 me-2 status-option"
                                                               type="radio"
                                                               name="Status"
                                                               value="@s"
                                                               @(Model.Invoice.Status == s ? "checked" : "") />@s
                                                    </label>
                                                </li>
                                            }
                                        </ul>
                                        <input type="hidden" asp-for="Invoice.Status" />
                                    </div>
                                    <span asp-validation-for="Invoice.Status" class="text-danger"></span>
                                </div>
                            </div>

                            <!-- Invoice Items Table -->
                            <div class="col-lg-12 col-md-12">
                                <div class="mb-3">
                                    <table class="table invoice-table border">
                                        <thead>
                                            <tr>
                                                <th>Item</th>
                                                <th>Description</th>
                                                <th>Unit Cost</th>
                                                <th>Qty</th>
                                                <th>Amount</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody class="invoices-list">
                                            @if (Model.Invoice.Items != null && Model.Invoice.Items.Any())
                                            {
                                                for (int i = 0; i < Model.Invoice.Items.Count; i++)
                                                {
                                                    <partial name="_InvoiceItemRow"
                                                             model="Model.Invoice.Items[i]"
                                                             view-data='new ViewDataDictionary(ViewData) {
                                                                                                                           { "Index", i },
                                                                                                                           { "InventoryItems", Model.InventoryItems }
                                                                                                                       }' />
                                                                                        }
                                            }
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="6">
                                                    <a href="javascript:void(0);"
                                                       class="btn add-invoices border-0 text-dark d-flex align-items-center fs-14">
                                                        <i class="ti ti-circle-plus text-primary me-1"></i> Add Invoice Item
                                                    </a>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>

                            <!-- Totals and Currency -->
                            <div class="col-lg-8 col-md-8"></div>
                            <div class="col-lg-4">
                                <div>
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <h6 class="fs-14 fw-normal text-dark">SubTotal</h6>
                                        <h6 class="fs-14 fw-semibold text-dark" id="subTotalDisplay">
                                                @currencySymbol@Model.Invoice.SubTotal.ToString("N2")
                                        </h6>
                                        <input type="hidden" asp-for="Invoice.SubTotal" id="subTotalInput" />
                                    </div>
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <label asp-for="Invoice.Tax" class="fs-14 fw-normal text-dark">Tax</label>
                                        <input asp-for="Invoice.Tax" type="number" step="0.01"
                                               class="form-control w-auto text-end"
                                               style="max-width: 100px;"
                                               id="taxInput" />
                                    </div>
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <label asp-for="Invoice.Discount" class="fs-14 fw-normal text-dark">Discount</label>
                                        <input asp-for="Invoice.Discount" type="number" step="0.01"
                                               class="form-control w-auto text-end"
                                               style="max-width: 100px;"
                                               id="discountInput" />
                                    </div>
                                   
                                    @* <div class="d-flex align-items-center justify-content-between border-bottom pb-3 mb-3">
                                        <h6 class="fs-14 fw-normal text-dark d-flex align-items-center">Currency</h6>
                                        <select id="currencySelect" name="CurrencyCode" class="form-control w-auto" style="max-width:100px;">
                                            <option value="">Loading...</option>
                                        </select>

                                    </div> *@
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <h6 class="fs-18 fw-bold">Total</h6>
                                        <h6 class="fs-18 fw-bold" id="totalDisplay">
                                            @currencySymbol@Model.Invoice.Total.ToString("N2")
                                        </h6>

                                        <input type="hidden" id="totalInvoiceAmount" class="currency-amount" asp-for="Invoice.Total" id="totalInput" />
                                    </div>
                                </div>
                            </div>

                            <!-- Notes -->
                            <div class="col-lg-12 col-md-12">
                                <div class="mb-3">
                                    <label asp-for="Invoice.Notes" class="form-label mb-1 text-dark fs-14 fw-medium">
                                        Other Information
                                    </label>
                                    <div class="input-group">
                                        <textarea asp-for="Invoice.Notes" rows="3" class="form-control"></textarea>
                                    </div>
                                    <span asp-validation-for="Invoice.Notes" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="card-footer">
                    <div class="d-flex gap-2 align-items-center justify-content-end mb-0">
                        <a asp-action="Index"
                           class="btn btn-md bg-light text-dark fs-13 fw-medium rounded">Cancel</a>
                        <button type="submit" form="invoiceForm"
                                class="btn btn-md btn-primary fs-13 fw-medium rounded">
                            Save Invoice
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* make the Item select a bit wider */
    .invoices-list .item-name {
        min-width: 200px;
    }

    /* make the Description, Unit Cost and Qty inputs a bit wider too */
    .invoices-list .item-description,
    .invoices-list .item-unit-price,
    .invoices-list .item-quantity {
        min-width: 100px;
    }

    /* if you need to adjust the Select2 container */
    .select2-container .select2-selection--single {
        min-width: 200px;
    }

</style>



@section Scripts {
        await Html.RenderPartialAsync("_ValidationScriptsPartial");

     
    <script>
        $(document).ready(function () {
            // --- START: REAL-TIME SETTINGS UPDATE ---
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/settingsHub") // This should match your Hub route
                .configureLogging(signalR.LogLevel.Information)
                .build();

            async function start() {
                try {
                    await connection.start();
                    console.log("SignalR Connected.");
                    // Join a group to receive settings updates
                    await connection.invoke("JoinGroup", "SettingsGroup");
                } catch (err) {
                    console.log(err);
                    setTimeout(start, 5000);
                }
            };

            connection.onclose(async () => {
                await start();
            });

            // Listen for the "SettingsUpdated" message from the server
            connection.on("SettingsUpdated", (settings) => {
                console.log("Settings updated:", settings);
                // Show a notification to the user and reload the page
                alert("System settings have been updated. The page will now reload to apply changes.");
                location.reload();
            });

            // Start the connection
            start();
            // --- END: REAL-TIME SETTINGS UPDATE ---

             $(document).ready(function () {
            // Define the currency symbol for JavaScript to use
            const currencySymbol = '@Html.Raw(currencySymbol)';

            let itemIndex = @(Model.Invoice.Items?.Count ?? 0);
            let inventoryItems = [];

            // 1) Fetch active inventory items once
            function loadInventoryItems() {
                return $.ajax({
                    url: '/Inventory/GetActiveItems',
                    method: 'GET',
                    dataType: 'json',
                    success: data => inventoryItems = data
                });
            }

            // 2) Build <option> markup
            function buildItemOptions() {
                let opts = '<option value="">Select Item</option>';
                inventoryItems.forEach(item => {
                    opts +=
                        `<option value="${item.id}"
                                 data-price="${item.unitPrice}"
                                 data-description="${item.description}"
                                 data-stock="${item.stock}">
                           ${item.name} (Stock: ${item.stock})
                         </option>`;
                });
                return opts;
            }

            // 3) When user changes select, fill price & description & recalc
            $(document).on('change', '.item-name', function () {
                const $sel = $(this);
                const $opt = $sel.find('option:selected');
                const $row = $sel.closest('tr');
                const price  = parseFloat($opt.data('price'))  || 0;
                const desc   = $opt.data('description')       || '';
                const stock  = parseInt($opt.data('stock'),10) || 0;

                $row.find('.item-inventory-id').val($opt.val());
                $row.find('.item-unit-price').val(price.toFixed(2)).trigger('input');
                $row.find('.item-description').val(desc);
                $row.find('.item-quantity')
                    .val(stock > 0 ? 1 : 0)
                    .prop('disabled', stock <= 0)
                    .trigger('input');
                if (stock <= 0) alert(`"${$opt.text()}" is out of stock.`);
            });

            // 4) Add new row handler
            $(document).off('click', '.add-invoices').on('click', '.add-invoices', e => {
                e.preventDefault();
                const newRow = `
                <tr class="invoices-list-item">
                  <td>
                    <select name="Invoice.Items[${itemIndex}].InventoryItemId"
                            class="form-control select2 item-name"
                            data-toggle="select2">
                      ${buildItemOptions()}
                    </select>
                  </td>
                  <td><input type="text" name="Invoice.Items[${itemIndex}].Description" class="form-control item-description" /></td>
                  <td><input type="number" name="Invoice.Items[${itemIndex}].UnitPrice" step="0.01" class="form-control item-unit-price" readonly /></td>
                  <td><input type="number" name="Invoice.Items[${itemIndex}].Quantity" class="form-control item-quantity" /></td>
                  <td><input type="text" class="form-control item-line-total" readonly value="0.00" /></td>
                  <td><button type="button" class="btn remove-invoices btn-sm border shadow-sm"><i class="ti ti-trash"></i></button></td>
                </tr>`;
                $('.invoices-list').append(newRow);
                itemIndex++;
            });

            // 5) Remove row
            $(document).on('click', '.remove-invoices', function () {
                $(this).closest('tr').remove();
                calculateOverallTotals();
            });

            // 7) Totals calculation - UPDATED
            function calculateOverallTotals() {
                let sub = 0;
                $('.item-line-total').each(function () {
                    sub += parseFloat($(this).val()) || 0;
                });
                const tax      = parseFloat($('#taxInput').val())      || 0;
                const discount = parseFloat($('#discountInput').val()) || 0;
                const tot      = sub + tax - discount;

                // Use the dynamic currency symbol here
                $('#subTotalDisplay').text(currencySymbol + sub.toFixed(2));
                $('#subTotalInput').val(sub.toFixed(2));
                $('#totalDisplay').text(currencySymbol + tot.toFixed(2));
                $('#totalInput').val(tot.toFixed(2));
            }
            $(document).on('input', '.item-quantity, .item-unit-price', function () {
                calculateLineTotal($(this).closest('tr'));
            });
            $(document).on('input', '#taxInput, #discountInput', calculateOverallTotals);

            function calculateLineTotal($row) {
                const qty   = parseFloat($row.find('.item-quantity').val())  || 0;
                const price = parseFloat($row.find('.item-unit-price').val())|| 0;
                $row.find('.item-line-total').val((qty * price).toFixed(2));
                calculateOverallTotals();
            }

            // 8) Status dropdown text sync
            $('.status-option').on('change', function () {
                if (this.checked) $('#statusDropdown').text(this.value);
            });

            // Initial load & setup
            loadInventoryItems().then(() => {
                $('.item-name').each(function () {
                    $(this).html(buildItemOptions());
                });
                calculateOverallTotals(); // Initial calculation on page load
            });

            // --- Consultation Fee Logic ---
            var doctorCharges = @Html.Raw(Json.Serialize(Model.ConsultationCharge));

            $('#doctorDropdown').on('change', function() {
                var selectedDoctorId = parseInt($(this).val());
                updateServiceTypes(selectedDoctorId);
                updateConsultationFee();
            });

            $('#serviceTypeDropdown').on('change', function() {
                updateConsultationFee();
            });

            function updateServiceTypes(doctorId) {
                var serviceDropdown = $('#serviceTypeDropdown');
                serviceDropdown.empty().append('<option value="">Select Service Type</option>');

                if (doctorId && doctorCharges[doctorId]) {
                    var charges = doctorCharges[doctorId];
                    for (var serviceType in charges) {
                        serviceDropdown.append(
                            '<option value="' + serviceType + '">' +
                            serviceType + ' Consultation</option>'
                        );
                    }
                }
            }

            function updateConsultationFee() {
                var selectedDoctorId = parseInt($('#doctorDropdown').val());
                var selectedServiceType = $('#serviceTypeDropdown').val();

                if (selectedDoctorId && selectedServiceType &&
                    doctorCharges[selectedDoctorId] &&
                    doctorCharges[selectedDoctorId][selectedServiceType]) {

                    var fee = doctorCharges[selectedDoctorId][selectedServiceType];
                    $('#consultationFee').val(fee);
                    $('#serviceDescription').val(selectedServiceType + ' Consultation Fee');
                } else {
                    $('#consultationFee').val(0);
                    $('#serviceDescription').val('Consultation Fee');
                }
            }

            // Set initial values for editing
            var initialDoctorId = parseInt($('#doctorDropdown').val());
            if (initialDoctorId) {
                updateServiceTypes(initialDoctorId);
                $('#serviceTypeDropdown').val('General');
                updateConsultationFee();
            }
        });
            // ... all your other existing $(document).ready() code follows ...
            // (e.g., const currencySymbol = '@Html.Raw(currencySymbol)'; let itemIndex = ... etc.)
        });
    </script>
    <!-- Datepicker JS -->

   
}


@* @section Scripts {
        await Html.RenderPartialAsync("_ValidationScriptsPartial");

    <!-- Datepicker JS -->
    <script src="~/assets/js/moment.min.js"></script>

    <script>
        $(document).ready(function () {
            let itemIndex = @(Model.Invoice.Items?.Count ?? 0);
            let inventoryItems = [];

            // 1) Fetch active inventory items once
            function loadInventoryItems() {
                return $.ajax({
                    url: '/Inventory/GetActiveItems',
                    method: 'GET',
                    dataType: 'json',
                    success: data => inventoryItems = data
                });
            }

            // 2) Build <option> markup (includes data-price, data-description, data-stock)
            function buildItemOptions() {
                let opts = '<option value="">Select Item</option>';
                inventoryItems.forEach(item => {
                    opts +=
                        `<option value="${item.id}"
                                 data-price="${item.unitPrice}"
                                 data-description="${item.description}"
                                 data-stock="${item.stock}">
                           ${item.name} (Stock: ${item.stock})
                         </option>`;
                });
                return opts;
            }

            // Load currencies from DB
            function loadCurrencies() {
                $.getJSON('/Currency/GetAllCurrencies', function(data) {
                    let html = '<option value="">Select Currency</option>';
                    if (data && data.length) {
                        data.forEach(c => {
                            html += `<option value="${c.code}" data-symbol="${c.symbol}">${c.name}</option>`;
                        });
                        $('#currencySelect').html(html);
                    } else {
                        $('#currencySelect').html('<option value="">No currencies available</option>');
                    }
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.error('Error loading currencies:', errorThrown);
                    $('#currencySelect').html('<option value="">Error loading currencies</option>');
                });
            }

            loadCurrencies();

            // This function will update the total display when the currency is selected
            $(document).on('change', '#currencySelect', function() {
                const selectedCurrency = $('#currencySelect option:selected');
                const symbol = selectedCurrency.data('symbol'); // Get the symbol of the selected currency
                const totalAmount = parseFloat($('#totalInput').val()) || 0; // Get the total amount from the hidden field

                // Format the total value with the selected symbol
                if (totalAmount) {
                    $('#totalDisplay').text(symbol + totalAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                } else {
                    $('#totalDisplay').text(symbol + "0.00"); // Default to 0 if no total is set
                }
            });

            // Call the change handler on page load to set the default value
            $(document).ready(function() {
                $('#currencySelect').trigger('change');
            });

            // 3) When user changes select, fill price & description & recalc
            $(document).on('change', '.item-name', function () {
                const $sel = $(this);
                const $opt = $sel.find('option:selected');
                const $row = $sel.closest('tr');
                const price  = parseFloat($opt.data('price'))  || 0;
                const desc   = $opt.data('description')       || '';
                const stock  = parseInt($opt.data('stock'),10) || 0;

                $row.find('.item-inventory-id').val($opt.val());
                $row.find('.item-unit-price').val(price.toFixed(2)).trigger('input');
                $row.find('.item-description').val(desc);
                $row.find('.item-quantity')
                    .val(stock > 0 ? 1 : 0)
                    .prop('disabled', stock <= 0)
                    .trigger('input');
                if (stock <= 0) alert(`"${$opt.text()}" is out of stock.`);
            });

            // 4) Add new row handler
            $(document).off('click', '.add-invoices').on('click', '.add-invoices', e => {
                e.preventDefault();
                const newRow = `
                <tr class="invoices-list-item">
                  <td>
                    <select name="Invoice.Items[${itemIndex}].InventoryItemId"
                            class="form-control select2 item-name"
                            data-toggle="select2">
                      ${buildItemOptions()}
                    </select>
                  </td>
                  <td>
                    <input type="text" name="Invoice.Items[${itemIndex}].Description"
                           class="form-control item-description" />
                  </td>
                  <td>
                    <input type="number" name="Invoice.Items[${itemIndex}].UnitPrice"
                           step="0.01" class="form-control item-unit-price" readonly />
                  </td>
                  <td>
                    <input type="number" name="Invoice.Items[${itemIndex}].Quantity"
                           class="form-control item-quantity" />
                  </td>
                  <td>
                    <input type="text" class="form-control item-line-total"
                           readonly value="0.00" />
                  </td>
                  <td>
                    <button type="button" class="btn remove-invoices btn-sm border shadow-sm">
                      <i class="ti ti-trash"></i>
                    </button>
                  </td>
                </tr>`;
                $('.invoices-list').append(newRow);
                itemIndex++;
            });

            // 5) Remove row
            $(document).on('click', '.remove-invoices', function () {
                $(this).closest('tr').remove();
                calculateOverallTotals();
            });

            // 7) Totals calculation
            function calculateLineTotal($row) {
                const qty   = parseFloat($row.find('.item-quantity').val())  || 0;
                const price = parseFloat($row.find('.item-unit-price').val())|| 0;
                $row.find('.item-line-total').val((qty * price).toFixed(2));
                calculateOverallTotals();
            }
            function calculateOverallTotals() {
                let sub = 0;
                $('.item-line-total').each(function () {
                    sub += parseFloat($(this).val()) || 0;
                });
                const tax      = parseFloat($('#taxInput').val())      || 0;
                const discount = parseFloat($('#discountInput').val()) || 0;
                const tot      = sub + tax - discount;
                $('#subTotalDisplay').text('$' + sub.toFixed(2));
                $('#subTotalInput').val(sub.toFixed(2));
                $('#totalDisplay').text('$' + tot.toFixed(2));
                $('#totalInput').val(tot.toFixed(2));
            }
            $(document).on('input', '.item-quantity, .item-unit-price', function () {
                calculateLineTotal($(this).closest('tr'));
            });
            $(document).on('input', '#taxInput, #discountInput', calculateOverallTotals);

            // 8) Status dropdown text sync
            $('.status-option').on('change', function () {
                if (this.checked) $('#statusDropdown').text(this.value);
            });

            // Initial load & setup
            loadInventoryItems().then(() => {
                $('.item-name').each(function () {
                    $(this).html(buildItemOptions());
                });
                calculateOverallTotals();
            });
        });




        $(document).ready(function() {
            // Get doctor consultation charges from ViewModel
            var doctorCharges = @Html.Raw(Json.Serialize(Model.ConsultationCharge));
            
            // Handle doctor dropdown change
            $('#doctorDropdown').on('change', function() {
                var selectedDoctorId = parseInt($(this).val());
                updateServiceTypes(selectedDoctorId);
                updateConsultationFee();
            });

            // Handle service type dropdown change
            $('#serviceTypeDropdown').on('change', function() {
                updateConsultationFee();
            });

            function updateServiceTypes(doctorId) {
                var serviceDropdown = $('#serviceTypeDropdown');
                serviceDropdown.empty().append('<option value="">Select Service Type</option>');
                
                if (doctorId && doctorCharges[doctorId]) {
                    var charges = doctorCharges[doctorId];
                    for (var serviceType in charges) {
                        serviceDropdown.append(
                            '<option value="' + serviceType + '">' + 
                            serviceType + ' Consultation</option>'
                        );
                    }
                }
            }



                // Assuming you have a server-side route that fetches current currency details
        function loadCurrentCurrency() {
            $.get('/Invoice/GetCurrentCurrency', function(currency) {
                // Assuming currency contains both symbol and code
                let currencySymbol = currency.symbol || '$';  // Default to '$' if not found
                let currencyCode = currency.code || 'USD';  // Default to 'USD' if not found

                // Update the currency symbol and code in the UI
                $('#currencyCode').text(currencyCode); // Update the currency code display
                $('#currencySymbol').text(currencySymbol); // Update the currency symbol

                updateAllCurrencyDisplays(currencySymbol);
            });
        }

        // Call this function on page load to update currency
        loadCurrentCurrency();

        function updateAllCurrencyDisplays(symbol) {
            // Update all elements on the page that display currency
            const elements = ['#totalInvoiceAmount', '#subTotalDisplay', '#totalDisplay'];
            elements.forEach(selector => {
                const currentAmount = parseFloat($(selector).text().replace(/[^0-9.-]+/g, "")); // Parse the current value
                const formattedAmount = formatCurrency(currentAmount, symbol);
                $(selector).text(formattedAmount);
            });
        }

        function formatCurrency(value, symbol) {
            return symbol + value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }


                function updateTotalAmount(amount) {
            $('#totalInvoiceAmount').text(formatCurrency(amount));
        }



            function updateConsultationFee() {
                var selectedDoctorId = parseInt($('#doctorDropdown').val());
                var selectedServiceType = $('#serviceTypeDropdown').val();
                
                if (selectedDoctorId && selectedServiceType && 
                    doctorCharges[selectedDoctorId] && 
                    doctorCharges[selectedDoctorId][selectedServiceType]) {
                    
                    var fee = doctorCharges[selectedDoctorId][selectedServiceType];
                    $('#consultationFee').val(fee);
                    $('#serviceDescription').val(selectedServiceType + ' Consultation Fee');
                } else {
                    $('#consultationFee').val(0);
                    $('#serviceDescription').val('Consultation Fee');
                }
            }

            // Set initial values for editing
            var initialDoctorId = parseInt($('#doctorDropdown').val());
            if (initialDoctorId) {
                updateServiceTypes(initialDoctorId);
                // Set default service type (you can customize this logic)
                $('#serviceTypeDropdown').val('General');
                updateConsultationFee();
            }
        });
  




    </script>
} *@
