@* @model CMS.Models.InvoiceItem
@{
    var index = ViewData["Index"] as int? ?? 0;
    var invItems = ViewData["InventoryItems"] as List<InventoryItem> ?? new List<InventoryItem>();
    var treatments = ViewData["Treatments"] as List<SelectListItem> ?? new List<SelectListItem>();
    var isAuto = ViewData["IsAutoGenerated"] as bool? ?? false;
    ViewData.TemplateInfo.HtmlFieldPrefix = $"Invoice.Items[{index}]";
}

<tr class="invoices-list-item" data-index="@index">
  
    <td>
        @if (isAuto)
        {
            <input type="text" class="form-control" value="@Model.ItemType" readonly />
            <input type="hidden" asp-for="ItemType" />
        }
        else
        {
            <select asp-for="ItemType" class="form-control item-type-select" data-index="@index">
               
                <option value="Inventory" selected="@(Model.ItemType == "Inventory" ? "selected" : null)">Medication</option>
                <option value="Treatment" selected="@(Model.ItemType == "Treatment" ? "selected" : null)">Treatment</option>
                <option value="Test" selected="@(Model.ItemType == "Test" ? "selected" : null)">Laboratory Test</option>
            </select>
        }
    </td>

    <!-- 2. Item Name (based on type - dropdown for Inventory, Medication, Treatment; text for Test) -->
    <td class="item-name-cell">
        @if (isAuto)
        {
            <input type="text" class="form-control" value="@Model.DisplayName" readonly />
            <input type="hidden" class="js-item-display" name="Invoice.Items[@index].ItemDisplayName" value="@Model.DisplayName" />
        }
        else
        {
            <div class="item-name-controls">
                @if (Model.ItemType == "Treatment")
                {
                    <select class="form-control item-name-select" data-index="@index">
                        <option value="">-- Select Treatment --</option>
                        @foreach (var treatment in treatments)
                        {
                            <option value="@treatment.Value" selected="@(Model.TreatmentId == int.Parse(treatment.Value) ? "selected" : null)">
                                @treatment.Text
                            </option>
                        }
                    </select>
                }
                else if (Model.ItemType == "Inventory")
                {
                    <select class="form-control item-name-select" data-index="@index">
                        <option value="">-- Select Inventory Item --</option>
                        @foreach (var item in invItems)
                        {
                            <option value="@item.Id" selected="@(Model.InventoryItemId == item.Id ? "selected" : null)">
                                @item.Name
                            </option>
                        }
                    </select>
                }
                else if (Model.ItemType == "Medication")
                {
                    <select class="form-control item-name-select" data-index="@index">
                        <option value="">-- Select Medication --</option>
                        @foreach (var item in invItems)
                        {
                            <option value="@item.Id" selected="@(Model.MedicationsId == item.Id ? "selected" : null)">
                                @item.Name
                            </option>
                        }
                    </select>
                }
                else if (Model.ItemType == "Test")
                {
                    <input type="text" class="form-control" value="@Model.TestName" />
                }
            </div>
        }
    </td>

    <!-- Remaining fields: Description, Unit Price, Quantity, Line Total -->
    <td>
        <input asp-for="Description" class="form-control item-description" />
    </td>

    <td>
        <input asp-for="UnitPrice" class="form-control item-unitprice" step="0.01" />
    </td>

    <td>
        <input asp-for="Quantity" class="form-control item-qty" value="1" />
    </td>

    <td>
        <input type="text" class="form-control item-linetotal" readonly value="@(Model.LineTotal)" />
    </td>

    <!-- 7. Remove Button -->
    <td>
        @if (!isAuto)
        {
            <button type="button" class="btn btn-sm btn-outline-danger remove-row">
                <i class="ti ti-trash"></i>
            </button>
        }
    </td>

    <!-- Hidden Fields for Item Associations -->
    <input type="hidden" asp-for="TreatmentName" />
    <input type="hidden" asp-for="AppointmentWIth" />
    <input type="hidden" asp-for="TestName" />
    <input type="hidden" asp-for="MedicationsName" />
    <input type="hidden" asp-for="InventoryItemId" />
    <input type="hidden" asp-for="TreatmentId" />
    <input type="hidden" asp-for="LabTestId" />
    <input type="hidden" asp-for="MedicationsId" />
</tr>

 *@

@model CMS.Models.InvoiceItem
@{
    var index = ViewData["Index"] as int? ?? 0;
    var invItems = ViewData["InventoryItems"] as List<InventoryItem> ?? new List<InventoryItem>();
    var treatments = ViewData["Treatments"] as List<SelectListItem> ?? new List<SelectListItem>();
    var isAuto = ViewData["IsAutoGenerated"] as bool? ?? false;
    ViewData.TemplateInfo.HtmlFieldPrefix = $"Invoice.Items[{index}]";
}

<tr class="invoices-list-item" data-index="@index">

    <td>
        @if (isAuto)
        {
            <input type="text" class="form-control" value="@Model.ItemType" readonly />
            <input type="hidden" asp-for="ItemType" />
        }
        else
        {
            <select asp-for="ItemType" class="form-control item-type-select" data-index="@index">
                <option value="Inventory" selected="@(Model.ItemType == "Inventory" ? "selected" : null)">Médicament</option>
                <option value="Treatment" selected="@(Model.ItemType == "Treatment" ? "selected" : null)">Traitement</option>
                <option value="Test" selected="@(Model.ItemType == "Test" ? "selected" : null)">Test de Laboratoire</option>
            </select>
        }
    </td>

    <!-- 2. Nom de l'Article (basé sur le type - menu déroulant pour Inventaire, Médicament, Traitement; texte pour Test) -->
    <td class="item-name-cell">
        @if (isAuto)
        {
            <input type="text" class="form-control" value="@Model.DisplayName" readonly />
            <input type="hidden" class="js-item-display" name="Invoice.Items[@index].ItemDisplayName" value="@Model.DisplayName" />
        }
        else
        {
            <div class="item-name-controls">
                @if (Model.ItemType == "Treatment")
                {
                    <select class="form-control item-name-select" data-index="@index">
                        <option value="">-- Sélectionner un Traitement --</option>
                        @foreach (var treatment in treatments)
                        {
                            <option value="@treatment.Value" selected="@(Model.TreatmentId == int.Parse(treatment.Value) ? "selected" : null)">
                                @treatment.Text
                            </option>
                        }
                    </select>
                }
                else if (Model.ItemType == "Inventory")
                {
                    <select class="form-control item-name-select" data-index="@index">
                        <option value="">-- Sélectionner un Article d'Inventaire --</option>
                        @foreach (var item in invItems)
                        {
                            <option value="@item.Id" selected="@(Model.InventoryItemId == item.Id ? "selected" : null)">
                                @item.Name
                            </option>
                        }
                    </select>
                }
                else if (Model.ItemType == "Medication")
                {
                    <select class="form-control item-name-select" data-index="@index">
                        <option value="">-- Sélectionner un Médicament --</option>
                        @foreach (var item in invItems)
                        {
                            <option value="@item.Id" selected="@(Model.MedicationsId == item.Id ? "selected" : null)">
                                @item.Name
                            </option>
                        }
                    </select>
                }
                else if (Model.ItemType == "Test")
                {
                    <input type="text" class="form-control" value="@Model.TestName" placeholder="Nom du test" />
                }
            </div>
        }
    </td>

    <!-- Champs restants : Description, Prix Unitaire, Quantité, Total Ligne -->
    <td>
        <input asp-for="Description" class="form-control item-description" placeholder="Description" />
    </td>

    <td>
        <input asp-for="UnitPrice" class="form-control item-unitprice" step="0.01" placeholder="Prix unitaire" />
    </td>

    <td>
        <input asp-for="Quantity" class="form-control item-qty" value="1" placeholder="Quantité" />
    </td>

    <td>
        <input type="text" class="form-control item-linetotal" readonly value="@(Model.LineTotal)" placeholder="Total" />
    </td>

    <!-- 7. Bouton Supprimer -->
    <td>
        @if (!isAuto)
        {
            <button type="button" class="btn btn-sm btn-outline-danger remove-row">
                <i class="ti ti-trash"></i>
            </button>
        }
    </td>

    <!-- Champs Cachés pour les Associations d'Articles -->
    <input type="hidden" asp-for="TreatmentName" />
    <input type="hidden" asp-for="AppointmentWIth" />
    <input type="hidden" asp-for="TestName" />
    <input type="hidden" asp-for="MedicationsName" />
    <input type="hidden" asp-for="InventoryItemId" />
    <input type="hidden" asp-for="TreatmentId" />
    <input type="hidden" asp-for="LabTestId" />
    <input type="hidden" asp-for="MedicationsId" />
</tr>