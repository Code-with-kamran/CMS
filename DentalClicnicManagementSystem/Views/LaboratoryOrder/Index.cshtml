@{
    ViewData["Title"] = "Laboratory Orders";
}
<form id="__af" method="post" style="display:none">
    @Html.AntiForgeryToken()
</form>
<div class="main-wrapper">
    <div class="page-wrapper m-0">
        <div class="content">
            <!-- Header -->
            <div class="d-flex align-items-sm-center flex-sm-row flex-column gap-2 mb-3">
                <div class="flex-grow-1">
                    <h4 class="fw-bold mb-0">Laboratory Orders</h4>
                </div>
                <div class="text-end">
                    <a asp-controller="LaboratoryOrder" asp-action="Upsert" class="btn btn-primary ms-2 fs-13 btn-md">
                        <i class="ti ti-plus me-1"></i>New Lab Order
                    </a>
                </div>
            </div>
            <!-- Card -->
            <div class="card">
                <div class="card-body">
                    <!-- External controls -->
                    <div class="row g-2 mb-3 align-items-center">
                        <div class="col-auto d-none d-sm-flex align-items-center">
                            <label class="me-2 mb-0">Show</label>
                            <select id="pageLength" class="form-select form-select-sm" style="min-width:90px">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span class="ms-2">entries</span>
                        </div>
                        <div class="col-12 col-sm ms-sm-auto" style="max-width:260px">
                            <input id="globalSearch" type="search" class="form-control form-control-sm" placeholder="Search Orders..." />
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="labOrderList" class="table table-hover align-middle w-100 nowrap" style="min-width: 900px;">
                            <thead class="table-light">
                                <tr>
                                    <th>Test Name</th>
                                    <th>Patient</th>
                                    <th>Order Date</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <!-- Footer -->
                    <div class="row align-items-center g-2 mt-2">
                        <div class="col-12 col-sm-6">
                            <div class="small text-muted" id="dt-info"></div>
                        </div>
                        <div class="col-12 col-sm-6 d-flex justify-content-sm-end">
                            <div id="dt-pager"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    #labOrderList thead th,
    #labOrderList tbody td {
        white-space: nowrap !important;
    }

    .table-responsive {
        overflow-x: auto;
    }
</style>

@section Scripts {
    <script>
        $(function () {
            const token = $('#__af input[name="__RequestVerificationToken"]').val();
            const esc = s => s == null ? '' : String(s);

            const statusBadges = {
                'Ordered': 'bg-primary',
                'SampleCollected': 'bg-info',
                'InProgress': 'bg-warning text-dark',
                'Completed': 'bg-success',
                'Cancelled': 'bg-danger'
            };

            const table = $('#labOrderList').DataTable({
                processing: true,
                serverSide: true,
                ajax: { url: '@Url.Action("GetLaboratoryOrderList", "LaboratoryOrder")', type: 'GET' },
                dom: 'rtip',
                paging: true,
                pagingType: 'simple_numbers',
                info: true,
                order: [[3, 'desc']],
                autoWidth: false,
                responsive: true,
                columns: [
                    { data: 'testName', orderable: true },
                    { data: 'patientName', orderable: true },
                    {
                        data: 'orderDate', orderable: true,
                        render: d => new Date(d).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })
                    },
                    {
                        data: 'price', orderable: true, className: 'text-end',
                        render: d => `$${parseFloat(d).toFixed(2)}`
                    },
                    {
                        data: 'status', orderable: true, className: 'text-center',
                        render: d => `<span class="badge ${statusBadges[d] || 'bg-secondary'}">${esc(d)}</span>`
                    },
                    {
                        data: null, orderable: false, className: 'text-center',
                        render: function (data, type, row) {
                            return `
                                <div class="dropdown d-inline-block">
                                    <a href="javascript:void(0);" class="shadow-sm fs-14 d-inline-flex border rounded-2 p-1" data-bs-toggle="dropdown">
                                        <i class="ti ti-dots-vertical"></i>
                                    </a>
                                    <ul class="dropdown-menu p-2 dropdown-menu-end">
                                        <li>
                                            <a href="/LaboratoryOrder/Upsert/${row.id}" class="dropdown-item d-flex align-items-center">
                                                <i class="ti ti-edit me-2"></i> Edit
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:void(0);" class="dropdown-item d-flex align-items-center js-delete"
                                               data-id="${row.id}" data-name="${esc(row.testName)}">
                                                <i class="ti ti-trash me-2"></i> Delete
                                            </a>
                                        </li>
                                    </ul>
                                </div>`;
                        }
                    }
                ],
                drawCallback: function () {
                    const api = this.api();
                    $('#dt-pager').empty().append($(api.table().container()).find('.dataTables_paginate'));
                    $('#dt-pager .paginate_button.previous .page-link').html('&lsaquo;');
                    $('#dt-pager .paginate_button.next .page-link').html('&rsaquo;');
                    const info = api.page.info();
                    const msg = info.recordsDisplay ? `Showing ${info.start + 1} to ${info.end} of ${info.recordsDisplay.toLocaleString()} entries` : 'No entries to show';
                    $('#dt-info').text(msg);
                },
                language: { emptyTable: "No laboratory orders found", processing: "Loading..." }
            });

            $('#globalSearch').on('input', () => table.search($('#globalSearch').val()).draw());
            $('#pageLength').on('change', function () { table.page.len(parseInt(this.value, 10)).draw(); });

            $(document).on('click', '.js-delete', function () {
                const id = $(this).data('id');
                const name = $(this).data('name');
                Swal.fire({
                    title: `Delete Order: ${name}?`,
                    text: 'You will not be able to revert this!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!'
                }).then(res => {
                    if (!res.isConfirmed) return;
                    $.ajax({
                        url: `/LaboratoryOrder/Delete/${id}`,
                        type: 'POST',
                        headers: { 'RequestVerificationToken': token },
                        success: r => {
                            if (r.status) {
                                Swal.fire('Deleted!', r.message, 'success');
                                table.ajax.reload(null, false);
                            } else {
                                Swal.fire('Error', r.message || 'Delete failed.', 'error');
                            }
                        },
                        error: () => Swal.fire('Error', 'Something went wrong.', 'error')
                    });
                });
            });
        });
    </script>
}
