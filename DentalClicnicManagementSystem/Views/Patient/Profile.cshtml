@inject CMS.Services.ICurrencyService CurrencyService
@model int

@{
    ViewData["Title"] = "Profil du Patient";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var currencySymbol = await CurrencyService.GetCurrentCurrencySymbolAsync();
}

<!-- Anti-forgery token pour AJAX POST -->
<form id="__af" method="post" style="display:none">
    @Html.AntiForgeryToken()
</form>

<div class="content">


    <!-- En-tête de la page -->
    <div class="page-header mb-3">
        <div class="row align-items-center">
            <div class="col">
                <p class="text-muted mb-1">
                    <a href="@Url.Action("Index", "Patient")" class="text-muted">Patients</a> / <span id="breadcrumb-name">...</span>
                </p>
            </div>
            <div class="col-auto">
                <a href="#" class="btn btn-light btn-sm"><i class="ti ti-printer me-1"></i> Imprimer</a>
                <a href="@Url.Action("Upsert", "Patient", new { id = Model })" class="btn btn-light btn-sm"><i class="ti ti-pencil me-1"></i> Modifier le patient</a>
            </div>
        </div>
    </div>

    <!-- Grille du contenu principal -->
    <div class="row">
        <!-- Colonne de gauche -->
        <div class="col-lg-8">
            <!-- Carte des informations du patient -->
            <div class="card profile-card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 text-center text-md-start">
                            <img id="patient-avatar" src="/assets/img/loader.gif" class="rounded-circle avatar-xxl mb-3" alt="Patient">
                            <h5 id="patient-name" class="mb-1">Chargement...</h5>
                            <p id="patient-email" class="text-muted mb-3">...</p>
                        </div>
                        <div class="col-md-8">
                            <div class="row patient-details-grid">
                                <div class="col-6"><small class="text-muted">Sexe</small><p id="patient-gender">...</p></div>
                                <div class="col-6"><small class="text-muted">Âge</small><p id="patient-dob">...</p></div>
                                <div class="col-6"><small class="text-muted">Numéro de téléphone</small><p id="patient-phone">...</p></div>
                                <div class="col-6"><small class="text-muted">Adresse</small><p id="patient-address">...</p></div>
                                <div class="col-6"><small class="text-muted">Date d'inscription</small><p id="patient-regdate">...</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Carte des rendez-vous -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center bg-transparent border-0">
                    @* <ul class="nav nav-tabs-modern" id="appointmentTabs" role="tablist">
                    <li class="nav-item"><a class="nav-link active" id="upcoming-tab" data-bs-toggle="tab" href="#upcoming" role="tab">Rendez-vous à venir</a></li>
                    <li class="nav-item"><a class="nav-link" id="past-tab" data-bs-toggle="tab" href="#past" role="tab">Rendez-vous passés</a></li>
                    <li class="nav-item"><a class="nav-link" id="medical-tab" data-bs-toggle="tab" href="#medical" role="tab">Dossiers médicaux</a></li>
                </ul> *@

                    <ul class="nav nav-tabs-modern" id="appointmentTabs" role="tablist">
                        <li class="nav-item"><a class="nav-link active" id="upcoming-tab" data-bs-toggle="tab" href="#upcoming" role="tab">Rendez-vous à venir</a></li>
                        <li class="nav-item"><a class="nav-link" id="past-tab" data-bs-toggle="tab" href="#past" role="tab">Rendez-vous passés</a></li>
                        <!-- AJOUTER CETTE LIGNE -->
                        <li class="nav-item"><a class="nav-link" id="followups-tab" data-bs-toggle="tab" href="#followups" role="tab">Suivi</a></li>
                        <li class="nav-item"><a class="nav-link" id="medical-tab" data-bs-toggle="tab" href="#medical" role="tab">Dossiers médicaux</a></li>
                    </ul>

                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addFollowUpModal">
                        <i class="ti ti-calendar-plus me-1"></i> Ajouter un suivi
                    </button>

                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="upcoming" role="tabpanel">
                            <div id="upcoming-appointments-list" class="appointment-timeline">
                                <!-- Contenu AJAX ici -->
                            </div>
                        </div>
                        <div class="tab-pane fade" id="past" role="tabpanel">
                            <div id="past-appointments-list" class="appointment-timeline">
                                <!-- Contenu AJAX ici -->
                            </div>
                        </div>
                        <div class="tab-pane fade" id="followups" role="tabpanel">
                            <div id="follow-ups-list">
                                <!-- Contenu AJAX pour les suivis sera chargé ici -->
                            </div>
                        </div>
                        <!-- Onglet des Dossiers Médicaux -->
                        <div class="tab-pane fade" id="medical" role="tabpanel">
                            <div id="medical-history-list">
                                <!-- Contenu AJAX pour l'historique médical sera chargé ici -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Colonne de droite -->
        <div class="col-lg-4">
            <!-- Carte des notes -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center bg-transparent border-0">
                    <h6 class="mb-0">Notes</h6>
                    <a href="#" class="btn-link">Voir tout</a>
                </div>
                <div class="card-body" id="notes-list">
                    <!-- Contenu AJAX ici -->
                </div>
            </div>

            <!-- Carte des fichiers/Documents -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center bg-transparent border-0">
                    <h6 class="mb-0">Résultats de laboratoire et rapports</h6>
                    <a href="#" class="btn-link"><i class="ti ti-plus"></i> Ajouter des fichiers</a>
                </div>
                <div class="card-body" id="documents-list">
                    <!-- Contenu AJAX ici -->
                </div>
            </div>

            <!-- Carte des paiements -->
            <div class="card mb-4">
                <div class="card-header bg-transparent border-0">
                    <h6 class="mb-0">Paiements</h6>
                </div>
                <div class="card-body" id="payments-list">
                    <!-- Contenu AJAX ici -->
                </div>
                <div class="card-footer bg-transparent border-0 d-flex justify-content-between">
                    <strong>Montant total :</strong>
                    <strong id="payments-total">...</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ajouter Document -->
    <div class="modal fade" id="addDocumentModal" tabindex="-1" aria-labelledby="addDocumentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addDocumentModalLabel">Ajouter un fichier / Document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addDocumentForm" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="documentFile" class="form-label">Sélectionner un fichier (Rayon-X, PDF, etc.)</label>
                            <input type="file" class="form-control" id="documentFile" name="file" required>
                        </div>
                        <div class="mb-3">
                            <label for="documentDescription" class="form-label">Description (Optionnel)</label>
                            <input type="text" class="form-control" id="documentDescription" name="description" placeholder="ex : 'Rayon-X Molaire gauche'">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        <button type="submit" class="btn btn-primary">
                            <span class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                            Télécharger
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Ajouter Suivi -->
    <div class="modal fade" id="addFollowUpModal" tabindex="-1" aria-labelledby="addFollowUpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addFollowUpModalLabel">Planifier un nouveau suivi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Ceci est le formulaire que vous avez fourni -->
                    <form id="addFollowUpForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="followUpInterval" class="form-label">Intervalle de suivi</label>
                                <select id="followUpInterval" class="form-select">
                                    <option value="">Sélectionner l'intervalle</option>
                                    <option value="1_week">Après 1 semaine</option>
                                    <option value="2_weeks">Après 2 semaines</option>
                                    <option value="1_month">Après 1 mois</option>
                                    <option value="custom">Personnalisé</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3" id="customIntervalContainer" style="display: none;">
                                <label for="followUpDate" class="form-label">Date personnalisée de suivi</label>
                                <input type="date" id="followUpDate" class="form-control">
                            </div>
                            <div class="col-12 mb-3">
                                <label for="followUpNotes" class="form-label">Notes</label>
                                <textarea id="followUpNotes" class="form-control" rows="4" placeholder="Ajoutez toutes les notes pertinentes pour le suivi..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="submit" form="addFollowUpForm" class="btn btn-primary">
                        <span class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                        Planifier le suivi
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>
<style>
    body {
        background-color: #f4f7fa;
    }

    .profile-card .patient-details-grid p {
        font-weight: 500;
        margin-bottom: 1rem;
    }

    .nav-tabs-modern {
        border-bottom: none;
    }

        .nav-tabs-modern .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 0.5rem 1rem;
        }

            .nav-tabs-modern .nav-link.active {
                color: #0d6efd;
                background-color: transparent;
                border-bottom: 2px solid #0d6efd;
            }

    .appointment-timeline .appointment-item {
        display: flex;
        position: relative;
        padding-left: 30px;
        padding-bottom: 2rem;
    }

        .appointment-timeline .appointment-item:last-child {
            padding-bottom: 0;
        }

        .appointment-timeline .appointment-item::before {
            content: '';
            position: absolute;
            left: 4px;
            top: 5px;
            width: 2px;
            height: 100%;
            background-color: #dee2e6;
        }

        .appointment-timeline .appointment-item .timeline-dot {
            position: absolute;
            left: 0;
            top: 5px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #fff;
            border: 2px solid #0d6efd;
        }

        .appointment-timeline .appointment-item .timeline-content {
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 1rem;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

    .file-item, .payment-item, .note-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e9ecef;
    }

        .file-item:last-child, .payment-item:last-child, .note-item:last-child {
            border-bottom: none;
        }

        .file-item .file-icon {
            font-size: 1.5rem;
            color: #6c757d;
        }


    /* Ajoutez ceci dans votre bloc <style> existant */
    .notes-list-collapsed {
        max-height: 200px; /* Ajustez cette valeur si nécessaire */
        overflow-y: hidden;
        position: relative;
    }

        .notes-list-collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(to bottom, transparent, #fff);
        }
</style>

@section Scripts {
    <script>
        $(document).ready(function () {
            const patientId = @Model;
            const token = $('#__af input[name="__RequestVerificationToken"]').val();

            // --- FONCTIONS DE POPULATION DE L'UI ---

            function populateCombinedNotes(notes) {
                const notesList = $('#notes-list');
                notesList.empty();
                notesList.removeClass('notes-list-collapsed'); // Réinitialiser l'état

                if (notes && notes.length > 0) {
                    // Ajouter une classe pour permettre la réduction si il y a trop de notes
                    if (notes.length > 3) { // Ou tout autre nombre que vous préférez
                        notesList.addClass('notes-list-collapsed');
                        $('.card-header a:contains("Voir tout")').show();
                    } else {
                        $('.card-header a:contains("Voir tout")').hide();
                    }

                    notes.forEach(note => {
                        const noteHtml = `
                            <div class="note-item">
                                <div>
                                    <p class="mb-1">${note.content}</p>
                                    <small class="text-muted">${note.source} - ${formatDate(note.createdAt)}</small>
                                </div>
                            </div>`;
                        notesList.append(noteHtml);
                    });
                } else {
                    notesList.html('<p class="text-center text-muted">Aucune note trouvée.</p>');
                    $('.card-header a:contains("Voir tout")').hide();
                }
            }
            // FIX 1: Fonction "Voir tout" pour les notes
            $('.card-header a:contains("Voir tout")').on('click', function(e) {
                e.preventDefault();
                const notesList = $('#notes-list');
                notesList.toggleClass('notes-list-collapsed');
                if (notesList.hasClass('notes-list-collapsed')) {
                    $(this).text('Voir tout');
                } else {
                    $(this).text('Voir moins');
                }
            });

            // FIX 2: Fonction "Ajouter des fichiers"
            $('.card-header a:contains("Ajouter des fichiers")').on('click', function(e) {
                e.preventDefault();
                $('#addDocumentModal').modal('show');
            });

            // Nouveau gestionnaire pour le formulaire de téléchargement de document
            $('#addDocumentForm').on('submit', function(e) {
                e.preventDefault();
                const form = $(this);
                const submitBtn = form.find('button[type="submit"]');
                const spinner = submitBtn.find('.spinner-border');

                spinner.show();
                submitBtn.prop('disabled', true);

                const formData = new FormData(this);
                formData.append('patientId', patientId);

                $.ajax({
                    url: '/Patient/AddDocument',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: { 'RequestVerificationToken': token },
                    success: function(response) {
                        if (response.success) {
                            $('#addDocumentModal').modal('hide');
                            form[0].reset();
                            alert(response.message); // Ou utilisez SweetAlert2
                            loadPatientData(); // Rafraîchir les données de la page
                        } else {
                            alert('Erreur: ' + response.message);
                        }
                    },
                    error: () => alert('Une erreur inattendue s\'est produite pendant le téléchargement du fichier.'),
                    complete: () => {
                        spinner.hide();
                        submitBtn.prop('disabled', false);
                    }
                });
            });

            // FIX 3: Sélection de date personnalisée pour le suivi
            $('#followUpInterval').on('change', function() {
                if ($(this).val() === 'custom') {
                    $('#customIntervalContainer').slideDown();
                } else {
                    $('#customIntervalContainer').slideUp();
                }
            });

            // ADD THIS ENTIRE FUNCTION
            function populateAppointments(listId, appointments) {
                const listElement = $(listId);
                listElement.empty();
                if (appointments && appointments.length > 0) {
                    appointments.forEach(apt => {
                        const aptHtml = `
                            <div class="appointment-item">
                                <div class="timeline-dot"></div>
                                <div class="timeline-content">
                                    <div>
                                        <p class="fw-bold mb-0">${formatDate(apt.appointmentDate)}</p>
                                        <small class="text-muted">${formatTime(apt.appointmentDate)}</small>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Type</small>
                                        <p class="fw-bold mb-0">${apt.appointmentType || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Médecin</small>
                                        <p class="fw-bold mb-0">${apt.doctorName || 'N/A'}</p>
                                    </div>
                                    <a href="#" class="btn btn-light btn-sm"><i class="ti ti-file-text"></i> Notes</a>
                                </div>
                            </div>`;
                        listElement.append(aptHtml);
                    });
                } else {
                    listElement.html('<p class="text-center text-muted">Aucun rendez-vous.</p>');
                }
            }

            function populateFollowUps(followUps) {
                const listElement = $('#follow-ups-list');
                listElement.empty();
                if (followUps && followUps.length > 0) {
                    followUps.forEach(fu => {
                        const fuHtml = `
                            <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                                <div>
                                    <p class="fw-bold mb-0">Suivi du : ${formatDate(fu.followUpDate)}</p>
                                    <small class="text-muted">${fu.notes || 'Aucune note fournie.'}</small>
                                </div>
                                <span class="badge bg-info text-dark">${fu.status}</span>
                            </div>`;
                        listElement.append(fuHtml);
                    });
                } else {
                    listElement.html('<p class="text-center text-muted">Aucun suivi prévu.</p>');
                }
            }

            // Cette fonction est correcte pour afficher les notes combinées
            function populateCombinedNotes(notes) {
                const notesList = $('#notes-list');
                notesList.empty();
                if (notes && notes.length > 0) {
                    notes.forEach(note => {
                        const noteHtml = `
                            <div class="note-item">
                                <div>
                                    <p class="mb-1">${note.content}</p>
                                    <small class="text-muted">${note.source} - ${formatDate(note.createdAt)}</small>
                                </div>
                            </div>`;
                        notesList.append(noteHtml);
                    });
                } else {
                    notesList.html('<p class="text-center text-muted">Aucune note trouvée.</p>');
                }
            }

            function populateDocuments(documents) {
                const docsList = $('#documents-list');
                docsList.empty();
                if (documents && documents.length > 0) {
                    documents.forEach(doc => {
                        const docHtml = `
                            <div class="file-item">
                                <i class="ti ti-file-text file-icon me-3"></i>
                                <div class="flex-grow-1">
                                    <p class="mb-0 fw-bold">${doc.fileName}</p>
                                    <small class="text-muted">${doc.fileSize}</small>
                                </div>
                                <a href="${doc.fileUrl}" target="_blank" class="btn btn-sm btn-light"><i class="ti ti-download"></i></a>
                            </div>`;
                        docsList.append(docHtml);
                    });
                } else {
                    docsList.html('<p class="text-center text-muted">Aucun document trouvé.</p>');
                }
            }

            function populatePayments(payments) {
                const paymentsList = $('#payments-list');
                let totalPayments = 0;
                paymentsList.empty();
                if (payments && payments.length > 0) {
                    payments.forEach(payment => {
                        totalPayments += payment.amount;
                        const paymentHtml = `
                            <div class="payment-item">
                                <i class="ti ti-circle-check text-success me-3"></i>
                                <span class="flex-grow-1">${payment.transaction}</span>
                                <strong>@currencySymbol${payment.amount.toFixed(2)}</strong>
                            </div>`;
                        paymentsList.append(paymentHtml);
                    });
                } else {
                    paymentsList.html('<p class="text-center text-muted">Aucun paiement trouvé.</p>');
                }
                $('#payments-total').text(`@currencySymbol${totalPayments.toFixed(2)}`);
            }

            // --- CHARGEMENT DES DONNÉES ---
            function loadPatientData() {
                $.ajax({
                    url: `/Patient/GetPatientProfile?id=${patientId}`,
                    type: 'GET',
                    success: function (data) {
                        // Remplir les informations du patient
                        $('#breadcrumb-name').text(data.patient.fullName || 'Profil du patient');
                        $('#patient-avatar').attr('src', data.patient.profileImageUrl || '/assets/img/users/user-placeholder.jpg');
                        $('#patient-name').text(data.patient.fullName || 'Nom non fourni');
                        $('#patient-email').text(data.patient.email || 'Pas d\'email');

                        // Remplir le tableau des détails
                        $('#patient-gender').text(data.patient.gender || 'N/A');
                        $('#patient-dob').text(calculateAge(data.patient.dateOfBirth) + ' ans');
                        $('#patient-phone').text(data.patient.phoneNumber || 'N/A');
                        $('#patient-address').text(data.patient.address || 'N/A');
                        $('#patient-regdate').text(formatDate(data.patient.createdDate));

                        // Remplir toutes les sections
                        populateAppointments('#upcoming-appointments-list', data.upcomingAppointments);
                        populateAppointments('#past-appointments-list', data.pastAppointments);
                        populateFollowUps(data.followUps);
                        populateDocuments(data.documents);
                        populatePayments(data.payments);

                        // FIX: Appeler la fonction correcte pour les notes combinées
                        populateCombinedNotes(data.combinedNotes);
                    },
                    error: (jqXHR, textStatus, errorThrown) => {
                        console.error("Erreur lors du chargement des données du patient :", textStatus, errorThrown, jqXHR.responseText);
                        $('.content').html('<div class="alert alert-danger"><h4>Échec du chargement du profil</h4><p>Une erreur serveur est survenue. Veuillez vérifier la console pour plus de détails.</p></div>');
                    }
                });
            }

            // --- GESTIONNAIRES D\'ÉVÉNEMENTS & FONCTIONS UTILITAIRES ---
            // (Ajouter des documents, ajouter un suivi, formatDate, formatTime, calculateAge, etc.)

            $('.card-header a:contains("Ajouter des fichiers")').on('click', function(e) { /* ... correct as is ... */ });
                    $('#addDocumentForm').on('submit', function(e) {
            e.preventDefault(); // Empêcher l'envoi par défaut du formulaire
            const form = $(this);
            const submitBtn = form.find('button[type="submit"]');
            const spinner = submitBtn.find('.spinner-border');

            spinner.show();
            submitBtn.prop('disabled', true);

            // FormData est nécessaire pour les téléchargements de fichiers
            const formData = new FormData(this);
            formData.append('patientId', patientId); // Ajouter le patientId aux données du formulaire

            $.ajax({
                url: '/Patient/AddDocument',
                type: 'POST',
                data: formData,
                processData: false,  // Important : Ne pas traiter les données
                contentType: false,  // Important : Laisser le navigateur définir le type de contenu
                headers: { 'RequestVerificationToken': token },
                success: function(response) {
                    if (response.success) {
                        $('#addDocumentModal').modal('hide');
                        form[0].reset();
                        alert(response.message); // Ou utilisez SweetAlert2
                        loadPatientData(); // Rafraîchir toutes les données de la page pour afficher le nouveau document
                    } else {
                        alert('Erreur : ' + response.message);
                    }
                },
                error: () => alert('Une erreur inattendue s\'est produite lors du téléchargement du fichier.'),
                complete: function() {
                    spinner.hide();
                    submitBtn.prop('disabled', false);
                }
            });
        });

                   $('#followUpInterval').on('change', function() {
            // Vérifier si la valeur sélectionnée est "custom"
            if ($(this).val() === 'custom') {
                // Si c'est le cas, afficher le conteneur pour la saisie de la date personnalisée avec une animation fluide
                $('#customIntervalContainer').slideDown();
            } else {
                // Sinon, le masquer
                $('#customIntervalContainer').slideUp();
            }
        });

                    $('#addFollowUpForm').on('submit', function(e) {
            e.preventDefault(); // Empêcher l'envoi par défaut du formulaire
            const submitBtn = $('.modal-footer button[form="addFollowUpForm"]');
            const spinner = submitBtn.find('.spinner-border');

            spinner.show();
            submitBtn.prop('disabled', true);

            let followUpDate;
            const interval = $('#followUpInterval').val();

            if (interval === 'custom') {
                // Utiliser la date du sélecteur de date si "custom" est sélectionné
                followUpDate = $('#followUpDate').val();
            } else {
                // Sinon, calculer la date en fonction de l'intervalle sélectionné
                const now = new Date();
                if (interval === '1_week') now.setDate(now.getDate() + 7);
                if (interval === '2_weeks') now.setDate(now.getDate() + 14);
                if (interval === '1_month') now.setMonth(now.getMonth() + 1);
                // Formater la date en YYYY-MM-DD pour le backend
                followUpDate = now.toISOString().split('T')[0];
            }

            // Créer l'objet de données qui correspond au modèle FollowUp
            const followUpData = {
                PatientId: patientId, // 'patientId' est défini en haut de votre script
                FollowUpDate: followUpDate,
                Notes: $('#followUpNotes').val()
            };

            $.ajax({
                url: '/Patient/AddFollowUp',
                type: 'POST',
                contentType: 'application/json', // Important pour [FromBody] dans le contrôleur
                headers: { 'RequestVerificationToken': token }, // 'token' est défini en haut de votre script
                data: JSON.stringify(followUpData), // Convertir l'objet JS en chaîne JSON
                success: function(response) {
                    if (response.success) {
                        $('#addFollowUpModal').modal('hide');
                        $('#addFollowUpForm')[0].reset();
                        alert(response.message); // Ou utilisez SweetAlert2
                        loadPatientData(); // Rafraîchir toutes les données sur la page
                    } else {
                        alert('Erreur : ' + (response.message || 'Impossible de planifier le suivi.'));
                    }
                },
                error: () => alert('Une erreur inattendue s\'est produite.'),
                complete: function() {
                    spinner.hide();
                    submitBtn.prop('disabled', false);
                }
            });
        });


            function calculateAge(birthDate) {
                if (!birthDate || birthDate.startsWith('0001-01-01')) return 'N/A';
                var birthDateObj = new Date(birthDate);
                var today = new Date();
                var age = today.getFullYear() - birthDateObj.getFullYear();
                var m = today.getMonth() - birthDateObj.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDateObj.getDate())) {
                    age--;
                }
                return age;
            }

            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                const options = { year: '2-digit', month: 'short', day: 'numeric' };
                return new Date(dateString).toLocaleDateString('fr-FR', options);
            }

            function formatTime(dateString) {
                if (!dateString) return 'N/A';
                const options = { hour: '2-digit', minute: '2-digit', hour12: true };
                return new Date(dateString).toLocaleTimeString('fr-FR', options);
            }


                    // Fonction pour afficher l'historique médical
            function populateMedicalHistory(history) {
                const historyList = $('#medical-history-list');
                historyList.empty(); // Vider les données existantes

                if (history && history.length > 0) {
                    history.forEach(record => {
                        const recordHtml = `
                            <div class="medical-history-item">
                                <h5>${record.diagnosis}</h5>
                                <p><strong>Date de la visite :</strong> ${formatDate(record.dateOfVisit)}</p>
                                <p><strong>Sévérité :</strong> ${record.severity}</p>
                                <p><strong>Statut :</strong> ${record.status}</p>
                                ${record.document ? `
                                    <div><strong>Document :</strong> <a href="${record.document.fileUrl}" target="_blank">${record.document.fileName}</a></div>
                                ` : ''}
                            </div>
                            <hr>
                        `;
                        historyList.append(recordHtml);
                    });
                } else {
                    historyList.html('<p class="text-center text-muted">Aucun dossier médical trouvé.</p>');
                }
            }

            // Appel AJAX pour récupérer l'historique médical et les suivis
            $.ajax({
                url: `/Patient/GetPatientHistory?id=${patientId}`,  // Votre URL de point de terminaison
                type: 'GET',
                success: function (data) {
                    // Remplir l'historique médical
                    populateMedicalHistory(data.medicalHistory);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error("Erreur lors de la récupération de l'historique médical :", textStatus, errorThrown);
                    $('#medical-history-list').html('<p class="text-center text-muted">Échec du chargement des dossiers médicaux.</p>');
                }
            });

            // Fonction utilitaire pour formater la date
            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                const options = { year: '2-digit', month: 'short', day: 'numeric' };
                return new Date(dateString).toLocaleDateString('fr-FR', options);
            }

            // --- CHARGEMENT INITIAL ---
            loadPatientData();
        });
    </script>
}
