@* File: Views/Reports/DailyCollection.cshtml *@
@inject CMS.Services.ICurrencyService CurrencyService
@{
    ViewData["Title"] = "Daily Collection Report";
    var currentCurrency = await CurrencyService.GetCurrentCurrencyAsync();
    var currencySymbol = currentCurrency?.Symbol ?? "$";
}

<div class="content">
    <input type="hidden" id="initialCurrencySymbol" value="@currencySymbol" />  
    <div class="d-flex align-items-sm-center flex-sm-row flex-column gap-2 mb-3 pb-3 border-bottom">
        <div class="flex-grow-1">
            <h4 class="fw-bold mb-0">Daily Collection Report</h4>
        </div>
        <div class="text-end d-flex">
            <div class="dropdown me-1">
                <a href="javascript:void(0);" class="btn btn-md fs-14 fw-normal border bg-white rounded text-dark d-inline-flex align-items-center" data-bs-toggle="dropdown">
                    Export <i class="ti ti-chevron-down ms-2"></i>
                </a>
                <ul class="dropdown-menu p-2">
                    <li><a class="dropdown-item export-csv" href="javascript:void(0);" data-report="dailycollection">Download as CSV</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1">Total Collection</p>
                            <h4 class="mb-0 fw-bold text-primary" id="totalAmount">$0.00</h4>
                        </div>
                        <span class="avatar avatar-md bg-soft-primary text-primary rounded-2">
                            <i class="ti ti-cash fs-18"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1">Cash Payments</p>
                            <h4 class="mb-0 fw-bold text-success" id="cashAmount">$0.00</h4>
                        </div>
                        <span class="avatar avatar-md bg-soft-success text-success rounded-2">
                            <i class="ti ti-coin fs-18"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1">Card Payments</p>
                            <h4 class="mb-0 fw-bold text-info" id="cardAmount">$0.00</h4>
                        </div>
                        <span class="avatar avatar-md bg-soft-info text-info rounded-2">
                            <i class="ti ti-credit-card fs-18"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1">Total Payments</p>
                            <h4 class="mb-0 fw-bold text-warning" id="paymentCount">0</h4>
                        </div>
                        <span class="avatar avatar-md bg-soft-warning text-warning rounded-2">
                            <i class="ti ti-receipt fs-18"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row row-gap-2">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="text" class="form-control" id="dateFilter" value="@DateTime.Today.ToString("yyyy-MM-dd")" autocomplete="off">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <select class="form-select" id="paymentMethodFilter">
                            <option value="">All Methods</option>
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="Online">Online</option>
                            <option value="Insurance">Insurance</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4 d-flex justify-content-center">
                    <div class="mb-4 d-flex align-items-end w-100">
                        <button type="button" class="btn btn-dark w-100 " id="applyFiltersBtn">
                            <i class="ti ti-player-play me-1"></i>Run Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="dailyCollectionTable">
                    <thead class="thead-light">
                        <tr>
                            <th>Invoice #</th>
                            <th>Patient</th>
                            <th>Doctor</th>
                            <th>Amount</th>
                            <th>Payment Method</th>
                            <th>Payment Date</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded via AJAX -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
         flatpickr("#dateFilter", {
            dateFormat: "Y-m-d",
            allowInput: true,
            defaultDate: "@DateTime.Today.ToString("yyyy-MM-dd")"
        });
        $(document).ready(function () {
            let currentCurrencySymbol = $('#initialCurrencySymbol').val() || '$';
            
           function formatCurrency(amount) {
            return currentCurrencySymbol + parseFloat(amount).toFixed(2);
        }
        // Function to load current currency from server
        function loadCurrentCurrency() {
            $.get('/Reports/GetCurrentCurrency', function(currency) {
                currentCurrencySymbol = currency.symbol;
                currentCurrencyCode = currency.code;
                // Refresh the data to update currency displays
                loadDailyCollectionData();
            }).fail(function() {
                // Fallback to server-side rendered values if AJAX fails
                currentCurrencySymbol = $('#initialCurrencySymbol').val() || '$';
                currentCurrencyCode = $('#initialCurrencyCode').val() || 'USD';
                console.log('Using fallback currency:', currentCurrencySymbol);
            });
        }
            let isExporting = false;

            // Load initial data
            loadDailyCollectionData();

            // Apply filters when button is clicked
            $('#applyFiltersBtn').on('click', function () {
                loadDailyCollectionData();
            });

            // Apply filters when Enter key is pressed in filter fields
            $('#dateFilter, #paymentMethodFilter').on('keypress', function (e) {
                if (e.which === 13) { // Enter key
                    loadDailyCollectionData();
                }
            });

            // Export functionality
            $('.export-csv').on('click', function () {
                if (isExporting) return;
                exportToCsv();
            });

            function loadDailyCollectionData() {
                const $btn = $('#applyFiltersBtn');
                const originalText = $btn.html();

                $btn.prop('disabled', true).html('<i class="ti ti-loader me-1"></i>Loading...');

                const params = getFilterParams();

                $.ajax({
                    url: '@Url.Action("GetDailyCollectionData", "Reports")',
                    type: 'GET',
                    data: params,
                    success: function (response) {
                        if (response.data && response.summary) {
                            updateSummary(response.summary);
                            populateTable(response.data);
                        } else {
                            console.error('Invalid response format:', response);
                            showError('Invalid data received from server');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error loading data:', error);
                        showError('Error loading report data: ' + error);
                    },
                    complete: function () {
                        $btn.prop('disabled', false).html('<i class="ti ti-player-play me-1"></i>Run Report');
                    }
                });
            }

            function exportToCsv() {
                if (isExporting) return;

                const $btn = $('.export-csv');
                const originalText = $btn.html();

                $btn.prop('disabled', true).html('<i class="ti ti-loader me-1"></i>Exporting...');
                isExporting = true;

                try {
                    const params = getFilterParams();
                    const url = '@Url.Action("ExportDailyCollectionCsv", "Reports")?' + $.param(params);

                    // Create a temporary anchor to trigger download
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = '';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    setTimeout(() => {
                        $btn.prop('disabled', false).html(originalText);
                        isExporting = false;
                    }, 1000);

                } catch (error) {
                    console.error('Export failed:', error);
                    showError('Export failed: ' + error);
                    $btn.prop('disabled', false).html(originalText);
                    isExporting = false;
                }
            }

            function getFilterParams() {
                return {
                    date: $('#dateFilter').val(),
                    paymentMethod: $('#paymentMethodFilter').val()
                };
            }

            function updateSummary(summary) {
                $('#totalAmount').text(formatCurrency(summary.totalAmount || 0));
                $('#cashAmount').text(formatCurrency(summary.cashAmount || 0));
                $('#cardAmount').text(formatCurrency(summary.cardAmount || 0));
                $('#paymentCount').text(summary.paymentCount || 0);
            }

           

            function populateTable(data) {
                const tbody = $('#dailyCollectionTable tbody');
                tbody.empty();

                if (!data || data.length === 0) {
                    tbody.append('<tr><td colspan="7" class="text-center py-4 text-muted">No payments found for the selected criteria</td></tr>');
                    return;
                }

                data.forEach(function (item) {
                    const row = `
                        <tr>
                            <td>${escapeHtml(item.invoiceNumber || 'N/A')}</td>
                            <td>${escapeHtml(item.patientName || 'N/A')}</td>
                            <td>${escapeHtml(item.doctorName || 'N/A')}</td>
                            <td>${formatCurrency(item.amount || 0)}</td>
                            <td>
                                <span class="badge ${getPaymentMethodBadgeClass(item.paymentMethod)}">
                                    ${escapeHtml(item.paymentMethod || 'N/A')}
                                </span>
                            </td>
                            <td>${escapeHtml(item.paymentDate || 'N/A')}</td>
                            <td class="truncate-220">${escapeHtml(item.notes || '')}</td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }

            function getPaymentMethodBadgeClass(method) {
                switch (method?.toLowerCase()) {
                    case 'cash': return 'bg-soft-success text-success';
                    case 'card': return 'bg-soft-info text-info';
                    case 'online': return 'bg-soft-primary text-primary';
                    case 'insurance': return 'bg-soft-warning text-warning';
                    default: return 'bg-soft-secondary text-secondary';
                }
            }

            function escapeHtml(unsafe) {
                if (!unsafe) return '';
                return unsafe
                    .toString()
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function showError(message) {
                // You can replace this with a toast notification or alert
                console.error('Error:', message);
                alert(message);
            }
        

        });
    </script>

    <style>
        .truncate-220 {
            max-width: 220px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
}