@* File: Views/Reports/LowStock.cshtml *@
@{
    ViewData["Title"] = "Low Stock Alert Report";
}

<div class="content">
    <div class="d-flex align-items-sm-center flex-sm-row flex-column gap-2 mb-3 pb-3 border-bottom">
        <div class="flex-grow-1">
            <h4 class="fw-bold mb-0">Low Stock Alert Report</h4>
        </div>
        <div class="text-end d-flex">
            <div class="dropdown me-1">
                <a href="javascript:void(0);" class="btn btn-md fs-14 fw-normal border bg-white rounded text-dark d-inline-flex align-items-center" data-bs-toggle="dropdown">
                    Export <i class="ti ti-chevron-down ms-2"></i>
                </a>
                <ul class="dropdown-menu p-2">
                    <li><a class="dropdown-item export-csv" href="javascript:void(0);" data-report="lowstock">Download as CSV</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3 col-xl-4 col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1">Low Stock Items</p>
                            <h4 class="mb-0 fw-bold text-warning" id="totalLowStock">0</h4>
                        </div>
                        <span class="avatar avatar-md bg-soft-warning text-warning rounded-2">
                            <i class="ti ti-package fs-18"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-xl-4 col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1">Critical Items</p>
                            <h4 class="mb-0 fw-bold text-danger" id="criticalItems">0</h4>
                        </div>
                        <span class="avatar avatar-md bg-soft-danger text-danger rounded-2">
                            <i class="ti ti-alert-triangle fs-18"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-xl-4 col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1">Out of Stock</p>
                            <h4 class="mb-0 fw-bold text-dark" id="outOfStock">0</h4>
                        </div>
                        <span class="avatar avatar-md bg-soft-dark text-dark rounded-2">
                            <i class="ti ti-x fs-18"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row row-gap-2">
                <!-- Stock Threshold Input -->
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Stock Threshold</label>
                        <input type="number" class="form-control" id="thresholdFilter" value="21" min="1" max="100">
                        <small class="text-muted">Show items with stock below this level</small>
                    </div>
                </div>
                <!-- Button to Run the Report -->
                <div class="col-md-4 d-flex justify-content-center">
                    <div class="mb-3 d-flex  align-items-center w-100">
                        <button type="button" class="btn btn-sm btn-dark w-100" id="applyFiltersBtn">
                            <i class="ti ti-player-play me-1"></i>Run Report
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="lowStockTable">
                    <thead class="thead-light">
                        <tr>
                            <th>Item Name</th>
                            <th>Category</th>
                            <th>Current Stock</th>
                            <th>Minimum Stock</th>
                            <th>Status</th>
                            <th>Last Restocked</th>
                            <th>Supplier</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded via AJAX -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            let isExporting = false;

            // Load initial data
            loadLowStockData();

            // Apply filters
            $('#applyFiltersBtn').on('click', function () {
    // Fetch the threshold value entered by the user
    const threshold = $('#thresholdFilter').val();

    // Call the function to load data with the threshold value
    loadLowStockData(threshold);
});

            // Export functionality
            $('.export-csv').on('click', function () {
                if (isExporting) return;

                const $btn = $(this);
                const originalText = $btn.html();

                $btn.prop('disabled', true);
                $btn.html('<i class="ti ti-loader me-1"></i>Exporting...');
                isExporting = true;

                try {
                    const params = getFilterParams();
                    const url = '@Url.Action("ExportLowStockCsv", "Reports")?' + $.param(params);
                    window.location.href = url;

                    setTimeout(() => {
                        $btn.prop('disabled', false);
                        $btn.html(originalText);
                        isExporting = false;
                    }, 2000);
                } catch (error) {
                    console.error('Export failed:', error);
                    $btn.prop('disabled', false);
                    $btn.html(originalText);
                    isExporting = false;
                    alert('Export failed. Please try again.');
                }
            });

                   function loadLowStockData(threshold) {
            $.ajax({
                url: '@Url.Action("GetLowStockData", "Reports")',
                type: 'GET',
                data: { threshold: threshold },
                success: function (response) {
                    if (response.data && response.summary) {
                        updateSummary(response.summary);
                        populateTable(response.data);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error loading data:', error);
                    alert('Error loading report data');
                }
            });
        }

            function getFilterParams() {
                return {
                    threshold: $('#thresholdFilter').val()
                };
            }

            function updateSummary(summary) {
                $('#totalLowStock').text(summary.totalLowStockItems);
                $('#criticalItems').text(summary.criticalItems);
                $('#outOfStock').text(summary.outOfStockItems);
            }

            function populateTable(data) {
                const tbody = $('#lowStockTable tbody');
                tbody.empty();

                if (data.length === 0) {
                    tbody.append('<tr><td colspan="7" class="text-center">No low stock items found</td></tr>');
                    return;
                }

                data.forEach(function (item) {
                    let statusBadge, statusClass;
                    if (item.currentStock === 0) {
                        statusBadge = 'Out of Stock';
                        statusClass = 'danger';
                    } else if (item.currentStock <= 5) {
                        statusBadge = 'Critical';
                        statusClass = 'danger';
                    } else {
                        statusBadge = 'Low';
                        statusClass = 'warning';
                    }

                    const row = `
                        <tr>
                            <td><strong>${item.itemName}</strong></td>
                            <td>${item.category}</td>
                            <td><strong class="text-${statusClass}">${item.currentStock}</strong></td>
                            <td>${item.minimumStock}</td>
                            <td><span class="badge bg-${statusClass}">${statusBadge}</span></td>
                            <td>${item.lastRestocked}</td>
                            <td>${item.supplier}</td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }
        });
    </script>
}