@* File: Views/Reports/OutstandingInvoices.cshtml *@
@{
    ViewData["Title"] = "Outstanding Invoices Report";
}

<div class="content">
    <div class="d-flex align-items-sm-center flex-sm-row flex-column gap-2 mb-3 pb-3 border-bottom">
        <div class="flex-grow-1">
            <h4 class="fw-bold mb-0">Outstanding Invoices Report</h4>
        </div>
        <div class="text-end d-flex">
            <div class="dropdown me-1">
                <a href="javascript:void(0);" class="btn btn-md fs-14 fw-normal border bg-white rounded text-dark d-inline-flex align-items-center" data-bs-toggle="dropdown">
                    Export <i class="ti ti-chevron-down ms-2"></i>
                </a>
                <ul class="dropdown-menu p-2">
                    <li><a class="dropdown-item export-csv" href="javascript:void(0);" data-report="outstandinginvoices">Download as CSV</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1">Total Outstanding</p>
                            <h4 class="mb-0 fw-bold text-primary" id="totalOutstanding">$0.00</h4>
                        </div>
                        <span class="avatar avatar-md bg-soft-primary text-primary rounded-2">
                            <i class="ti ti-receipt fs-18"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1">Total Invoices</p>
                            <h4 class="mb-0 fw-bold text-info" id="totalInvoices">0</h4>
                        </div>
                        <span class="avatar avatar-md bg-soft-info text-info rounded-2">
                            <i class="ti ti-files fs-18"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1">Overdue Invoices</p>
                            <h4 class="mb-0 fw-bold text-danger" id="overdueInvoices">0</h4>
                        </div>
                        <span class="avatar avatar-md bg-soft-danger text-danger rounded-2">
                            <i class="ti ti-alert-triangle fs-18"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1">Overdue Amount</p>
                            <h4 class="mb-0 fw-bold text-warning" id="overdueAmount">$0.00</h4>
                        </div>
                        <span class="avatar avatar-md bg-soft-warning text-warning rounded-2">
                            <i class="ti ti-coin fs-18"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row row-gap-2">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Status Filter</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">All Outstanding</option>
                            <option value="Overdue">Overdue Only</option>
                            <option value="DueToday">Due Today</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3 d-flex align-items-end">
                        <button type="button" class="btn btn-dark w-100" id="applyFiltersBtn">
                            <i class="ti ti-player-play me-1"></i>Run Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="outstandingInvoicesTable">
                    <thead class="thead-light">
                        <tr>
                            <th>Invoice #</th>
                            <th>Patient</th>
                            <th>Doctor</th>
                            <th>Issue Date</th>
                            <th>Due Date</th>
                            <th>Total Amount</th>
                            <th>Amount Paid</th>
                            <th>Balance Due</th>
                            <th>Status</th>
                            <th>Overdue Days</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded via AJAX -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            let isExporting = false;

            // Load initial data
            loadOutstandingInvoicesData();

            // Apply filters
            $('#applyFiltersBtn').on('click', function () {
                loadOutstandingInvoicesData();
            });

            // Export functionality
            $('.export-csv').on('click', function () {
                if (isExporting) return;

                const $btn = $(this);
                const originalText = $btn.html();

                $btn.prop('disabled', true);
                $btn.html('<i class="ti ti-loader me-1"></i>Exporting...');
                isExporting = true;

                try {
                    const params = getFilterParams();
                    const url = '@Url.Action("ExportOutstandingInvoicesCsv", "Reports")?' + $.param(params);
                    window.location.href = url;

                    setTimeout(() => {
                        $btn.prop('disabled', false);
                        $btn.html(originalText);
                        isExporting = false;
                    }, 2000);
                } catch (error) {
                    console.error('Export failed:', error);
                    $btn.prop('disabled', false);
                    $btn.html(originalText);
                    isExporting = false;
                    alert('Export failed. Please try again.');
                }
            });

            function loadOutstandingInvoicesData() {
                const params = getFilterParams();

                $.ajax({
                    url: '@Url.Action("GetOutstandingInvoicesData", "Reports")',
                    type: 'GET',
                    data: params,
                    success: function (response) {
                        if (response.data && response.summary) {
                            updateSummary(response.summary);
                            populateTable(response.data);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error loading data:', error);
                        alert('Error loading report data');
                    }
                });
            }

            function getFilterParams() {
                return {
                    statusFilter: $('#statusFilter').val()
                };
            }

            function updateSummary(summary) {
                $('#totalOutstanding').text('$' + summary.totalOutstanding.toFixed(2));
                $('#totalInvoices').text(summary.totalInvoices);
                $('#overdueInvoices').text(summary.overdueInvoices);
                $('#overdueAmount').text('$' + summary.totalOverdueAmount.toFixed(2));
            }

            function populateTable(data) {
                const tbody = $('#outstandingInvoicesTable tbody');
                tbody.empty();

                if (data.length === 0) {
                    tbody.append('<tr><td colspan="10" class="text-center">No outstanding invoices found</td></tr>');
                    return;
                }

                data.forEach(function (item) {
                    const statusBadge = item.status === 'Overdue'
                        ? '<span class="badge bg-danger">Overdue</span>'
                        : '<span class="badge bg-warning">Pending</span>';

                    const row = `
                        <tr>
                            <td>${item.invoiceNumber}</td>
                            <td>${item.patientName}</td>
                            <td>${item.doctorName}</td>
                            <td>${item.issueDate}</td>
                            <td>${item.dueDate}</td>
                            <td>$${item.totalAmount.toFixed(2)}</td>
                            <td>$${item.amountPaid.toFixed(2)}</td>
                            <td><strong>$${item.balanceDue.toFixed(2)}</strong></td>
                            <td>${statusBadge}</td>
                            <td>${item.overdueDays > 0 ? item.overdueDays + ' days' : '-'}</td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }
        });
    </script>
}