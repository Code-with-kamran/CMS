@* File: Views/Reports/TreatmentStatistics.cshtml *@
@{
    ViewData["Title"] = "Treatment Statistics Report";
}

<div class="content">
    <div class="d-flex align-items-sm-center flex-sm-row flex-column gap-2 mb-3 pb-3 border-bottom">
        <div class="flex-grow-1">
            <h4 class="fw-bold mb-0">Treatment Statistics Report</h4>
        </div>
        <div class="text-end d-flex">
            <div class="dropdown me-1">
                <a href="javascript:void(0);" class="btn btn-md fs-14 fw-normal border bg-white rounded text-dark d-inline-flex align-items-center" data-bs-toggle="dropdown">
                    Export <i class="ti ti-chevron-down ms-2"></i>
                </a>
                <ul class="dropdown-menu p-2">
                    <li><a class="dropdown-item export-csv" href="javascript:void(0);" data-report="treatmentstatistics">Download as CSV</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row row-gap-2">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate" value="@DateTime.Today.AddMonths(-1).ToString("yyyy-MM-dd")">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate" value="@DateTime.Today.ToString("yyyy-MM-dd")">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3 d-flex align-items-end">
                        <button type="button" class="btn btn-dark w-100" id="applyFiltersBtn">
                            <i class="ti ti-player-play me-1"></i>Run Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="treatmentStatsTable">
                    <thead class="thead-light">
                        <tr>
                            <th>Treatment Name</th>
                            <th>Category</th>
                            <th>Appointments</th>
                            <th>Total Revenue</th>
                            <th>Avg. Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded via AJAX -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            let isExporting = false;

            // Load initial data
            loadTreatmentStatisticsData();

            // Apply filters
            $('#applyFiltersBtn').on('click', function () {
                loadTreatmentStatisticsData();
            });

            // Export functionality
            $('.export-csv').on('click', function () {
                if (isExporting) return;

                const $btn = $(this);
                const originalText = $btn.html();

                $btn.prop('disabled', true);
                $btn.html('<i class="ti ti-loader me-1"></i>Exporting...');
                isExporting = true;

                try {
                    const params = getFilterParams();
                    const url = '@Url.Action("ExportTreatmentStatisticsCsv", "Reports")?' + $.param(params);
                    window.location.href = url;

                    setTimeout(() => {
                        $btn.prop('disabled', false);
                        $btn.html(originalText);
                        isExporting = false;
                    }, 2000);
                } catch (error) {
                    console.error('Export failed:', error);
                    $btn.prop('disabled', false);
                    $btn.html(originalText);
                    isExporting = false;
                    alert('Export failed. Please try again.');
                }
            });

            function loadTreatmentStatisticsData() {
                const params = getFilterParams();

                $.ajax({
                    url: '@Url.Action("GetTreatmentStatisticsData", "Reports")',
                    type: 'GET',
                    data: params,
                    success: function (response) {
                        if (response.data) {
                            populateTable(response.data);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error loading data:', error);
                        alert('Error loading report data');
                    }
                });
            }

            function getFilterParams() {
                return {
                    startDate: $('#startDate').val(),
                    endDate: $('#endDate').val()
                };
            }

            function populateTable(data) {
                const tbody = $('#treatmentStatsTable tbody');
                tbody.empty();

                if (data.length === 0) {
                    tbody.append('<tr><td colspan="5" class="text-center">No treatment statistics found</td></tr>');
                    return;
                }

                data.forEach(function (item) {
                    const row = `
                        <tr>
                            <td><strong>${item.treatmentName}</strong></td>
                            <td><span class="badge bg-soft-info">${item.category}</span></td>
                            <td>${item.appointmentCount}</td>
                            <td><strong class="text-success">$${item.totalRevenue.toFixed(2)}</strong></td>
                            <td>${item.averageDuration.toFixed(1)} min</td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }
        });
    </script>
}