@* @{
    ViewData["Title"] = "Treatments";
}
<form id="__af" method="post" style="display:none">
    @Html.AntiForgeryToken()
</form>
<div class="main-wrapper">
    <div class="page-wrapper m-0">
        <div class="content">
            <!-- Header -->
            <div class="d-flex align-items-sm-center flex-sm-row flex-column gap-2 mb-3">
                <div class="flex-grow-1">
                    <h4 class="fw-bold mb-0">Treatments</h4>
                </div>
                <div class="text-end">
                    <a asp-controller="Treatment" asp-action="Upsert" class="btn btn-primary ms-2 fs-13 btn-md">
                        <i class="ti ti-plus me-1"></i>New Treatment
                    </a>
                </div>
            </div>
            <!-- Card -->
            <div class="card">
                <div class="card-body">
                    <!-- External controls -->
                    <div class="row g-2 mb-3 align-items-center">
                        <div class="col-auto d-none d-sm-flex align-items-center">
                            <label class="me-2 mb-0">Show</label>
                            <select id="pageLength" class="form-select form-select-sm" style="min-width:90px">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span class="ms-2">entries</span>
                        </div>
                        <div class="col-12 col-sm ms-sm-auto" style="max-width:260px">
                            <input id="globalSearch" type="search" class="form-control form-control-sm" placeholder="Search" />
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="treatmentList" class="table table-hover align-middle w-100 nowrap" style="min-width: 900px;">
                            <thead class="table-light">
                                <tr>
                                    <th>Treatment Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Duration</th>
                                    <th>Created</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <!-- Footer -->
                    <div class="row align-items-center g-2 mt-2">
                        <div class="col-12 col-sm-6">
                            <div class="small text-muted" id="dt-info"></div>
                        </div>
                        <div class="col-12 col-sm-6 d-flex justify-content-sm-end">
                            <div id="dt-pager"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    #treatmentList thead th,
    #treatmentList tbody td {
        white-space: nowrap !important;
    }

    .truncate-180, .truncate-220 {
        display: inline-block;
        vertical-align: middle;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .truncate-180 {
        max-width: 180px;
    }

    .truncate-220 {
        max-width: 220px;
    }

    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    #treatmentList {
        min-width: 900px;
    }
</style>
@section Scripts {
    <script>
        $(function () {
          const token = $('#__af input[name="__RequestVerificationToken"]').val();
          if ($.fn.DataTable.isDataTable('#treatmentList')) {
            $('#treatmentList').DataTable().destroy();
          }
          const esc = s => s == null ? '' : String(s);
          const table = $('#treatmentList').DataTable({
            processing: true,
            serverSide: true,
            ajax: { url: '@Url.Action("GetTreatmentList", "Treatment")', type: 'GET' },
            dom: 'rtip',
            paging: true,
            pagingType: 'simple_numbers',
            info: true,
            order: [[4, 'desc']],
            autoWidth: false,
            responsive: true,
            columnDefs: [
              { targets: 0, responsivePriority: 1 },
              { targets: 6, responsivePriority: 2, className: 'text-center' }
            ],
            columns: [
              {
                data: null,
                orderable: true,
                render: row => `
                  <div class="d-flex align-items-center gap-2" style="flex-wrap: nowrap;">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center"
                         style="width:40px;height:40px;min-width:40px;">
                      <i class="ti ti-medical-cross text-white"></i>
                    </div>
                    <div style="min-width: 150px;">
                      <span class="fw-semibold">${esc(row.name)}</span><br>
                      <small class="text-muted truncate-220" title="${esc(row.description)}">${esc(row.description) || 'No description'}</small>
                    </div>
                  </div>`
              },
              {
                data: 'category',
                orderable: true,
                render: d => `<span class="badge bg-light text-dark">${esc(d) || 'General'}</span>`
              },
              {
                data: 'price',
                orderable: true,
                render: d => `<span class="fw-semibold text-success">$${parseFloat(d).toFixed(2)}</span>`
              },
              {
                data: 'durationMinutes',
                orderable: true,
                render: d => `<span>${esc(d)} min</span>`
              },
              {
                data: 'createdAt',
                orderable: true,
                render: d => new Date(d).toLocaleDateString('en-GB', {
                  day: '2-digit', month: 'short', year: 'numeric'
                })
              },
              {
                data: 'isActive',
                orderable: false,
                className: 'text-center',
                render: d => d ?
                  '<span class="badge bg-success">Active</span>' :
                  '<span class="badge bg-secondary">Inactive</span>'
              },
              {
                data: null,
                orderable: false,
                className: 'text-center',
                render: function (_d,_t,row) {
                  return `
                    <div class="dropdown d-inline-block">
                      <a href="javascript:void(0);" class="shadow-sm fs-14 d-inline-flex
                         border rounded-2 p-1" data-bs-toggle="dropdown">
                        <i class="ti ti-dots-vertical"></i>
                      </a>
                      <ul class="dropdown-menu p-2 dropdown-menu-end">
                        <li>
                          <a href="/Treatment/Upsert/${row.id}"
                             class="dropdown-item d-flex align-items-center">
                            <i class="ti ti-edit me-2"></i> Edit
                          </a>
                        </li>
                        <li>
                          <a href="javascript:void(0);"
                             class="dropdown-item d-flex align-items-center js-delete delete-btn-treatment"
                             data-url="/Treatment/Delete"
                             data-table="TreatmentList"
                             data-id="${row.id}"
                             data-name="${esc(row.name)}">
                            <i class="ti ti-trash me-2"></i> Delete
                          </a>
                        </li>
                      </ul>
                    </div>`;
                }
              }
            ],
            drawCallback() {
              const api = this.api();
              const pagerEl = $(api.table().container()).find('.dataTables_paginate');
              if (pagerEl.length) $('#dt-pager').empty().append(pagerEl);
              $('#dt-pager .paginate_button.previous .page-link').html('&lsaquo;');
              $('#dt-pager .paginate_button.next .page-link').html('&rsaquo;');
              const info = api.page.info();
              const msg = info.recordsDisplay
                ? `Showing ${info.start+1} to ${info.end} of ${info.recordsDisplay.toLocaleString()} entries`
                : (info.recordsTotal
                    ? `Showing 0 to 0 of ${info.recordsTotal.toLocaleString()} entries`
                    : 'No entries to show');
              $('#dt-info').text(msg);
            },
            language: { emptyTable: "No treatments found", processing: "Loading..." }
          });
          $('#globalSearch').on('input', () => table.search($('#globalSearch').val()).draw());
          $('#pageLength').on('change', function () {
            table.page.len(parseInt(this.value,10)).draw();
          });
          // Delete handler (SweetAlert2)
          $(document).on('click', '.js-delete', function () {
            const id   = $(this).data('id');
            const name = $(this).data('name');
            Swal.fire({
              title: `Delete ${name}?`,
              text: 'You will not be able to revert this!',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#d33',
              cancelButtonColor: '#aaa',
              confirmButtonText: 'Yes, delete!'
            }).then(res => {
              if (!res.isConfirmed) return;
              $.ajax({
                url: `/Treatment/Delete/${id}`,
                type: 'POST',
                headers: { 'RequestVerificationToken': token },
                success: r => {
                  if (r.status) {
                    Swal.fire('Deleted', r.message, 'success');
                    table.ajax.reload(null,false);
                  } else {
                    Swal.fire('Error', r.message || 'Delete failed', 'error');
                  }
                },
                error: () => Swal.fire('Error', 'Something went wrong', 'error')
              });
            });
          });
        });
    </script>
} *@


@{
    ViewData["Title"] = "Traitements";
}
<form id="__af" method="post" style="display:none">
    @Html.AntiForgeryToken()
</form>
<div class="main-wrapper">
    <div class="page-wrapper m-0">
        <div class="content">
            <!-- En-tête -->
            <div class="d-flex align-items-sm-center flex-sm-row flex-column gap-2 mb-3">
                <div class="flex-grow-1">
                    <h4 class="fw-bold mb-0">Traitements</h4>
                </div>
                <div class="text-end">
                    <a asp-controller="Treatment" asp-action="Upsert" class="btn btn-primary ms-2 fs-13 btn-md">
                        <i class="ti ti-plus me-1"></i>Nouveau Traitement
                    </a>
                </div>
            </div>
            <!-- Carte -->
            <div class="card">
                <div class="card-body">
                    <!-- Contrôles externes -->
                    <div class="row g-2 mb-3 align-items-center">
                        <div class="col-auto d-none d-sm-flex align-items-center">
                            <label class="me-2 mb-0">Afficher</label>
                            <select id="pageLength" class="form-select form-select-sm" style="min-width:90px">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span class="ms-2">entrées</span>
                        </div>
                        <div class="col-12 col-sm ms-sm-auto" style="max-width:260px">
                            <input id="globalSearch" type="search" class="form-control form-control-sm" placeholder="Rechercher" />
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="treatmentList" class="table table-hover align-middle w-100 nowrap" style="min-width: 900px;">
                            <thead class="table-light">
                                <tr>
                                    <th>Nom du Traitement</th>
                                    <th>Catégorie</th>
                                    <th>Prix</th>
                                    <th>Durée</th>
                                    <th>Créé le</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <!-- Pied de page -->
                    <div class="row align-items-center g-2 mt-2">
                        <div class="col-12 col-sm-6">
                            <div class="small text-muted" id="dt-info"></div>
                        </div>
                        <div class="col-12 col-sm-6 d-flex justify-content-sm-end">
                            <div id="dt-pager"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    #treatmentList thead th,
    #treatmentList tbody td {
        white-space: nowrap !important;
    }

    .truncate-180, .truncate-220 {
        display: inline-block;
        vertical-align: middle;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .truncate-180 {
        max-width: 180px;
    }

    .truncate-220 {
        max-width: 220px;
    }

    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    #treatmentList {
        min-width: 900px;
    }
</style>
@section Scripts {
    <script>
        $(function () {
          const token = $('#__af input[name="__RequestVerificationToken"]').val();
          if ($.fn.DataTable.isDataTable('#treatmentList')) {
            $('#treatmentList').DataTable().destroy();
          }
          const esc = s => s == null ? '' : String(s);
          const table = $('#treatmentList').DataTable({
            processing: true,
            serverSide: true,
            ajax: { url: '@Url.Action("GetTreatmentList", "Treatment")', type: 'GET' },
            dom: 'rtip',
            paging: true,
            pagingType: 'simple_numbers',
            info: true,
            order: [[4, 'desc']],
            autoWidth: false,
            responsive: true,
            columnDefs: [
              { targets: 0, responsivePriority: 1 },
              { targets: 6, responsivePriority: 2, className: 'text-center' }
            ],
            columns: [
              {
                data: null,
                orderable: true,
                render: row => `
                  <div class="d-flex align-items-center gap-2" style="flex-wrap: nowrap;">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center"
                         style="width:40px;height:40px;min-width:40px;">
                      <i class="ti ti-medical-cross text-white"></i>
                    </div>
                    <div style="min-width: 150px;">
                      <span class="fw-semibold">${esc(row.name)}</span><br>
                      <small class="text-muted truncate-220" title="${esc(row.description)}">${esc(row.description) || 'Aucune description'}</small>
                    </div>
                  </div>`
              },
              {
                data: 'category',
                orderable: true,
                render: d => `<span class="badge bg-light text-dark">${esc(d) || 'Général'}</span>`
              },
              {
                data: 'price',
                orderable: true,
                render: d => `<span class="fw-semibold text-success">${parseFloat(d).toFixed(2)} €</span>`
              },
              {
                data: 'durationMinutes',
                orderable: true,
                render: d => `<span>${esc(d)} min</span>`
              },
              {
                data: 'createdAt',
                orderable: true,
                render: d => new Date(d).toLocaleDateString('fr-FR', {
                  day: '2-digit', month: 'short', year: 'numeric'
                })
              },
              {
                data: 'isActive',
                orderable: false,
                className: 'text-center',
                render: d => d ?
                  '<span class="badge bg-success">Actif</span>' :
                  '<span class="badge bg-secondary">Inactif</span>'
              },
              {
                data: null,
                orderable: false,
                className: 'text-center',
                render: function (_d,_t,row) {
                  return `
                    <div class="dropdown d-inline-block">
                      <a href="javascript:void(0);" class="shadow-sm fs-14 d-inline-flex
                         border rounded-2 p-1" data-bs-toggle="dropdown">
                        <i class="ti ti-dots-vertical"></i>
                      </a>
                      <ul class="dropdown-menu p-2 dropdown-menu-end">
                        <li>
                          <a href="/Treatment/Upsert/${row.id}"
                             class="dropdown-item d-flex align-items-center">
                            <i class="ti ti-edit me-2"></i> Modifier
                          </a>
                        </li>
                        <li>
                          <a href="javascript:void(0);"
                             class="dropdown-item d-flex align-items-center js-delete delete-btn-treatment"
                             data-url="/Treatment/Delete"
                             data-table="TreatmentList"
                             data-id="${row.id}"
                             data-name="${esc(row.name)}">
                            <i class="ti ti-trash me-2"></i> Supprimer
                          </a>
                        </li>
                      </ul>
                    </div>`;
                }
              }
            ],
            drawCallback() {
              const api = this.api();
              const pagerEl = $(api.table().container()).find('.dataTables_paginate');
              if (pagerEl.length) $('#dt-pager').empty().append(pagerEl);
              $('#dt-pager .paginate_button.previous .page-link').html('&lsaquo;');
              $('#dt-pager .paginate_button.next .page-link').html('&rsaquo;');
              const info = api.page.info();
              const msg = info.recordsDisplay
                ? `Affichage de ${info.start+1} à ${info.end} sur ${info.recordsDisplay.toLocaleString()} entrées`
                : (info.recordsTotal
                    ? `Affichage de 0 à 0 sur ${info.recordsTotal.toLocaleString()} entrées`
                    : 'Aucune entrée à afficher');
              $('#dt-info').text(msg);
            },
            language: { emptyTable: "Aucun traitement trouvé", processing: "Chargement..." }
          });
          $('#globalSearch').on('input', () => table.search($('#globalSearch').val()).draw());
          $('#pageLength').on('change', function () {
            table.page.len(parseInt(this.value,10)).draw();
          });
          // Gestionnaire de suppression (SweetAlert2)
          $(document).on('click', '.js-delete', function () {
            const id   = $(this).data('id');
            const name = $(this).data('name');
            Swal.fire({
              title: `Supprimer ${name} ?`,
              text: 'Vous ne pourrez pas annuler cette action !',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#d33',
              cancelButtonColor: '#aaa',
              confirmButtonText: 'Oui, supprimer !',
              cancelButtonText: 'Annuler'
            }).then(res => {
              if (!res.isConfirmed) return;
              $.ajax({
                url: `/Treatment/Delete/${id}`,
                type: 'POST',
                headers: { 'RequestVerificationToken': token },
                success: r => {
                  if (r.status) {
                    Swal.fire('Supprimé', r.message, 'success');
                    table.ajax.reload(null,false);
                  } else {
                    Swal.fire('Erreur', r.message || 'Échec de la suppression', 'error');
                  }
                },
                error: () => Swal.fire('Erreur', 'Une erreur est survenue', 'error')
              });
            });
          });
        });
    </script>
}