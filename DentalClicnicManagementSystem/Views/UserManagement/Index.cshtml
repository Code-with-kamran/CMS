@{
    ViewData["Title"] = "User Management";
}
<form id="__af" method="post" style="display:none">@Html.AntiForgeryToken()</form>

<div class="content">
    <!-- Header -->
    <div class="d-flex align-items-sm-center flex-sm-row flex-column gap-2 mb-3">
        <div class="flex-grow-1">
            <h4 class="fw-bold mb-0">Users</h4>
        </div>
        <div class="text-end">
            <button id="btn-add-user" class="btn btn-primary ms-2 fs-13 btn-md">
                <i class="ti ti-plus me-1"></i>New User
            </button>
        </div>
    </div>
    <!-- Card -->
    <div class="card">
        <div class="card-body">

            <!-- FIX: This is the single, correct block for external controls, matching your patient list -->
            <div class="row g-2 mb-3 align-items-center">
                <div class="col-auto d-none d-sm-flex align-items-center">
                    <label class="me-2 mb-0">Show</label>
                    <select id="pageLength" class="form-select form-select-sm" style="min-width:90px">
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span class="ms-2">entries</span>
                </div>
                <div class="col-12 col-sm ms-sm-auto" style="max-width:260px">
                    <input id="globalSearch" type="search" class="form-control form-control-sm" placeholder="Search by name or email" />
                </div>
            </div>

            <div class="table-responsive">
                <table id="userList" class="table table-hover w-100">
                    <thead class="table-light">
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created On</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Footer for pagination and info, matching your patient list -->
            <div class="row align-items-center g-2 mt-2">
                <div class="col-12 col-sm-6">
                    <div class="small text-muted" id="dt-info"></div>
                </div>
                <div class="col-12 col-sm-6 d-flex justify-content-sm-end">
                    <div id="dt-pager"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Placeholder -->
<div class="modal fade" id="user-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" id="user-modal-content">
            <!-- Content will be loaded via AJAX -->
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>

    <script>
        $(function () {
            const token = $('#__af input[name="__RequestVerificationToken"]').val();
            const userModal = new bootstrap.Modal(document.getElementById('user-modal'));

            const table = $('#userList').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: '@Url.Action("GetUserList")',
                    type: 'GET'
                },
                // Use the exact 'dom' and 'pagingType' from your working patient list
                dom: 'rtip',
                paging: true,
                pagingType: 'simple_numbers',
                info: true,
                order: [[4, 'desc']],
                columns: [
                    { data: 'fullName', name: 'FullName' },
                    { data: 'email', name: 'Email' },
                    { data: 'role', name: 'Role' },
                    {
                        data: 'isActive', name: 'IsActive', orderable: false,
                            render: (data) => {
            // Check if the status is active
            if (data) {
                return `<span class="badge rounded-3 border text-success" style="border: 2px solid green;">Active</span>`;
            } else {
                return `<span class="badge rounded-3 border text-danger" style="border: 2px solid red;">Deactivated</span>`;
            }
        }
                    },
                    {
                        data: 'createdAt', name: 'CreatedAt',
                        render: d => new Date(d).toLocaleDateString('en-GB')
                    },
                    {
                        data: null, orderable: false, className: 'text-center',
                        render: (data, type, row) => `
                            <div class="dropdown d-inline-block">
                                <a href="#" class="shadow-sm fs-14 d-inline-flex border rounded-2 p-1" data-bs-toggle="dropdown"><i class="ti ti-dots-vertical"></i></a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item js-edit" data-id="${row.id}" href="#"><i class="ti ti-edit me-2"></i>Edit</a></li>
                                    <li><a class="dropdown-item js-toggle-status" data-id="${row.id}" href="#"><i class="ti ti-lock me-2"></i>Toggle Status</a></li>
                                    <li><a class="dropdown-item js-delete" data-id="${row.id}" data-name="${row.fullName}" href="#"><i class="ti ti-trash me-2"></i>Delete</a></li>
                                </ul>
                            </div>`
                    }
                ],
                // Use the exact drawCallback from your working patient list
                drawCallback: function() {
                    const api = this.api();
                    const pagerEl = $(api.table().container()).find('.dataTables_paginate');
                    if (pagerEl.length) $('#dt-pager').empty().append(pagerEl);

                    $('#dt-pager .paginate_button.previous .page-link').html('&lsaquo;');
                    $('#dt-pager .paginate_button.next .page-link').html('&rsaquo;');

                    const info = api.page.info();
                    const msg = info.recordsDisplay
                        ? `Showing ${info.start + 1} to ${info.end} of ${info.recordsDisplay.toLocaleString()} entries`
                        : (info.recordsTotal
                            ? `Showing 0 to 0 of ${info.recordsTotal.toLocaleString()} entries`
                            : 'No entries to show');
                    $('#dt-info').text(msg);
                },
                language: { emptyTable: "No users found", processing: "Loading..." }
            });

            // Add the event handlers for the external controls
            $('#globalSearch').on('input', () => table.search($('#globalSearch').val()).draw());
            $('#pageLength').on('change', function () {
                table.page.len(parseInt(this.value, 10)).draw();
            });

            // --- The rest of your event handlers are correct ---
            $('#btn-add-user').on('click', function () {
                $('#user-modal-content').load('@Url.Action("Upsert")', () => userModal.show());
            });

            $('#userList').on('click', '.js-edit', function () {
                const id = $(this).data('id');
                $('#user-modal-content').load(`@Url.Action("Upsert")/${id}`, () => userModal.show());
            });

            $(document).on('submit', '#user-upsert-form', function (e) {
                e.preventDefault();
                const form = $(this);
                if (!form.valid()) { return; }
                $.ajax({
                    url: form.attr('action'), type: 'POST', data: form.serialize(),
                    headers: { 'RequestVerificationToken': token },
                    success: function (res) {
                        if (res.success) {
                            userModal.hide();
                            Swal.fire('Success!', res.message, 'success');
                            table.ajax.reload(null, false);
                        } else { Swal.fire('Error!', res.message, 'error'); }
                    },
                    error: () => Swal.fire('Error!', 'Something went wrong.', 'error')
                });
            });

            $('#userList').on('click', '.js-delete', function () {
                const id = $(this).data('id');
                const name = $(this).data('name');
                Swal.fire({
                    title: `Delete ${name}?`, text: "This action cannot be undone.", icon: 'warning',
                    showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.post('@Url.Action("Delete")/' + id, { '__RequestVerificationToken': token }, res => {
                            if (res.success) {
                                Swal.fire('Deleted!', res.message, 'success');
                                table.ajax.reload(null, false);
                            } else { Swal.fire('Error!', res.message, 'error'); }
                        });
                    }
                });
            });

            $('#userList').on('click', '.js-toggle-status', function () {
                const id = $(this).data('id');
                $.post('@Url.Action("ToggleStatus")/' + id, { '__RequestVerificationToken': token }, res => {
                    if (res.success) {
                        Swal.fire('Updated!', res.message, 'success');
                        table.ajax.reload(null, false);
                    } else { Swal.fire('Error!', 'Could not update status.', 'error'); }
                });
            });
        });
    </script>
}
